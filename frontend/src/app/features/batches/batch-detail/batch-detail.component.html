<app-header></app-header>

<div class="container">
  <div class="page-header">
    <button class="btn btn-secondary" (click)="goBack()">‚Üê Back to Batches</button>
  </div>

  <div *ngIf="loading" class="text-center">
    <app-loading-spinner message="Loading batch details..."></app-loading-spinner>
  </div>

  <div *ngIf="!loading && batch">
    <!-- Success/Error Messages -->
    <div *ngIf="success" class="alert alert-success">{{ success }}</div>
    <div *ngIf="error" class="alert alert-error">{{ error }}</div>

    <!-- Batch Info -->
    <div class="card">
      <div class="card-header">
        Batch Information
        <div class="header-actions" *ngIf="batch.status === 'AVAILABLE'">
          <button class="btn btn-secondary btn-sm" (click)="openSplitModal()">Split Batch</button>
          <button class="btn btn-secondary btn-sm" (click)="openMergeModal()">Merge Batches</button>
        </div>
      </div>
      <div class="batch-info-grid">
        <div class="info-item">
          <span class="info-label">Batch Number</span>
          <span class="info-value batch-number">{{ batch.batchNumber }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Material ID</span>
          <span class="info-value">{{ batch.materialId }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Quantity</span>
          <span class="info-value">{{ batch.quantity }} {{ batch.unit || batch.unitOfMeasure }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Status</span>
          <app-status-badge [status]="batch.status || batch.state"></app-status-badge>
        </div>
        <div class="info-item">
          <span class="info-label">Created</span>
          <span class="info-value">{{ batch.createdOn || batch.createdAt | date:'medium' }}</span>
        </div>
        <div class="info-item" *ngIf="batch.expiryDate">
          <span class="info-label">Expiry Date</span>
          <span class="info-value">{{ batch.expiryDate | date:'mediumDate' }}</span>
        </div>
      </div>
    </div>

    <!-- Genealogy -->
    <div class="card">
      <div class="card-header">Batch Genealogy (Traceability)</div>

      <div *ngIf="loadingGenealogy" class="text-center">
        <app-loading-spinner message="Loading genealogy..."></app-loading-spinner>
      </div>

      <div *ngIf="!loadingGenealogy && genealogy" class="genealogy-container">
        <!-- Parent Batches (Source Materials) -->
        <div class="genealogy-section" *ngIf="genealogy.parentBatches?.length > 0">
          <h4>Source Materials (Parent Batches)</h4>
          <p class="section-description">Materials that were consumed to create this batch</p>

          <div class="batch-tree">
            <div class="tree-node parent-node" *ngFor="let parent of genealogy.parentBatches">
              <div class="node-connector up"></div>
              <div class="node-card" (click)="navigateToBatch(parent.batchId)">
                <div class="node-header">
                  <span class="node-batch">{{ parent.batchNumber }}</span>
                  <app-status-badge [status]="parent.state"></app-status-badge>
                </div>
                <div class="node-details">
                  <span>Material: {{ parent.materialId }}</span>
                  <span>Consumed: {{ parent.quantityUsed }} {{ parent.unitOfMeasure }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Current Batch -->
        <div class="current-batch-section">
          <div class="current-batch-node">
            <div class="node-card current">
              <div class="node-header">
                <span class="node-batch">{{ batch.batchNumber }}</span>
                <app-status-badge [status]="batch.state"></app-status-badge>
              </div>
              <div class="node-details">
                <span>Material: {{ batch.materialId }}</span>
                <span>Quantity: {{ batch.quantity }} {{ batch.unitOfMeasure }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Child Batches (Derived Products) -->
        <div class="genealogy-section" *ngIf="genealogy.childBatches?.length > 0">
          <h4>Derived Products (Child Batches)</h4>
          <p class="section-description">Batches that were created using this batch as source material</p>

          <div class="batch-tree">
            <div class="tree-node child-node" *ngFor="let child of genealogy.childBatches">
              <div class="node-connector down"></div>
              <div class="node-card" (click)="navigateToBatch(child.batchId)">
                <div class="node-header">
                  <span class="node-batch">{{ child.batchNumber }}</span>
                  <app-status-badge [status]="child.state"></app-status-badge>
                </div>
                <div class="node-details">
                  <span>Material: {{ child.materialId }}</span>
                  <span>Quantity: {{ child.quantity }} {{ child.unitOfMeasure }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- No Relations -->
        <div *ngIf="!genealogy.parentBatches?.length && !genealogy.childBatches?.length" class="no-relations">
          <p>This batch has no parent or child relationships.</p>
          <p class="hint">Relationships are created when materials are consumed during production confirmation.</p>
        </div>
      </div>
    </div>

    <!-- Batch Allocations (GAP-001: Multi-Order Batch Confirmation) -->
    <div class="card">
      <div class="card-header">
        Order Allocations
        <div class="header-actions" *ngIf="batch.status === 'AVAILABLE' && batchAvailability && !batchAvailability.fullyAllocated">
          <button class="btn btn-primary btn-sm" (click)="openAllocationModal()">+ Allocate to Order</button>
        </div>
      </div>

      <div *ngIf="loadingAllocations" class="text-center">
        <app-loading-spinner message="Loading allocations..."></app-loading-spinner>
      </div>

      <div *ngIf="!loadingAllocations">
        <!-- Availability Summary -->
        <div class="allocation-summary" *ngIf="batchAvailability">
          <div class="summary-item">
            <span class="label">Total Quantity:</span>
            <span class="value">{{ batchAvailability.totalQuantity }} {{ batch.unit }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Allocated:</span>
            <span class="value allocated">{{ batchAvailability.allocatedQuantity }} {{ batch.unit }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Available:</span>
            <span class="value available">{{ batchAvailability.availableQuantity }} {{ batch.unit }}</span>
          </div>
          <div class="summary-item" *ngIf="batchAvailability.fullyAllocated">
            <span class="badge badge-info">Fully Allocated</span>
          </div>
        </div>

        <!-- Active Allocations -->
        <div class="allocations-section" *ngIf="getActiveAllocations().length > 0">
          <h4>Active Allocations</h4>
          <table class="data-table">
            <thead>
              <tr>
                <th>Order</th>
                <th>Product</th>
                <th>Quantity</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let alloc of getActiveAllocations()">
                <td>Order #{{ alloc.orderId }}</td>
                <td>{{ alloc.productSku }} - {{ alloc.productName }}</td>
                <td>{{ alloc.allocatedQty }} {{ alloc.unit }}</td>
                <td>{{ alloc.timestamp | date:'short' }}</td>
                <td>
                  <button class="btn btn-secondary btn-sm" (click)="releaseAllocation(alloc.allocationId)">
                    Release
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Released Allocations -->
        <div class="allocations-section" *ngIf="getReleasedAllocations().length > 0">
          <h4>Released Allocations (History)</h4>
          <table class="data-table">
            <thead>
              <tr>
                <th>Order</th>
                <th>Product</th>
                <th>Quantity</th>
                <th>Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let alloc of getReleasedAllocations()">
                <td>Order #{{ alloc.orderId }}</td>
                <td>{{ alloc.productSku }} - {{ alloc.productName }}</td>
                <td>{{ alloc.allocatedQty }} {{ alloc.unit }}</td>
                <td>{{ alloc.timestamp | date:'short' }}</td>
                <td><span class="badge badge-secondary">Released</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- No Allocations -->
        <div *ngIf="allocations.length === 0" class="no-allocations">
          <p>No allocations for this batch.</p>
          <p class="hint">Allocate this batch to fulfill customer orders.</p>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!loading && !batch" class="card">
    <p class="no-data">Batch not found</p>
  </div>
</div>

<!-- Split Modal -->
<div class="modal-overlay" *ngIf="showSplitModal" (click)="closeSplitModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Split Batch</h3>
      <button class="close-btn" (click)="closeSplitModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="split-info">
        <p><strong>Source Batch:</strong> {{ batch?.batchNumber }}</p>
        <p><strong>Available Quantity:</strong> {{ batch?.quantity }} {{ batch?.unit }}</p>
      </div>

      <div class="split-portions">
        <h4>Split Portions</h4>
        <div class="portion-row" *ngFor="let portion of splitPortions; let i = index">
          <div class="form-group">
            <label>Quantity</label>
            <input type="number" [(ngModel)]="portion.quantity" min="0" [max]="batch?.quantity">
          </div>
          <div class="form-group">
            <label>Suffix</label>
            <input type="text" [(ngModel)]="portion.suffix" maxlength="5">
          </div>
          <button class="btn btn-icon" (click)="removeSplitPortion(i)" *ngIf="splitPortions.length > 1">
            &times;
          </button>
        </div>
        <button class="btn btn-secondary btn-sm" (click)="addSplitPortion()">+ Add Portion</button>
      </div>

      <div class="split-summary">
        <p>
          <strong>Total Split:</strong> {{ getTotalSplitQuantity() }} {{ batch?.unit }}
          <span *ngIf="getTotalSplitQuantity() > batch?.quantity" class="text-danger">
            (Exceeds available)
          </span>
        </p>
        <p><strong>Remaining:</strong> {{ batch?.quantity - getTotalSplitQuantity() }} {{ batch?.unit }}</p>
      </div>

      <div class="form-group">
        <label>Reason (optional)</label>
        <textarea [(ngModel)]="splitReason" rows="2"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeSplitModal()">Cancel</button>
      <button class="btn btn-primary" (click)="submitSplit()" [disabled]="!canSplit() || submitting">
        {{ submitting ? 'Splitting...' : 'Split Batch' }}
      </button>
    </div>
  </div>
</div>

<!-- Merge Modal -->
<div class="modal-overlay" *ngIf="showMergeModal" (click)="closeMergeModal()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Merge Batches</h3>
      <button class="close-btn" (click)="closeMergeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="merge-info">
        <p><strong>Current Batch:</strong> {{ batch?.batchNumber }} ({{ batch?.quantity }} {{ batch?.unit }})</p>
        <p><strong>Material:</strong> {{ batch?.materialId }} - {{ batch?.materialName }}</p>
      </div>

      <div class="merge-selection">
        <h4>Select batches to merge with:</h4>
        <div *ngIf="availableBatchesForMerge.length === 0" class="no-data">
          No other available batches with the same material found.
        </div>
        <div class="batch-selection-list" *ngIf="availableBatchesForMerge.length > 0">
          <div class="batch-selection-item" *ngFor="let b of availableBatchesForMerge"
               [class.selected]="isBatchSelectedForMerge(b)"
               (click)="toggleBatchForMerge(b)">
            <input type="checkbox" [checked]="isBatchSelectedForMerge(b)">
            <div class="batch-item-info">
              <span class="batch-number">{{ b.batchNumber }}</span>
              <span class="batch-qty">{{ b.quantity }} {{ b.unit }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="merge-summary" *ngIf="mergeSelectedBatches.length > 0">
        <h4>Merge Summary</h4>
        <p><strong>Batches to merge:</strong> {{ mergeSelectedBatches.length + 1 }}</p>
        <p><strong>Total Quantity:</strong> {{ getTotalMergeQuantity() }} {{ batch?.unit }}</p>
      </div>

      <div class="form-group">
        <label>Target Batch Number (optional, auto-generated if empty)</label>
        <input type="text" [(ngModel)]="mergeTargetBatchNumber" placeholder="e.g., MRG-2024-001">
      </div>

      <div class="form-group">
        <label>Reason (optional)</label>
        <textarea [(ngModel)]="mergeReason" rows="2"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeMergeModal()">Cancel</button>
      <button class="btn btn-primary" (click)="submitMerge()" [disabled]="!canMerge() || submitting">
        {{ submitting ? 'Merging...' : 'Merge Batches' }}
      </button>
    </div>
  </div>
</div>

<!-- Allocation Modal (GAP-001: Multi-Order Batch Confirmation) -->
<div class="modal-overlay" *ngIf="showAllocationModal" (click)="closeAllocationModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Allocate Batch to Order</h3>
      <button class="close-btn" (click)="closeAllocationModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="allocation-info">
        <p><strong>Batch:</strong> {{ batch?.batchNumber }}</p>
        <p><strong>Material:</strong> {{ batch?.materialId }} - {{ batch?.materialName }}</p>
        <p><strong>Available Quantity:</strong> {{ batchAvailability?.availableQuantity }} {{ batch?.unit }}</p>
      </div>

      <div class="form-group">
        <label>Select Order Line *</label>
        <select [(ngModel)]="allocationOrderLineId" class="form-control">
          <option [ngValue]="null">-- Select an order line --</option>
          <option *ngFor="let line of availableOrderLines" [ngValue]="line.orderLineId">
            Order {{ line.orderNumber }} - {{ line.productSku }} ({{ line.productName }}) - {{ line.orderedQty }} {{ line.unit }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>Allocation Quantity *</label>
        <input type="number"
               [(ngModel)]="allocationQuantity"
               [max]="batchAvailability?.availableQuantity || 0"
               min="0.01"
               step="0.01"
               class="form-control">
        <small class="form-text text-muted">
          Max: {{ batchAvailability?.availableQuantity }} {{ batch?.unit }}
        </small>
      </div>

      <div *ngIf="error" class="alert alert-error">{{ error }}</div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeAllocationModal()">Cancel</button>
      <button class="btn btn-primary" (click)="submitAllocation()" [disabled]="!canAllocate() || submitting">
        {{ submitting ? 'Allocating...' : 'Allocate' }}
      </button>
    </div>
  </div>
</div>
