<div class="container">
  <div class="page-header">
    <button class="btn btn-secondary" (click)="goBack()"><i class="fas fa-arrow-left"></i> Back to Batches</button>
  </div>

  <div *ngIf="loading" class="text-center">
    <app-loading-spinner message="Loading batch details..."></app-loading-spinner>
  </div>

  <div *ngIf="!loading && batch">
    <!-- Success/Error Messages -->
    <div *ngIf="success" class="alert alert-success">{{ success }}</div>
    <div *ngIf="error" class="alert alert-error">{{ error }}</div>

    <!-- Batch Info -->
    <div class="card">
      <div class="card-header">
        Batch Information
        <div class="header-actions" *ngIf="canShowSplitMerge()">
          <button class="btn btn-secondary btn-sm" (click)="toggleSplitSection()"
                  [class.active]="showSplitSection">
            <i class="fas fa-code-branch"></i> Split Batch
          </button>
          <button class="btn btn-secondary btn-sm" (click)="toggleMergeSection()"
                  [class.active]="showMergeSection">
            <i class="fas fa-code-merge"></i> Merge Batches
          </button>
        </div>
      </div>
      <div class="batch-info-grid">
        <div class="info-item">
          <span class="info-label">Batch Number</span>
          <span class="info-value batch-number">{{ batch.batchNumber }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Material ID</span>
          <span class="info-value">{{ batch.materialId }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Quantity</span>
          <span class="info-value">{{ batch.quantity }} {{ batch.unit }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Status</span>
          <app-status-badge [status]="batch.status || batch.state"></app-status-badge>
        </div>
        <div class="info-item">
          <span class="info-label">Created</span>
          <span class="info-value">{{ batch.createdOn || batch.createdAt | date:'medium' }}</span>
        </div>
        <div class="info-item" *ngIf="batch.expiryDate">
          <span class="info-label">Expiry Date</span>
          <span class="info-value">{{ batch.expiryDate | date:'mediumDate' }}</span>
        </div>
      </div>
    </div>

    <!-- R-06: Inline Split Section -->
    <div class="card split-merge-card" *ngIf="showSplitSection">
      <div class="card-header">
        <i class="fas fa-code-branch"></i> Split Batch
        <button class="btn btn-icon btn-sm" (click)="closeSplitSection()">
          <i class="fas fa-xmark"></i>
        </button>
      </div>
      <div class="split-merge-body">
        <!-- Split Result (shown after successful split) -->
        <div *ngIf="splitResult" class="split-merge-result">
          <div class="result-header success">
            <i class="fas fa-circle-check"></i>
            Batch split into {{ splitResult.newBatches?.length }} new batches
          </div>
          <div class="result-details">
            <p><strong>Original Quantity:</strong> {{ splitResult.originalQuantity }} {{ batch?.unit }}</p>
            <p><strong>Remaining:</strong> {{ splitResult.remainingQuantity }} {{ batch?.unit }}</p>
          </div>
          <div class="result-batches">
            <h4>New Batches</h4>
            <div class="result-batch-item" *ngFor="let newBatch of splitResult.newBatches">
              <span class="result-batch-number">{{ newBatch.batchNumber }}</span>
              <span class="result-batch-qty">{{ newBatch.quantity }} {{ newBatch.unit }}</span>
              <button class="btn btn-link btn-sm" (click)="navigateToSplitBatch(newBatch.batchId)">
                View <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
          <div class="result-actions">
            <button class="btn btn-secondary btn-sm" (click)="closeSplitSection()">Close</button>
          </div>
        </div>

        <!-- Split Form (shown before split) -->
        <div *ngIf="!splitResult">
          <div class="split-info">
            <p><strong>Source Batch:</strong> {{ batch?.batchNumber }}</p>
            <p><strong>Available Quantity:</strong> {{ batch?.quantity }} {{ batch?.unit }}</p>
          </div>

          <div class="split-portions">
            <h4>Split Portions</h4>
            <div class="portion-row" *ngFor="let portion of splitPortions; let i = index">
              <div class="form-group">
                <label>Quantity</label>
                <input type="number" [(ngModel)]="portion.quantity" min="0.01" step="0.01" [max]="batch?.quantity"
                       class="form-control">
              </div>
              <div class="form-group">
                <label>Suffix</label>
                <input type="text" [(ngModel)]="portion.suffix" maxlength="5" class="form-control">
              </div>
              <button class="btn btn-icon" (click)="removeSplitPortion(i)" *ngIf="splitPortions.length > 1"
                      title="Remove portion">
                <i class="fas fa-trash"></i>
              </button>
            </div>
            <button class="btn btn-secondary btn-sm" (click)="addSplitPortion()">
              <i class="fas fa-plus"></i> Add Portion
            </button>
          </div>

          <div class="split-summary">
            <div class="summary-row">
              <span>Total Split Quantity:</span>
              <span [class.text-danger]="getTotalSplitQuantity() > batch?.quantity">
                {{ getTotalSplitQuantity() }} {{ batch?.unit }}
              </span>
            </div>
            <div class="summary-row">
              <span>Remaining on Source:</span>
              <span [class.text-danger]="getRemainingAfterSplit() < 0">
                {{ getRemainingAfterSplit() }} {{ batch?.unit }}
              </span>
            </div>
            <div class="validation-msg text-danger" *ngIf="getTotalSplitQuantity() > batch?.quantity">
              Total split quantity exceeds available quantity.
            </div>
          </div>

          <div class="form-group">
            <label>Reason (optional)</label>
            <textarea [(ngModel)]="splitReason" rows="2" class="form-control"
                      placeholder="Reason for splitting this batch..."></textarea>
          </div>

          <div *ngIf="error" class="alert alert-error">{{ error }}</div>

          <div class="split-merge-actions">
            <button class="btn btn-secondary" (click)="closeSplitSection()">Cancel</button>
            <button class="btn btn-primary" (click)="submitSplit()" [disabled]="!canSplit() || submitting">
              {{ submitting ? 'Splitting...' : 'Confirm Split' }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- R-06: Inline Merge Section -->
    <div class="card split-merge-card" *ngIf="showMergeSection">
      <div class="card-header">
        <i class="fas fa-code-merge"></i> Merge Batches
        <button class="btn btn-icon btn-sm" (click)="closeMergeSection()">
          <i class="fas fa-xmark"></i>
        </button>
      </div>
      <div class="split-merge-body">
        <!-- Merge Result (shown after successful merge) -->
        <div *ngIf="mergeResult" class="split-merge-result">
          <div class="result-header success">
            <i class="fas fa-circle-check"></i>
            Batches merged successfully
          </div>
          <div class="result-details">
            <p><strong>Merged Batch:</strong> {{ mergeResult.mergedBatch?.batchNumber }}</p>
            <p><strong>Total Quantity:</strong> {{ mergeResult.totalQuantity }} {{ batch?.unit }}</p>
            <p><strong>Source Batches:</strong> {{ mergeResult.sourceBatches?.length }}</p>
          </div>
          <div class="result-actions">
            <button class="btn btn-secondary btn-sm" (click)="closeMergeSection()">Close</button>
            <button class="btn btn-primary btn-sm" (click)="navigateToMergedBatch()">
              View Merged Batch <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Merge Form (shown before merge) -->
        <div *ngIf="!mergeResult">
          <div class="merge-info">
            <p><strong>Current Batch:</strong> {{ batch?.batchNumber }} ({{ batch?.quantity }} {{ batch?.unit }})</p>
            <p><strong>Material:</strong> {{ batch?.materialId }} - {{ batch?.materialName }}</p>
          </div>

          <!-- Batch ID text input for quick merge -->
          <div class="form-group">
            <label>Enter Batch IDs to merge with (comma-separated)</label>
            <input type="text" [(ngModel)]="mergeBatchIdsInput" class="form-control"
                   placeholder="e.g., 5, 12, 23">
            <small class="form-text text-muted">
              Enter the numeric IDs of batches to merge with this one.
            </small>
          </div>

          <!-- Available batches selection list -->
          <div class="merge-selection" *ngIf="availableBatchesForMerge.length > 0">
            <h4>Or select from available batches (same material):</h4>
            <div class="batch-selection-list">
              <div class="batch-selection-item" *ngFor="let b of availableBatchesForMerge"
                   [class.selected]="isBatchSelectedForMerge(b)"
                   (click)="toggleBatchForMerge(b)">
                <input type="checkbox" [checked]="isBatchSelectedForMerge(b)">
                <div class="batch-item-info">
                  <span class="batch-number">{{ b.batchNumber }}</span>
                  <span class="batch-id-label">(ID: {{ b.batchId }})</span>
                  <span class="batch-qty">{{ b.quantity }} {{ b.unit }}</span>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="availableBatchesForMerge.length === 0" class="no-merge-batches">
            No other available batches with the same material found. Use the ID input above to merge with specific batches.
          </div>

          <div class="merge-summary" *ngIf="mergeSelectedBatches.length > 0">
            <h4>Merge Summary</h4>
            <p><strong>Batches to merge:</strong> {{ mergeSelectedBatches.length + 1 }}</p>
            <p><strong>Total Quantity:</strong> {{ getTotalMergeQuantity() }} {{ batch?.unit }}</p>
          </div>

          <div class="form-group">
            <label>Target Batch Number (optional, auto-generated if empty)</label>
            <input type="text" [(ngModel)]="mergeTargetBatchNumber" class="form-control"
                   placeholder="e.g., MRG-2026-001">
          </div>

          <div class="form-group">
            <label>Reason (optional)</label>
            <textarea [(ngModel)]="mergeReason" rows="2" class="form-control"
                      placeholder="Reason for merging these batches..."></textarea>
          </div>

          <div *ngIf="error" class="alert alert-error">{{ error }}</div>

          <div class="split-merge-actions">
            <button class="btn btn-secondary" (click)="closeMergeSection()">Cancel</button>
            <button class="btn btn-primary" (click)="submitMerge()" [disabled]="!canMerge() || submitting">
              {{ submitting ? 'Merging...' : 'Confirm Merge' }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- GAP-020: Traceability Information -->
    <div class="card" *ngIf="batch.createdVia || batch.generatedAtOperationId || hasSupplierInfo()">
      <div class="card-header">
        <i class="fas fa-route"></i> Traceability Information
      </div>
      <div class="traceability-content">
        <!-- Creation Source -->
        <div class="traceability-section">
          <h4>Creation Source</h4>
          <div class="traceability-grid">
            <div class="info-item" *ngIf="batch.createdVia">
              <span class="info-label">Created Via</span>
              <span class="created-via-badge" [ngClass]="getCreatedViaClass()">
                <i class="fas" [ngClass]="getCreatedViaIcon()"></i>
                {{ getCreatedViaLabel() }}
              </span>
            </div>
            <div class="info-item" *ngIf="batch.generatedAtOperationId">
              <span class="info-label">Source Operation</span>
              <span class="info-value">
                <a class="link-operation" (click)="navigateToOperation(batch.generatedAtOperationId)">
                  Operation #{{ batch.generatedAtOperationId }}
                  <i class="fas fa-external-link-alt"></i>
                </a>
              </span>
            </div>
            <div class="info-item">
              <span class="info-label">Created On</span>
              <span class="info-value">{{ batch.createdOn | date:'medium' }}</span>
            </div>
          </div>
        </div>

        <!-- Supplier Info (for RM batches from Goods Receipt) -->
        <div class="traceability-section supplier-section" *ngIf="hasSupplierInfo()">
          <h4><i class="fas fa-building"></i> Supplier Information</h4>
          <div class="traceability-grid">
            <div class="info-item" *ngIf="batch.supplierId">
              <span class="info-label">Supplier ID</span>
              <span class="info-value">{{ batch.supplierId }}</span>
            </div>
            <div class="info-item" *ngIf="batch.supplierBatchNumber">
              <span class="info-label">Supplier Batch Number</span>
              <span class="info-value supplier-batch">{{ batch.supplierBatchNumber }}</span>
            </div>
          </div>
          <p class="supplier-note">
            <i class="fas fa-info-circle"></i>
            This batch was received from an external supplier. The supplier batch number can be used for external traceability.
          </p>
        </div>
      </div>
    </div>

    <!-- Quality Approval Status -->
    <div class="card" *ngIf="batch.approvedBy || batch.rejectedBy || batch.status === 'QUALITY_PENDING'">
      <div class="card-header">Quality Approval Status</div>
      <div class="quality-status-content">
        <div class="quality-status-badge" *ngIf="batch.status === 'QUALITY_PENDING'">
          <i class="fas fa-hourglass-half"></i> Pending Quality Inspection
        </div>
        <div class="quality-status-badge approved" *ngIf="batch.approvedBy">
          <i class="fas fa-circle-check"></i> Approved
        </div>
        <div class="quality-status-badge rejected" *ngIf="batch.rejectedBy">
          <i class="fas fa-circle-xmark"></i> Rejected
        </div>
        <div class="quality-info-grid">
          <div class="info-item" *ngIf="batch.approvedBy">
            <span class="info-label">Approved By</span>
            <span class="info-value">{{ batch.approvedBy }}</span>
          </div>
          <div class="info-item" *ngIf="batch.approvedOn">
            <span class="info-label">Approved On</span>
            <span class="info-value">{{ batch.approvedOn | date:'medium' }}</span>
          </div>
          <div class="info-item" *ngIf="batch.rejectedBy">
            <span class="info-label">Rejected By</span>
            <span class="info-value">{{ batch.rejectedBy }}</span>
          </div>
          <div class="info-item" *ngIf="batch.rejectedOn">
            <span class="info-label">Rejected On</span>
            <span class="info-value">{{ batch.rejectedOn | date:'medium' }}</span>
          </div>
          <div class="info-item full-width" *ngIf="batch.rejectionReason">
            <span class="info-label">Rejection Reason</span>
            <span class="info-value rejection-reason">{{ batch.rejectionReason }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Genealogy -->
    <div class="card">
      <div class="card-header">Batch Genealogy (Traceability)</div>

      <div *ngIf="loadingGenealogy" class="text-center">
        <app-loading-spinner message="Loading genealogy..."></app-loading-spinner>
      </div>

      <div *ngIf="!loadingGenealogy && genealogy" class="genealogy-container">
        <!-- Visual Genealogy Chart -->
        <div class="genealogy-chart-section"
             *ngIf="genealogy.parentBatches?.length > 0 || genealogy.childBatches?.length > 0">
          <h4>Visual Genealogy</h4>
          <div #genealogyChart class="genealogy-chart-container"></div>
        </div>

        <!-- Parent Batches (Source Materials) -->
        <div class="genealogy-section" *ngIf="genealogy.parentBatches?.length > 0">
          <h4>Source Materials (Parent Batches)</h4>
          <p class="section-description">Materials that were consumed to create this batch</p>

          <div class="batch-tree">
            <div class="tree-node parent-node" *ngFor="let parent of genealogy.parentBatches">
              <div class="node-connector up"></div>
              <div class="node-card" (click)="navigateToBatch(parent.batchId)">
                <div class="node-header">
                  <span class="node-batch">{{ parent.batchNumber }}</span>
                  <app-status-badge [status]="parent.state"></app-status-badge>
                </div>
                <div class="node-details">
                  <span>Material: {{ parent.materialId }}</span>
                  <span>Consumed: {{ parent.quantityConsumed }} {{ parent.unit }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Current Batch -->
        <div class="current-batch-section">
          <div class="current-batch-node">
            <div class="node-card current">
              <div class="node-header">
                <span class="node-batch">{{ batch.batchNumber }}</span>
                <app-status-badge [status]="batch.state"></app-status-badge>
              </div>
              <div class="node-details">
                <span>Material: {{ batch.materialId }}</span>
                <span>Quantity: {{ batch.quantity }} {{ batch.unit }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Child Batches (Derived Products) -->
        <div class="genealogy-section" *ngIf="genealogy.childBatches?.length > 0">
          <h4>Derived Products (Child Batches)</h4>
          <p class="section-description">Batches that were created using this batch as source material</p>

          <div class="batch-tree">
            <div class="tree-node child-node" *ngFor="let child of genealogy.childBatches">
              <div class="node-connector down"></div>
              <div class="node-card" (click)="navigateToBatch(child.batchId)">
                <div class="node-header">
                  <span class="node-batch">{{ child.batchNumber }}</span>
                  <app-status-badge [status]="child.state"></app-status-badge>
                </div>
                <div class="node-details">
                  <span>Material: {{ child.materialId }}</span>
                  <span>Quantity: {{ child.quantity }} {{ child.unit }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- No Relations -->
        <div *ngIf="!genealogy.parentBatches?.length && !genealogy.childBatches?.length" class="no-relations">
          <p>This batch has no parent or child relationships.</p>
          <p class="hint">Relationships are created when materials are consumed during production confirmation.</p>
        </div>
      </div>
    </div>

    <!-- Batch Allocations (GAP-001: Multi-Order Batch Confirmation) -->
    <div class="card">
      <div class="card-header">
        Order Allocations
        <div class="header-actions" *ngIf="batch.status === 'AVAILABLE' && batchAvailability && !batchAvailability.fullyAllocated">
          <button class="btn btn-primary btn-sm" (click)="openAllocationModal()">+ Allocate to Order</button>
        </div>
      </div>

      <div *ngIf="loadingAllocations" class="text-center">
        <app-loading-spinner message="Loading allocations..."></app-loading-spinner>
      </div>

      <div *ngIf="!loadingAllocations">
        <!-- Availability Summary -->
        <div class="allocation-summary" *ngIf="batchAvailability">
          <div class="summary-item">
            <span class="label">Total Quantity:</span>
            <span class="value">{{ batchAvailability.totalQuantity }} {{ batch.unit }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Allocated:</span>
            <span class="value allocated">{{ batchAvailability.allocatedQuantity }} {{ batch.unit }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Available:</span>
            <span class="value available">{{ batchAvailability.availableQuantity }} {{ batch.unit }}</span>
          </div>
          <div class="summary-item" *ngIf="batchAvailability.fullyAllocated">
            <span class="badge badge-info">Fully Allocated</span>
          </div>
        </div>

        <!-- Active Allocations -->
        <div class="allocations-section" *ngIf="getActiveAllocations().length > 0">
          <h4>Active Allocations</h4>
          <table class="data-table">
            <thead>
              <tr>
                <th>Order</th>
                <th>Product</th>
                <th>Quantity</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let alloc of getActiveAllocations()">
                <td>Order #{{ alloc.orderId }}</td>
                <td>{{ alloc.productSku }} - {{ alloc.productName }}</td>
                <td>{{ alloc.allocatedQty }} {{ alloc.unit }}</td>
                <td>{{ alloc.timestamp | date:'short' }}</td>
                <td>
                  <button class="btn btn-secondary btn-sm" (click)="releaseAllocation(alloc.allocationId)">
                    Release
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Released Allocations -->
        <div class="allocations-section" *ngIf="getReleasedAllocations().length > 0">
          <h4>Released Allocations (History)</h4>
          <table class="data-table">
            <thead>
              <tr>
                <th>Order</th>
                <th>Product</th>
                <th>Quantity</th>
                <th>Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let alloc of getReleasedAllocations()">
                <td>Order #{{ alloc.orderId }}</td>
                <td>{{ alloc.productSku }} - {{ alloc.productName }}</td>
                <td>{{ alloc.allocatedQty }} {{ alloc.unit }}</td>
                <td>{{ alloc.timestamp | date:'short' }}</td>
                <td><span class="badge badge-secondary">Released</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- No Allocations -->
        <div *ngIf="allocations.length === 0" class="no-allocations">
          <p>No allocations for this batch.</p>
          <p class="hint">Allocate this batch to fulfill customer orders.</p>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!loading && !batch" class="card">
    <p class="no-data">Batch not found</p>
  </div>
</div>

<!-- Allocation Modal (GAP-001: Multi-Order Batch Confirmation) -->
<div class="modal-overlay" *ngIf="showAllocationModal" (click)="closeAllocationModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Allocate Batch to Order</h3>
      <button class="close-btn" (click)="closeAllocationModal()"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="allocation-info">
        <p><strong>Batch:</strong> {{ batch?.batchNumber }}</p>
        <p><strong>Material:</strong> {{ batch?.materialId }} - {{ batch?.materialName }}</p>
        <p><strong>Available Quantity:</strong> {{ batchAvailability?.availableQuantity }} {{ batch?.unit }}</p>
      </div>

      <div class="form-group">
        <label>Select Order Line *</label>
        <select [(ngModel)]="allocationOrderLineId" class="form-control">
          <option [ngValue]="null">-- Select an order line --</option>
          <option *ngFor="let line of availableOrderLines" [ngValue]="line.orderLineId">
            Order {{ line.orderNumber }} - {{ line.productSku }} ({{ line.productName }}) - {{ line.orderedQty }} {{ line.unit }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>Allocation Quantity *</label>
        <input type="number"
               [(ngModel)]="allocationQuantity"
               [max]="batchAvailability?.availableQuantity || 0"
               min="0.01"
               step="0.01"
               class="form-control">
        <small class="form-text text-muted">
          Max: {{ batchAvailability?.availableQuantity }} {{ batch?.unit }}
        </small>
      </div>

      <div *ngIf="error" class="alert alert-error">{{ error }}</div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeAllocationModal()">Cancel</button>
      <button class="btn btn-primary" (click)="submitAllocation()" [disabled]="!canAllocate() || submitting">
        {{ submitting ? 'Allocating...' : 'Allocate' }}
      </button>
    </div>
  </div>
</div>
