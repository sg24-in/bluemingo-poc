<div class="container">
  <div class="page-header">
    <h1 class="page-title">Quality Inspection</h1>
    <p class="page-subtitle">Review and approve or reject processes awaiting quality inspection</p>
  </div>

  <div *ngIf="error" class="alert alert-error" (click)="clearMessages()">
    {{ error }}
    <button class="alert-close"><i class="fas fa-xmark"></i></button>
  </div>
  <div *ngIf="success" class="alert alert-success" (click)="clearMessages()">
    {{ success }}
    <button class="alert-close"><i class="fas fa-xmark"></i></button>
  </div>

  <div *ngIf="loading" class="text-center">
    <app-loading-spinner message="Loading processes..."></app-loading-spinner>
  </div>

  <div *ngIf="!loading">
    <!-- Tab Navigation -->
    <div class="tab-nav">
      <button
        class="tab-btn"
        [class.active]="activeTab === 'pending'"
        (click)="setActiveTab('pending')">
        Quality Pending
        <span class="badge" *ngIf="qualityPendingProcesses.length > 0">
          {{ qualityPendingProcesses.length }}
        </span>
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'rejected'"
        (click)="setActiveTab('rejected')">
        Rejected
        <span class="badge rejected" *ngIf="rejectedProcesses.length > 0">
          {{ rejectedProcesses.length }}
        </span>
      </button>
    </div>

    <!-- Quality Pending Tab -->
    <div class="tab-content" *ngIf="activeTab === 'pending'">
      <div class="card">
        <div class="card-header">
          <span>Processes Awaiting Quality Inspection</span>
        </div>
        <div class="card-body">
          <table class="table" *ngIf="qualityPendingProcesses.length > 0">
            <thead>
              <tr>
                <th>Process ID</th>
                <th>Stage Name</th>
                <th>Operations</th>
                <th>Status</th>
                <th>Updated</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let process of qualityPendingProcesses">
                <td>{{ process.processId }}</td>
                <td>{{ process.stageName }}</td>
                <td>{{ getOperationsSummary(process) }}</td>
                <td><app-status-badge [status]="process.status"></app-status-badge></td>
                <td>{{ process.updatedOn | date:'short' }}</td>
                <td class="actions-cell">
                  <button
                    class="btn btn-sm btn-success"
                    (click)="openDecisionModal(process, 'accept')"
                    [disabled]="processing">
                    Accept
                  </button>
                  <button
                    class="btn btn-sm btn-danger"
                    (click)="openDecisionModal(process, 'reject')"
                    [disabled]="processing">
                    Reject
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          <p *ngIf="qualityPendingProcesses.length === 0" class="no-data">
            No processes awaiting quality inspection
          </p>
        </div>
      </div>
    </div>

    <!-- Rejected Tab -->
    <div class="tab-content" *ngIf="activeTab === 'rejected'">
      <div class="card">
        <div class="card-header">
          <span>Rejected Processes</span>
        </div>
        <div class="card-body">
          <table class="table" *ngIf="rejectedProcesses.length > 0">
            <thead>
              <tr>
                <th>Process ID</th>
                <th>Stage Name</th>
                <th>Operations</th>
                <th>Status</th>
                <th>Updated</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let process of rejectedProcesses">
                <td>{{ process.processId }}</td>
                <td>{{ process.stageName }}</td>
                <td>{{ getOperationsSummary(process) }}</td>
                <td><app-status-badge [status]="process.status"></app-status-badge></td>
                <td>{{ process.updatedOn | date:'short' }}</td>
                <td class="actions-cell">
                  <button
                    class="btn btn-sm btn-primary"
                    (click)="retryProcess(process)"
                    [disabled]="processing">
                    Retry Inspection
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          <p *ngIf="rejectedProcesses.length === 0" class="no-data">
            No rejected processes
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quality Decision Modal -->
<div class="modal-overlay" *ngIf="showDecisionModal" (click)="closeDecisionModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header" [class.accept-header]="decisionType === 'accept'" [class.reject-header]="decisionType === 'reject'">
      <h3>{{ decisionType === 'accept' ? 'Accept Process' : 'Reject Process' }}</h3>
      <button class="close-btn" (click)="closeDecisionModal()"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="process-details" *ngIf="selectedProcess">
        <p><strong>Process ID:</strong> {{ selectedProcess.processId }}</p>
        <p><strong>Stage Name:</strong> {{ selectedProcess.stageName }}</p>
        <p><strong>Operations:</strong> {{ getOperationsSummary(selectedProcess) }}</p>
      </div>

      <div *ngIf="decisionType === 'accept'" class="decision-info accept-info">
        <p>Are you sure you want to accept this process?</p>
        <p>The process will be marked as <strong>COMPLETED</strong>.</p>
      </div>

      <div *ngIf="decisionType === 'reject'" class="decision-info reject-info">
        <p>Please provide a reason for rejecting this process.</p>
        <p>The process will be marked as <strong>REJECTED</strong>.</p>
      </div>

      <div class="form-group" *ngIf="decisionType === 'reject'">
        <label for="rejectReason">Rejection Reason *</label>
        <textarea
          id="rejectReason"
          [(ngModel)]="rejectReason"
          rows="3"
          placeholder="Enter the reason for rejection..."></textarea>
      </div>

      <div class="form-group">
        <label for="notes">Notes (Optional)</label>
        <textarea
          id="notes"
          [(ngModel)]="notes"
          rows="2"
          placeholder="Additional notes..."></textarea>
      </div>

      <div *ngIf="error" class="alert alert-error modal-error">{{ error }}</div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeDecisionModal()">Cancel</button>
      <button
        type="button"
        class="btn"
        [class.btn-success]="decisionType === 'accept'"
        [class.btn-danger]="decisionType === 'reject'"
        (click)="submitDecision()"
        [disabled]="processing || (decisionType === 'reject' && !rejectReason.trim())">
        {{ processing ? 'Processing...' : (decisionType === 'accept' ? 'Accept' : 'Reject') }}
      </button>
    </div>
  </div>
</div>
