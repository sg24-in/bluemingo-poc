<div class="audit-list-page">
  <div class="page-header">
    <h1 class="page-title">Audit Trail</h1>
    <div class="header-stats">
      <span class="stat-badge"><strong>{{ todaysCount }}</strong> changes today</span>
    </div>
  </div>

  <div class="card">
    <div class="filters">
      <div class="filter-group">
        <label for="entity-filter">Entity:</label>
        <select id="entity-filter" [(ngModel)]="filterEntityType" (change)="onFilterChange()">
          <option value="all">All Entities</option>
          <option *ngFor="let t of entityTypes" [value]="t">{{ formatEntityType(t) }}</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="action-filter">Action:</label>
        <select id="action-filter" [(ngModel)]="filterAction" (change)="onFilterChange()">
          <option value="all">All Actions</option>
          <option *ngFor="let a of actionTypes" [value]="a">{{ a }}</option>
        </select>
      </div>

      <div class="filter-group search-group">
        <label for="user-filter">User:</label>
        <input
          type="text"
          id="user-filter"
          [(ngModel)]="filterUser"
          placeholder="Filter by user..."
          (keyup.enter)="onFilterChange()"
        />
        <button class="btn btn-sm btn-primary" (click)="onFilterChange()">Search</button>
      </div>

      <button class="btn btn-sm btn-secondary" (click)="clearFilters()">Clear</button>
    </div>
  </div>

  <div class="error-banner" *ngIf="error">{{ error }}</div>

  <div class="audit-content" *ngIf="!loading; else loadingTpl">
    <div class="table-container" *ngIf="entries.length > 0; else emptyTpl">
      <table class="data-table">
        <thead>
          <tr>
            <th class="col-action">Action</th>
            <th class="col-entity">Entity</th>
            <th class="col-id">ID</th>
            <th class="col-field">Field</th>
            <th class="col-change">Change</th>
            <th class="col-user">User</th>
            <th class="col-time">Timestamp</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let entry of entries"
              (click)="selectEntry(entry)"
              [class.selected]="selectedEntry === entry"
              class="audit-row">
            <td>
              <span class="action-badge" [ngClass]="getActionClass(entry.action)">
                <i class="fas" [ngClass]="'fa-' + getActionIcon(entry.action)"></i>
                {{ entry.action }}
              </span>
            </td>
            <td>{{ formatEntityType(entry.entityType) }}</td>
            <td class="mono">{{ entry.entityId }}</td>
            <td>{{ entry.fieldName || '-' }}</td>
            <td class="change-cell">
              <ng-container *ngIf="entry.oldValue || entry.newValue">
                <span class="old-value" *ngIf="entry.oldValue">{{ entry.oldValue }}</span>
                <i class="fas fa-arrow-right change-arrow" *ngIf="entry.oldValue && entry.newValue"></i>
                <span class="new-value" *ngIf="entry.newValue">{{ entry.newValue }}</span>
              </ng-container>
              <span *ngIf="!entry.oldValue && !entry.newValue">-</span>
            </td>
            <td>{{ entry.changedBy }}</td>
            <td class="mono">{{ formatTimestamp(entry.timestamp) }}</td>
          </tr>
        </tbody>
      </table>

      <!-- Pagination Controls -->
      <div class="pagination-container">
        <div class="pagination-info">
          Showing {{ startIndex }} - {{ endIndex }} of {{ totalElements }} entries
        </div>

        <div class="pagination-controls">
          <div class="page-size-selector">
            <label for="page-size">Per page:</label>
            <select id="page-size" [(ngModel)]="pageSize" (change)="onPageSizeChange()">
              <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
            </select>
          </div>

          <div class="page-navigation">
            <button
              class="btn btn-sm"
              [disabled]="currentPage === 0"
              (click)="onPageChange(0)">
              <i class="fas fa-angles-left"></i>
            </button>
            <button
              class="btn btn-sm"
              [disabled]="currentPage === 0"
              (click)="onPageChange(currentPage - 1)">
              <i class="fas fa-angle-left"></i>
            </button>

            <span class="page-numbers">
              <button
                *ngFor="let p of pages"
                class="btn btn-sm"
                [class.active]="p === currentPage"
                (click)="onPageChange(p)">
                {{ p + 1 }}
              </button>
            </span>

            <button
              class="btn btn-sm"
              [disabled]="currentPage >= totalPages - 1"
              (click)="onPageChange(currentPage + 1)">
              <i class="fas fa-angle-right"></i>
            </button>
            <button
              class="btn btn-sm"
              [disabled]="currentPage >= totalPages - 1"
              (click)="onPageChange(totalPages - 1)">
              <i class="fas fa-angles-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <ng-template #emptyTpl>
      <div class="empty-state">
        <i class="fas fa-clock-rotate-left"></i>
        <p>No audit entries found.</p>
      </div>
    </ng-template>
  </div>

  <ng-template #loadingTpl>
    <div class="loading">Loading audit trail...</div>
  </ng-template>
</div>
