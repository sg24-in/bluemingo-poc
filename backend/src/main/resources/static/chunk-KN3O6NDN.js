import{a as re,b as ke}from"./chunk-JNCTVHCN.js";import{h as F,k as Pe,n as Oe}from"./chunk-LMWWBC6Z.js";import{$ as R,$a as Ee,Aa as V,B as d,C as ce,D as W,Da as A,F as o,G as i,H as T,Ha as U,I as ee,Ia as I,J as te,Ja as K,K as ne,Ka as ve,L as b,La as be,M as f,Ma as Ce,N as m,Na as Se,P as me,Pa as Me,Q as pe,R as ue,S as ie,Sa as ye,T as a,Ta as Y,U as C,Ua as H,V as v,Va as Z,W as O,X as oe,Xa as Te,Z as L,Za as Ie,_ as q,_a as we,ba as ge,ca as fe,ga as _e,ia as Q,ja as B,ka as N,la as xe,m as $,o as P,p as j,qa as he,r as p,s as u,w as l,x as y,ya as G,z as g}from"./chunk-SXRLIX2W.js";function Ae(n,c){if(n&1){let e=b();o(0,"button",15),f("click",function(){p(e);let t=m();return u(t.clearSearch())}),a(1,"Clear"),i()}}function ze(n,c){n&1&&(o(0,"div",16),a(1," Loading BOM products... "),i())}function De(n,c){if(n&1){let e=b();o(0,"div",17),a(1),o(2,"button",15),f("click",function(){p(e);let t=m();return u(t.loadProducts())}),a(3,"Retry"),i()()}if(n&2){let e=m();l(),v(" ",e.error," ")}}function $e(n,c){if(n&1){let e=b();o(0,"div",18)(1,"p"),a(2,"No BOMs found."),i(),o(3,"button",3),f("click",function(){p(e);let t=m();return u(t.createNewBom())}),a(4,"+ Create First BOM"),i()()}}function je(n,c){if(n&1){let e=b();o(0,"div",21)(1,"div",22)(2,"h3"),a(3),i(),o(4,"span",23),a(5),i()(),o(6,"div",24)(7,"div",25)(8,"span",26),a(9,"Version"),i(),o(10,"span",27),a(11),i()(),o(12,"div",25)(13,"span",26),a(14,"Total Nodes"),i(),o(15,"span",27),a(16),i()(),o(17,"div",25)(18,"span",26),a(19,"Max Level"),i(),o(20,"span",27),a(21),i()()(),o(22,"div",28)(23,"button",15),f("click",function(){let t=p(e).$implicit,s=m(2);return u(s.viewTree(t.productSku))}),a(24," View Tree "),i(),o(25,"button",3),f("click",function(){let t=p(e).$implicit,s=m(2);return u(s.addNode(t.productSku))}),a(26," + Add Node "),i()()()}if(n&2){let e=c.$implicit,r=m(2);l(3),C(e.productSku),l(),d("ngClass",r.getStatusClass(e.status)),l(),v(" ",e.status," "),l(6),C(e.bomVersion),l(5),C(e.totalNodes),l(5),C(e.maxLevel)}}function We(n,c){if(n&1&&(o(0,"div",19),g(1,je,27,6,"div",20),i()),n&2){let e=m();l(),d("ngForOf",e.products)}}function Qe(n,c){if(n&1){let e=b();o(0,"app-pagination",29),f("pageChange",function(t){p(e);let s=m();return u(s.onPageChange(t))})("sizeChange",function(t){p(e);let s=m();return u(s.onSizeChange(t))}),i()}if(n&2){let e=m();d("page",e.page)("size",e.size)("totalElements",e.totalElements)("totalPages",e.totalPages)("hasNext",e.hasNext)("hasPrevious",e.hasPrevious)}}var Fe=(()=>{class n{constructor(e,r){this.apiService=e,this.router=r,this.products=[],this.loading=!0,this.error=null,this.page=0,this.size=20,this.totalElements=0,this.totalPages=0,this.hasNext=!1,this.hasPrevious=!1,this.searchTerm=""}ngOnInit(){this.loadProducts()}loadProducts(){this.loading=!0,this.error=null;let e={page:this.page,size:this.size,sortBy:"productSku",sortDirection:"ASC",search:this.searchTerm||void 0};this.apiService.getBomProductsPaged(e).subscribe({next:r=>{this.products=r.content,this.page=r.page,this.size=r.size,this.totalElements=r.totalElements,this.totalPages=r.totalPages,this.hasNext=r.hasNext,this.hasPrevious=r.hasPrevious,this.loading=!1},error:r=>{this.error=r.error?.message||"Failed to load BOM products",this.loading=!1,console.error("Error loading BOM products:",r)}})}onPageChange(e){this.page=e,this.loadProducts()}onSizeChange(e){this.size=e,this.page=0,this.loadProducts()}onSearchChange(e){this.searchTerm=e,this.page=0,this.loadProducts()}clearSearch(){this.searchTerm="",this.page=0,this.loadProducts()}viewTree(e){this.router.navigate(["/manage/bom",e,"tree"])}addNode(e){this.router.navigate(["/manage/bom",e,"node","new"])}createNewBom(){this.router.navigate(["/manage/bom","create"])}getStatusClass(e){switch(e?.toUpperCase()){case"ACTIVE":return"status-active";case"EMPTY":return"status-empty";case"INACTIVE":return"status-inactive";case"DRAFT":return"status-draft";case"OBSOLETE":return"status-obsolete";default:return""}}static{this.\u0275fac=function(r){return new(r||n)(y(F),y(V))}}static{this.\u0275cmp=P({type:n,selectors:[["app-bom-list"]],decls:18,vars:7,consts:[[1,"bom-list-container"],[1,"page-header"],[1,"page-title"],[1,"btn","btn-primary",3,"click"],[1,"card"],[1,"filters"],[1,"filter-group","search-group"],["for","search"],["type","text","id","search","placeholder","Search by product SKU...",3,"input","value"],["class","btn btn-secondary",3,"click",4,"ngIf"],["class","loading",4,"ngIf"],["class","error-message",4,"ngIf"],["class","empty-state",4,"ngIf"],["class","products-grid",4,"ngIf"],[3,"page","size","totalElements","totalPages","hasNext","hasPrevious","pageChange","sizeChange",4,"ngIf"],[1,"btn","btn-secondary",3,"click"],[1,"loading"],[1,"error-message"],[1,"empty-state"],[1,"products-grid"],["class","product-card",4,"ngFor","ngForOf"],[1,"product-card"],[1,"card-header"],[1,"status-badge",3,"ngClass"],[1,"card-body"],[1,"stat"],[1,"stat-label"],[1,"stat-value"],[1,"card-actions"],[3,"pageChange","sizeChange","page","size","totalElements","totalPages","hasNext","hasPrevious"]],template:function(r,t){r&1&&(o(0,"div",0)(1,"div",1)(2,"h1",2),a(3,"Bill of Materials"),i(),o(4,"button",3),f("click",function(){return t.createNewBom()}),a(5," + New BOM "),i()(),o(6,"div",4)(7,"div",5)(8,"div",6)(9,"label",7),a(10,"Search:"),i(),o(11,"input",8),f("input",function(_){return t.onSearchChange(_.target.value)}),i()(),g(12,Ae,2,0,"button",9),i()(),g(13,ze,2,0,"div",10)(14,De,4,1,"div",11)(15,$e,5,0,"div",12)(16,We,2,1,"div",13)(17,Qe,1,6,"app-pagination",14),i()),r&2&&(l(11),d("value",t.searchTerm),l(),d("ngIf",t.searchTerm),l(),d("ngIf",t.loading),l(),d("ngIf",t.error),l(),d("ngIf",!t.loading&&!t.error&&t.products.length===0),l(),d("ngIf",!t.loading&&!t.error&&t.products.length>0),l(),d("ngIf",!t.loading&&!t.error&&t.products.length>0))},dependencies:[Q,B,N,Pe],styles:[".bom-list-container[_ngcontent-%COMP%]{padding:24px}.page-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}.page-header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin:0;font-size:24px;font-weight:600;color:#1e293b}.loading[_ngcontent-%COMP%]{text-align:center;padding:48px;color:#64748b}.error-message[_ngcontent-%COMP%]{background:#fef2f2;border:1px solid #fecaca;color:#dc2626;padding:16px;border-radius:8px;display:flex;justify-content:space-between;align-items:center}.empty-state[_ngcontent-%COMP%]{text-align:center;padding:48px;background:#f8fafc;border-radius:8px;border:2px dashed #e2e8f0}.empty-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:#64748b;margin-bottom:16px}.products-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:24px}.product-card[_ngcontent-%COMP%]{background:#fff;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden;transition:box-shadow .2s}.product-card[_ngcontent-%COMP%]:hover{box-shadow:0 4px 12px #0000001a}.card-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:16px;background:#f8fafc;border-bottom:1px solid #e2e8f0}.card-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;font-size:16px;font-weight:600;color:#1e293b}.status-badge[_ngcontent-%COMP%]{padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500;text-transform:uppercase}.status-active[_ngcontent-%COMP%]{background:#dcfce7;color:#16a34a}.status-empty[_ngcontent-%COMP%]{background:#fef3c7;color:#d97706}.status-inactive[_ngcontent-%COMP%]{background:#f1f5f9;color:#64748b}.status-draft[_ngcontent-%COMP%]{background:#fef3c7;color:#92400e}.status-obsolete[_ngcontent-%COMP%]{background:#fee2e2;color:#991b1b}.card-body[_ngcontent-%COMP%]{padding:16px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px}.stat[_ngcontent-%COMP%]{text-align:center}.stat-label[_ngcontent-%COMP%]{display:block;font-size:12px;color:#64748b;margin-bottom:4px}.stat-value[_ngcontent-%COMP%]{display:block;font-size:18px;font-weight:600;color:#1e293b}.card-actions[_ngcontent-%COMP%]{display:flex;gap:8px;padding:16px;border-top:1px solid #e2e8f0}.card-actions[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{flex:1}.btn[_ngcontent-%COMP%]{padding:8px 16px;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;border:none;transition:background-color .2s;display:inline-flex;align-items:center;justify-content:center;gap:6px}.btn-primary[_ngcontent-%COMP%]{background:#3b82f6;color:#fff}.btn-primary[_ngcontent-%COMP%]:hover{background:#2563eb}.btn-secondary[_ngcontent-%COMP%]{background:#f1f5f9;color:#475569}.btn-secondary[_ngcontent-%COMP%]:hover{background:#e2e8f0}"]})}}return n})();var Ue=["bomFlowChart"],Ke=n=>({$implicit:n,level:1}),Ye=(n,c)=>({$implicit:n,level:c});function He(n,c){if(n&1&&(o(0,"span",20),a(1," | Status: "),o(2,"span",21),a(3),i()()),n&2){let e=m(2);l(2),d("ngClass","status-"+(e.bomTree.tree[0].status||"active").toLowerCase()),l(),v(" ",e.bomTree.tree[0].status||"ACTIVE"," ")}}function Ze(n,c){if(n&1&&(o(0,"div",18),a(1),g(2,He,4,2,"span",19),i()),n&2){let e=m();l(),oe(" Version: ",e.bomTree.bomVersion," | Nodes: ",e.bomTree.totalNodes," | Depth: ",e.bomTree.maxDepth," "),l(),d("ngIf",e.bomTree.tree.length>0)}}function Je(n,c){if(n&1){let e=b();o(0,"button",11),f("click",function(){p(e);let t=m();return u(t.openEditSettingsModal())}),a(1,"Edit BOM Settings"),i()}}function Xe(n,c){n&1&&(o(0,"div",22),a(1," Loading BOM tree... "),i())}function et(n,c){if(n&1){let e=b();o(0,"div",23),a(1),o(2,"button",11),f("click",function(){p(e);let t=m();return u(t.loadBomTree())}),a(3,"Retry"),i()()}if(n&2){let e=m();l(),v(" ",e.error," ")}}function tt(n,c){n&1&&(o(0,"div",24)(1,"div",25),a(2,"BOM Flow"),i(),T(3,"div",26,1),i())}function nt(n,c){if(n&1){let e=b();o(0,"div",30)(1,"p"),a(2,"No BOM nodes defined for this product."),i(),o(3,"button",12),f("click",function(){p(e);let t=m(2);return u(t.addRootNode())}),a(4,"+ Add First Node"),i()()}}function it(n,c){n&1&&ne(0)}function ot(n,c){if(n&1&&(ee(0),g(1,it,1,0,"ng-container",33),te()),n&2){let e=c.$implicit;m(3);let r=ie(25);l(),d("ngTemplateOutlet",r)("ngTemplateOutletContext",ge(2,Ke,e))}}function rt(n,c){if(n&1&&(o(0,"div",31),g(1,ot,2,4,"ng-container",32),i()),n&2){let e=m(2);l(),d("ngForOf",e.bomTree.tree)}}function at(n,c){if(n&1&&(o(0,"div",27),g(1,nt,5,0,"div",28)(2,rt,2,1,"div",29),i()),n&2){let e=m();l(),d("ngIf",e.bomTree.tree.length===0),l(),d("ngIf",e.bomTree.tree.length>0)}}function lt(n,c){if(n&1){let e=b();o(0,"div",34),f("click",function(){p(e);let t=m();return u(t.cancelDelete())}),o(1,"div",35),f("click",function(t){return p(e),u(t.stopPropagation())}),o(2,"h3"),a(3,"Delete BOM Node"),i(),o(4,"p"),a(5,"Are you sure you want to delete this node?"),i(),o(6,"div",36)(7,"button",11),f("click",function(){p(e);let t=m();return u(t.cancelDelete())}),a(8,"Cancel"),i(),o(9,"button",37),f("click",function(){p(e);let t=m();return u(t.deleteNode(t.deleteConfirmId,!1))}),a(10,"Delete Node Only"),i(),o(11,"button",38),f("click",function(){p(e);let t=m();return u(t.deleteNode(t.deleteConfirmId,!0))}),a(12,"Delete with Children"),i()()()()}}function dt(n,c){if(n&1&&(o(0,"option",54),a(1),i()),n&2){let e=c.$implicit,r=m(2);d("value",e.sku)("hidden",e.sku===r.productSku),l(),O(" ",e.sku," - ",e.productName," ")}}function st(n,c){n&1&&(o(0,"small",55),a(1," Warning: Changing product will move all BOM nodes to the new product "),i())}function ct(n,c){if(n&1&&(o(0,"option",44),a(1),i()),n&2){let e=c.$implicit;d("value",e),l(),C(e)}}function mt(n,c){if(n&1&&(o(0,"div",23),a(1),i()),n&2){let e=m(2);l(),C(e.settingsError)}}function pt(n,c){if(n&1){let e=b();o(0,"div",34),f("click",function(){p(e);let t=m();return u(t.closeEditSettingsModal())}),o(1,"div",39),f("click",function(t){return p(e),u(t.stopPropagation())}),o(2,"h3"),a(3,"Edit BOM Settings"),i(),o(4,"p",40),a(5,"Update top-level settings for all nodes in this BOM"),i(),o(6,"div",41)(7,"label",42),a(8,"Product"),i(),o(9,"select",43),R("ngModelChange",function(t){p(e);let s=m();return q(s.editProductSku,t)||(s.editProductSku=t),u(t)}),o(10,"option",44),a(11),i(),g(12,dt,2,4,"option",45),i(),g(13,st,2,0,"small",46),i(),o(14,"div",41)(15,"label",47),a(16,"BOM Version"),i(),o(17,"input",48),R("ngModelChange",function(t){p(e);let s=m();return q(s.editBomVersion,t)||(s.editBomVersion=t),u(t)}),i()(),o(18,"div",41)(19,"label",49),a(20,"Status"),i(),o(21,"select",50),R("ngModelChange",function(t){p(e);let s=m();return q(s.editBomStatus,t)||(s.editBomStatus=t),u(t)}),g(22,ct,2,2,"option",51),i()(),g(23,mt,2,1,"div",14),o(24,"div",36)(25,"button",52),f("click",function(){p(e);let t=m();return u(t.closeEditSettingsModal())}),a(26,"Cancel"),i(),o(27,"button",53),f("click",function(){p(e);let t=m();return u(t.saveSettings())}),a(28),i()()()()}if(n&2){let e=m();l(9),L("ngModel",e.editProductSku),l(),d("value",e.productSku),l(),v("",e.productSku," (Current)"),l(),d("ngForOf",e.products),l(),d("ngIf",e.editProductSku!==e.productSku),l(4),L("ngModel",e.editBomVersion),l(4),L("ngModel",e.editBomStatus),l(),d("ngForOf",e.statusOptions),l(),d("ngIf",e.settingsError),l(2),d("disabled",e.savingSettings),l(2),d("disabled",e.savingSettings),l(),v(" ",e.savingSettings?"Saving...":"Save Settings"," ")}}function ut(n,c){if(n&1&&(o(0,"option",58),a(1),i()),n&2){let e=c.$implicit;d("ngValue",e.bomId),l(),oe(" ","\xA0".repeat((e.sequenceLevel-1)*2),"",e.materialId," - ",e.materialName," ")}}function gt(n,c){if(n&1&&(o(0,"div",23),a(1),i()),n&2){let e=m(2);l(),C(e.moveError)}}function ft(n,c){if(n&1){let e=b();o(0,"div",34),f("click",function(){p(e);let t=m();return u(t.closeMoveModal())}),o(1,"div",39),f("click",function(t){return p(e),u(t.stopPropagation())}),o(2,"h3"),a(3,"Move Node"),i(),o(4,"p",40),a(5,"Select a new parent for this node, or make it a root node."),i(),o(6,"div",41)(7,"label",56),a(8,"New Parent"),i(),o(9,"select",57),R("ngModelChange",function(t){p(e);let s=m();return q(s.moveTargetParentId,t)||(s.moveTargetParentId=t),u(t)}),o(10,"option",58),a(11,"-- Root Level (no parent) --"),i(),g(12,ut,2,4,"option",59),i()(),g(13,gt,2,1,"div",14),o(14,"div",36)(15,"button",52),f("click",function(){p(e);let t=m();return u(t.closeMoveModal())}),a(16,"Cancel"),i(),o(17,"button",53),f("click",function(){p(e);let t=m();return u(t.performMove())}),a(18),i()()()()}if(n&2){let e=m();l(9),L("ngModel",e.moveTargetParentId),l(),d("ngValue",null),l(2),d("ngForOf",e.allFlatNodes),l(),d("ngIf",e.moveError),l(2),d("disabled",e.movingNode),l(2),d("disabled",e.movingNode),l(),v(" ",e.movingNode?"Moving...":"Move Node"," ")}}function _t(n,c){if(n&1){let e=b();o(0,"button",76),f("click",function(t){p(e);let s=m().$implicit;return m().toggleNode(s.bomId),u(t.stopPropagation())}),a(1),i()}if(n&2){let e=m().$implicit,r=m();l(),v(" ",r.isExpanded(e.bomId)?"\u25BC":"\u25B6"," ")}}function xt(n,c){n&1&&T(0,"span",77)}function ht(n,c){if(n&1&&(o(0,"span",78),a(1),i()),n&2){let e=m().$implicit;l(),v(" (Yield: ",e.yieldLossRatio,") ")}}function vt(n,c){n&1&&ne(0)}function bt(n,c){if(n&1&&(ee(0),g(1,vt,1,0,"ng-container",33),te()),n&2){let e=c.$implicit,r=m(2).level;m();let t=ie(25);l(),d("ngTemplateOutlet",t)("ngTemplateOutletContext",fe(2,Ye,e,r+1))}}function Ct(n,c){if(n&1&&(o(0,"div",79),g(1,bt,2,5,"ng-container",32),i()),n&2){let e=m().$implicit;l(),d("ngForOf",e.children)}}function St(n,c){if(n&1){let e=b();o(0,"div",60)(1,"div",61),g(2,_t,2,1,"button",62)(3,xt,1,0,"span",63),o(4,"div",64),f("click",function(){let t=p(e).$implicit,s=m();return u(s.selectNode(t))}),o(5,"span",65),a(6),i(),o(7,"span",66),a(8),i(),o(9,"span",67),a(10),i(),g(11,ht,2,1,"span",68),o(12,"span",69),a(13),i(),o(14,"span",21),a(15),i()(),o(16,"div",70)(17,"button",71),f("click",function(t){let s=p(e).$implicit;return m().addChildNode(s.bomId),u(t.stopPropagation())}),a(18," + Child "),i(),o(19,"button",72),f("click",function(t){let s=p(e).$implicit;return m().openMoveModal(s.bomId),u(t.stopPropagation())}),a(20," Move "),i(),o(21,"button",73),f("click",function(t){let s=p(e).$implicit;return m().editNode(s.bomId),u(t.stopPropagation())}),a(22," Edit "),i(),o(23,"button",74),f("click",function(t){let s=p(e).$implicit;return m().confirmDelete(s.bomId),u(t.stopPropagation())}),a(24," Delete "),i()()(),g(25,Ct,2,1,"div",75),i()}if(n&2){let e=c.$implicit,r=c.level,t=m();W("selected",t.isSelected(e)),l(),ce("padding-left",t.getIndentLevel(r)),l(),d("ngIf",(e.children==null?null:e.children.length)>0),l(),d("ngIf",!(e.children!=null&&e.children.length)),l(3),C(e.materialId),l(2),C(e.materialName),l(2),O("",e.quantityRequired," ",e.unit,""),l(),d("ngIf",e.yieldLossRatio&&e.yieldLossRatio!==1),l(2),v("L",e.sequenceLevel,""),l(),d("ngClass","status-"+(e.status||"active").toLowerCase()),l(),v(" ",e.status||"ACTIVE"," "),l(10),d("ngIf",(e.children==null?null:e.children.length)>0&&t.isExpanded(e.bomId))}}var Le=(()=>{class n{constructor(e,r,t,s){this.route=e,this.router=r,this.apiService=t,this.chartService=s,this.productSku="",this.bomTree=null,this.expandedNodes=new Set,this.selectedNode=null,this.loading=!0,this.error=null,this.deleteConfirmId=null,this.showMoveModal=!1,this.moveNodeId=null,this.moveTargetParentId=null,this.movingNode=!1,this.moveError=null,this.allFlatNodes=[],this.showEditSettingsModal=!1,this.editProductSku="",this.editBomVersion="",this.editBomStatus="",this.savingSettings=!1,this.settingsError=null,this.statusOptions=["ACTIVE","INACTIVE","DRAFT","OBSOLETE"],this.products=[]}ngOnInit(){this.route.params.subscribe(e=>{this.productSku=e.productSku,this.loadBomTree()})}loadBomTree(){this.loading=!0,this.error=null,this.apiService.getBomTree(this.productSku).subscribe({next:e=>{this.bomTree=e,this.loading=!1,e.tree.forEach(r=>this.expandedNodes.add(r.bomId)),setTimeout(()=>this.buildBomFlowChart(),50)},error:e=>{this.error="Failed to load BOM tree",this.loading=!1,console.error("Error loading BOM tree:",e)}})}toggleNode(e){this.expandedNodes.has(e)?this.expandedNodes.delete(e):this.expandedNodes.add(e)}isExpanded(e){return this.expandedNodes.has(e)}selectNode(e){this.selectedNode=this.selectedNode?.bomId===e.bomId?null:e}isSelected(e){return this.selectedNode?.bomId===e.bomId}expandAll(){this.bomTree&&this.collectAllNodeIds(this.bomTree.tree).forEach(e=>this.expandedNodes.add(e))}collapseAll(){this.expandedNodes.clear()}collectAllNodeIds(e){let r=[],t=s=>{s.forEach(_=>{r.push(_.bomId),_.children?.length&&t(_.children)})};return t(e),r}addRootNode(){this.router.navigate(["/manage/bom",this.productSku,"node","new"])}addChildNode(e){this.router.navigate(["/manage/bom",this.productSku,"node","new"],{queryParams:{parentId:e}})}editNode(e){this.router.navigate(["/manage/bom",this.productSku,"node",e,"edit"])}confirmDelete(e){this.deleteConfirmId=e}cancelDelete(){this.deleteConfirmId=null}deleteNode(e,r=!1){(r?this.apiService.deleteBomNodeCascade(e):this.apiService.deleteBomNode(e)).subscribe({next:()=>{this.deleteConfirmId=null,this.loadBomTree()},error:s=>{this.deleteConfirmId=null,this.error=s.error?.message||"Failed to delete node. It may have children.",console.error("Error deleting node:",s)}})}goBack(){this.router.navigate(["/manage/bom"])}getIndentLevel(e){return`${Math.min((e-1)*24,240)}px`}openEditSettingsModal(){this.bomTree&&(this.editProductSku=this.bomTree.productSku,this.editBomVersion=this.bomTree.bomVersion,this.editBomStatus=this.bomTree.tree.length>0?this.bomTree.tree[0].status:"ACTIVE",this.settingsError=null,this.loadProducts(),this.showEditSettingsModal=!0)}closeEditSettingsModal(){this.showEditSettingsModal=!1,this.settingsError=null}loadProducts(){this.apiService.getActiveProducts().subscribe({next:e=>{this.products=e},error:e=>{console.error("Error loading products:",e)}})}saveSettings(){if(!this.editBomVersion.trim()){this.settingsError="BOM Version is required";return}if(!this.editProductSku.trim()){this.settingsError="Product is required";return}this.savingSettings=!0,this.settingsError=null;let e={bomVersion:this.editBomVersion,status:this.editBomStatus};this.editProductSku!==this.productSku&&(e.newProductSku=this.editProductSku),this.apiService.updateBomSettings(this.productSku,e).subscribe({next:r=>{this.savingSettings=!1,this.showEditSettingsModal=!1,r.productSku!==this.productSku?this.router.navigate(["/manage/bom",r.productSku,"tree"]):this.loadBomTree()},error:r=>{this.savingSettings=!1,this.settingsError=r.error?.message||"Failed to update BOM settings"}})}openMoveModal(e){if(this.moveNodeId=e,this.moveTargetParentId=null,this.moveError=null,this.movingNode=!1,this.bomTree){let r=this.getDescendantIds(e,this.bomTree.tree);r.add(e),this.allFlatNodes=[],this.flattenNodesForMove(this.bomTree.tree,r)}this.showMoveModal=!0}closeMoveModal(){this.showMoveModal=!1,this.moveNodeId=null,this.moveError=null}performMove(){if(!this.moveNodeId)return;this.movingNode=!0,this.moveError=null;let e={newParentBomId:this.moveTargetParentId||void 0};this.apiService.moveBomNode(this.moveNodeId,e).subscribe({next:()=>{this.movingNode=!1,this.showMoveModal=!1,this.moveNodeId=null,this.loadBomTree()},error:r=>{this.movingNode=!1,this.moveError=r.error?.message||"Failed to move node",console.error("Error moving node:",r)}})}getDescendantIds(e,r){let t=new Set,s=_=>{for(let S of _){if(S.bomId===e)return this.collectChildIds(S,t),!0;if(S.children?.length&&s(S.children))return!0}return!1};return s(r),t}collectChildIds(e,r){if(e.children)for(let t of e.children)r.add(t.bomId),this.collectChildIds(t,r)}flattenNodesForMove(e,r){for(let t of e)r.has(t.bomId)||this.allFlatNodes.push({bomId:t.bomId,materialId:t.materialId,materialName:t.materialName,sequenceLevel:t.sequenceLevel}),t.children?.length&&this.flattenNodesForMove(t.children,r)}ngOnDestroy(){this.chartService.disposeAll()}buildBomFlowChart(){if(!this.bomFlowChartRef||!this.bomTree||this.bomTree.tree.length===0)return;let e=[],r=[],t=new Set,s={1:"#1976d2",2:"#7b1fa2",3:"#388e3c",4:"#f57c00",5:"#00838f"},_="#ef5350",S=`${this.productSku} (Product)`;e.push({name:S,itemStyle:{color:"#0d47a1",borderColor:"#0d47a1"}}),t.add(S);let E=[],x=(h,w)=>{h.forEach(M=>{let k=`${M.materialId} (${M.materialName})`;E.push({node:M,parentName:w}),M.children?.length&&x(M.children,k)})};x(this.bomTree.tree,S),E.forEach(({node:h,parentName:w})=>{let M=`${h.materialId} (${h.materialName})`,k=h.sequenceLevel||1,z=s[k]||"#607d8b",ae=h.quantityRequired,le=h.yieldLossRatio||1,de=ae*le,se=ae-de;if(t.has(M)||(e.push({name:M,itemStyle:{color:z,borderColor:z}}),t.add(M)),r.push({source:M,target:w,value:Math.max(de,.1),lineStyle:{color:z,opacity:.4}}),le<1&&se>.001){let D=`Loss: ${h.materialId}`;t.has(D)||(e.push({name:D,itemStyle:{color:_,borderColor:_}}),t.add(D)),r.push({source:M,target:D,value:Math.max(se,.1),lineStyle:{color:_,opacity:.3}})}});let Wt=this.chartService.initChart(this.bomFlowChartRef.nativeElement,"bom-flow");this.chartService.setOption("bom-flow",{tooltip:{trigger:"item",textStyle:{fontSize:re.tooltip},formatter:h=>{if(h.dataType==="node")return`<b>${h.name}</b>`;if(h.dataType==="edge"){let w=h.data.source,M=h.data.target,k=h.data.value;return M.startsWith("Loss:")?`<b>${w}</b> \u2192 Yield Loss<br/>Loss: ${k.toFixed(2)}`:`<b>${w}</b> \u2192 <b>${M}</b><br/>Qty: ${k.toFixed(2)}`}return""}},series:[{type:"sankey",layout:"none",data:e,links:r,orient:"horizontal",nodeAlign:"justify",layoutIterations:32,nodeWidth:20,nodeGap:14,label:{show:!0,fontSize:re.label,color:"#333",formatter:h=>{if(h.name.startsWith("Loss:"))return h.name.replace("Loss: ","\u26A0 ");let w=h.name.match(/^([^(]+)/);return w?w[1].trim():h.name}},emphasis:{focus:"adjacency"},lineStyle:{curveness:.5,color:"source"}}]})}static{this.\u0275fac=function(r){return new(r||n)(y(G),y(V),y(F),y(ke))}}static{this.\u0275cmp=P({type:n,selectors:[["app-bom-tree"]],viewQuery:function(r,t){if(r&1&&me(Ue,5),r&2){let s;pe(s=ue())&&(t.bomFlowChartRef=s.first)}},decls:26,vars:10,consts:[["treeNode",""],["bomFlowChart",""],[1,"bom-tree-container"],[1,"page-header"],[1,"header-left"],[1,"btn","btn-back",3,"click"],[1,"title-section"],[1,"page-title"],["class","tree-meta",4,"ngIf"],[1,"header-actions"],["class","btn btn-secondary",3,"click",4,"ngIf"],[1,"btn","btn-secondary",3,"click"],[1,"btn","btn-primary",3,"click"],["class","loading",4,"ngIf"],["class","error-message",4,"ngIf"],["class","card bom-flow-section",4,"ngIf"],["class","tree-content",4,"ngIf"],["class","modal-overlay",3,"click",4,"ngIf"],[1,"tree-meta"],["class","tree-status",4,"ngIf"],[1,"tree-status"],[1,"status-badge",3,"ngClass"],[1,"loading"],[1,"error-message"],[1,"card","bom-flow-section"],[1,"bom-flow-header"],[1,"bom-flow-container"],[1,"tree-content"],["class","empty-state",4,"ngIf"],["class","tree-view",4,"ngIf"],[1,"empty-state"],[1,"tree-view"],[4,"ngFor","ngForOf"],[4,"ngTemplateOutlet","ngTemplateOutletContext"],[1,"modal-overlay",3,"click"],[1,"modal",3,"click"],[1,"modal-actions"],[1,"btn","btn-danger",3,"click"],[1,"btn","btn-danger-outline",3,"click"],[1,"modal","settings-modal",3,"click"],[1,"modal-subtitle"],[1,"form-group"],["for","bomProduct"],["id","bomProduct",1,"form-control",3,"ngModelChange","ngModel"],[3,"value"],[3,"value","hidden",4,"ngFor","ngForOf"],["class","form-hint",4,"ngIf"],["for","bomVersion"],["type","text","id","bomVersion","placeholder","e.g., V1, V2",1,"form-control",3,"ngModelChange","ngModel"],["for","bomStatus"],["id","bomStatus",1,"form-control",3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],[1,"btn","btn-secondary",3,"click","disabled"],[1,"btn","btn-primary",3,"click","disabled"],[3,"value","hidden"],[1,"form-hint"],["for","moveTarget"],["id","moveTarget",1,"form-control",3,"ngModelChange","ngModel"],[3,"ngValue"],[3,"ngValue",4,"ngFor","ngForOf"],[1,"tree-node"],[1,"node-content"],["class","expand-btn",3,"click",4,"ngIf"],["class","expand-placeholder",4,"ngIf"],[1,"node-info",3,"click"],[1,"material-id"],[1,"material-name"],[1,"quantity"],["class","yield",4,"ngIf"],[1,"level-badge"],[1,"node-actions"],["title","Add Child",1,"btn-text",3,"click"],["title","Move",1,"btn-text",3,"click"],["title","Edit",1,"btn-text",3,"click"],["title","Delete",1,"btn-text","btn-delete",3,"click"],["class","children",4,"ngIf"],[1,"expand-btn",3,"click"],[1,"expand-placeholder"],[1,"yield"],[1,"children"]],template:function(r,t){if(r&1){let s=b();o(0,"div",2)(1,"div",3)(2,"div",4)(3,"button",5),f("click",function(){return p(s),u(t.goBack())}),a(4," \u2190 Back "),i(),o(5,"div",6)(6,"h1",7),a(7),i(),g(8,Ze,3,4,"div",8),i()(),o(9,"div",9),g(10,Je,2,0,"button",10),o(11,"button",11),f("click",function(){return p(s),u(t.expandAll())}),a(12,"Expand All"),i(),o(13,"button",11),f("click",function(){return p(s),u(t.collapseAll())}),a(14,"Collapse All"),i(),o(15,"button",12),f("click",function(){return p(s),u(t.addRootNode())}),a(16,"+ Add Node"),i()()(),g(17,Xe,2,0,"div",13)(18,et,4,1,"div",14)(19,tt,5,0,"div",15)(20,at,3,2,"div",16)(21,lt,13,0,"div",17),i(),g(22,pt,29,12,"div",17)(23,ft,19,7,"div",17)(24,St,26,15,"ng-template",null,0,_e)}r&2&&(l(7),v("BOM Tree: ",t.productSku,""),l(),d("ngIf",t.bomTree),l(2),d("ngIf",t.bomTree&&t.bomTree.tree.length>0),l(7),d("ngIf",t.loading),l(),d("ngIf",t.error),l(),d("ngIf",!t.loading&&!t.error&&t.bomTree&&t.bomTree.tree.length>0),l(),d("ngIf",!t.loading&&!t.error&&t.bomTree),l(),d("ngIf",t.deleteConfirmId!==null),l(),d("ngIf",t.showEditSettingsModal),l(),d("ngIf",t.showMoveModal))},dependencies:[Q,B,N,xe,H,Z,U,Y,K,be],styles:[".bom-tree-container[_ngcontent-%COMP%]{padding:24px}.page-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;flex-wrap:wrap;gap:16px}.header-left[_ngcontent-%COMP%]{display:flex;align-items:flex-start;gap:16px}.btn-back[_ngcontent-%COMP%]{background:#f1f5f9;color:#475569;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}.btn-back[_ngcontent-%COMP%]:hover{background:#e2e8f0}.title-section[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin:0 0 4px;font-size:24px;font-weight:600;color:#1e293b}.tree-meta[_ngcontent-%COMP%]{font-size:14px;color:#64748b;display:flex;align-items:center;flex-wrap:wrap;gap:4px}.tree-status[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:4px}.tree-meta[_ngcontent-%COMP%]   .status-badge[_ngcontent-%COMP%]{margin-left:4px}.header-actions[_ngcontent-%COMP%]{display:flex;gap:8px}.loading[_ngcontent-%COMP%]{text-align:center;padding:48px;color:#64748b}.error-message[_ngcontent-%COMP%]{background:#fef2f2;border:1px solid #fecaca;color:#dc2626;padding:16px;border-radius:8px;display:flex;justify-content:space-between;align-items:center}.empty-state[_ngcontent-%COMP%]{text-align:center;padding:48px;background:#f8fafc;border-radius:8px;border:2px dashed #e2e8f0}.empty-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:#64748b;margin-bottom:16px}.bom-flow-section[_ngcontent-%COMP%]{background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:16px}.bom-flow-header[_ngcontent-%COMP%]{font-size:16px;font-weight:500;color:#1e293b;margin-bottom:8px}.bom-flow-container[_ngcontent-%COMP%]{width:100%;height:400px;border:1px solid #f1f5f9;border-radius:6px;background:#fafafa}.tree-content[_ngcontent-%COMP%]{background:#fff;border:1px solid #e2e8f0;border-radius:8px}.tree-view[_ngcontent-%COMP%]{padding:16px;overflow-x:auto}.tree-node[_ngcontent-%COMP%]{border-bottom:1px solid #f1f5f9}.tree-node[_ngcontent-%COMP%]:last-child{border-bottom:none}.tree-node.selected[_ngcontent-%COMP%] > .node-content[_ngcontent-%COMP%]{background:#eff6ff}.node-content[_ngcontent-%COMP%]{display:flex;align-items:center;padding:12px 16px;gap:8px;transition:background-color .15s}.node-content[_ngcontent-%COMP%]:hover{background:#f8fafc}.expand-btn[_ngcontent-%COMP%]{width:24px;height:24px;border:none;background:transparent;cursor:pointer;font-size:16px;color:#64748b;display:flex;align-items:center;justify-content:center;flex-shrink:0}.expand-btn[_ngcontent-%COMP%]:hover{color:#1e293b}.expand-placeholder[_ngcontent-%COMP%]{width:24px;flex-shrink:0}.node-info[_ngcontent-%COMP%]{flex:1;display:flex;align-items:center;gap:12px;cursor:pointer}.material-id[_ngcontent-%COMP%]{font-family:monospace;font-weight:600;color:#3b82f6;min-width:120px}.material-name[_ngcontent-%COMP%]{flex:1;color:#1e293b}.quantity[_ngcontent-%COMP%]{font-weight:500;color:#475569;min-width:80px;text-align:right}.yield[_ngcontent-%COMP%]{font-size:12px;color:#64748b}.level-badge[_ngcontent-%COMP%]{background:#e2e8f0;color:#475569;padding:2px 8px;border-radius:4px;font-size:12px;font-weight:500}.status-badge[_ngcontent-%COMP%]{padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;text-transform:uppercase}.status-badge.status-active[_ngcontent-%COMP%]{background:#dcfce7;color:#166534}.status-badge.status-inactive[_ngcontent-%COMP%]{background:#f1f5f9;color:#64748b}.status-badge.status-draft[_ngcontent-%COMP%]{background:#fef3c7;color:#92400e}.status-badge.status-obsolete[_ngcontent-%COMP%]{background:#fee2e2;color:#991b1b}.node-actions[_ngcontent-%COMP%]{display:flex;gap:4px}.btn-text[_ngcontent-%COMP%]{padding:4px 10px;border:1px solid #e2e8f0;background:#fff;border-radius:4px;cursor:pointer;font-size:12px;font-weight:500;color:#475569;white-space:nowrap}.btn-text[_ngcontent-%COMP%]:hover{background:#f1f5f9;color:#1e293b}.btn-text.btn-delete[_ngcontent-%COMP%]{color:#dc2626;border-color:#fecaca}.btn-text.btn-delete[_ngcontent-%COMP%]:hover{background:#fef2f2}.children[_ngcontent-%COMP%]{border-left:2px solid #e2e8f0;margin-left:28px}.btn[_ngcontent-%COMP%]{padding:8px 16px;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;border:none;transition:background-color .2s;display:inline-flex;align-items:center;gap:6px}.btn-primary[_ngcontent-%COMP%]{background:#3b82f6;color:#fff}.btn-primary[_ngcontent-%COMP%]:hover{background:#2563eb}.btn-secondary[_ngcontent-%COMP%]{background:#f1f5f9;color:#475569}.btn-secondary[_ngcontent-%COMP%]:hover{background:#e2e8f0}.btn-danger[_ngcontent-%COMP%]{background:#dc2626;color:#fff}.btn-danger[_ngcontent-%COMP%]:hover{background:#b91c1c}.btn-danger-outline[_ngcontent-%COMP%]{background:#fff;color:#dc2626;border:1px solid #dc2626}.btn-danger-outline[_ngcontent-%COMP%]:hover{background:#fef2f2}.modal-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;background:#00000080;display:flex;align-items:center;justify-content:center;z-index:1000}.modal[_ngcontent-%COMP%]{background:#fff;padding:24px;border-radius:8px;max-width:480px;width:90%}.modal[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 16px;color:#1e293b}.modal[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:#64748b;margin-bottom:24px}.modal-actions[_ngcontent-%COMP%]{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}.settings-modal[_ngcontent-%COMP%]{min-width:400px}.modal-subtitle[_ngcontent-%COMP%]{font-size:14px;margin-bottom:20px}.form-group[_ngcontent-%COMP%]{margin-bottom:16px}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:block;margin-bottom:6px;font-weight:500;color:#374151;font-size:14px}.form-control[_ngcontent-%COMP%]{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;color:#1f2937;box-sizing:border-box}.form-control[_ngcontent-%COMP%]:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px #3b82f61a}.settings-modal[_ngcontent-%COMP%]   .error-message[_ngcontent-%COMP%]{margin-bottom:16px;padding:10px;background:#fef2f2;border:1px solid #fecaca;border-radius:6px;color:#dc2626;font-size:14px}.btn[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.form-hint[_ngcontent-%COMP%]{display:block;margin-top:4px;font-size:12px;color:#d97706}"]})}}return n})();function Mt(n,c){if(n&1&&(o(0,"div",7),a(1),i()),n&2){let e=m();l(),v(" Product: ",e.productSku," ")}}function yt(n,c){n&1&&(o(0,"div",8),a(1," Loading node details... "),i())}function Tt(n,c){if(n&1&&(o(0,"div",9),a(1),i()),n&2){let e=m();l(),v(" ",e.error," ")}}function It(n,c){if(n&1&&(o(0,"option",43),a(1),i()),n&2){let e=c.$implicit;d("value",e.sku),l(),O(" ",e.sku," - ",e.productName," ")}}function wt(n,c){n&1&&(o(0,"div",44),a(1," Product selection is required "),i())}function Et(n,c){n&1&&(o(0,"div",44),a(1," No products available. Please create a product first. "),i())}function kt(n,c){if(n&1&&(o(0,"div",12)(1,"h3"),a(2,"Select Product"),i(),o(3,"p",39),a(4,"Choose the product this BOM will define."),i(),o(5,"div",13)(6,"div",40)(7,"label",41),a(8,"Product *"),i(),o(9,"select",42)(10,"option",17),a(11,"-- Select a Product --"),i(),g(12,It,2,3,"option",18),i(),g(13,wt,2,0,"div",22)(14,Et,2,0,"div",22),i()()()),n&2){let e,r,t=m(2);l(9),W("error",((e=t.form.get("productSku"))==null?null:e.touched)&&((e=t.form.get("productSku"))==null||e.errors==null?null:e.errors.required)),l(3),d("ngForOf",t.products),l(),d("ngIf",((r=t.form.get("productSku"))==null?null:r.touched)&&((r=t.form.get("productSku"))==null||r.errors==null?null:r.errors.required)),l(),d("ngIf",t.products.length===0)}}function Pt(n,c){if(n&1&&(o(0,"option",43),a(1),i()),n&2){let e=c.$implicit;d("value",e.materialCode),l(),O(" ",e.materialCode," - ",e.materialName," ")}}function Ot(n,c){n&1&&(o(0,"div",44),a(1," Material ID is required "),i())}function Bt(n,c){n&1&&(o(0,"div",44),a(1," Material Name is required "),i())}function Nt(n,c){n&1&&(o(0,"div",44),a(1," Quantity is required "),i())}function Vt(n,c){n&1&&(o(0,"div",44),a(1," Quantity must be greater than 0 "),i())}function Ft(n,c){if(n&1&&(o(0,"option",43),a(1),i()),n&2){let e=c.$implicit;d("value",e),l(),C(e)}}function Lt(n,c){n&1&&(o(0,"div",44),a(1," Unit is required "),i())}function qt(n,c){n&1&&(o(0,"div",44),a(1," Yield loss ratio must be at least 0.01 "),i())}function Rt(n,c){n&1&&(o(0,"div",44),a(1," Sequence level is required "),i())}function At(n,c){if(n&1&&(o(0,"div",45)(1,"strong"),a(2,"Parent Node ID:"),i(),a(3),i()),n&2){let e=m(2);l(3),v(" ",e.parentBomId," ")}}function zt(n,c){if(n&1&&(o(0,"div",14)(1,"label"),a(2,"BOM ID"),i(),o(3,"div",52),a(4),i()()),n&2){let e=m(3);l(4),C(e.bomId)}}function Dt(n,c){if(n&1&&(o(0,"div",12)(1,"h3"),a(2,"Status"),i(),o(3,"div",13)(4,"div",14)(5,"label",46),a(6,"Status"),i(),o(7,"select",47)(8,"option",48),a(9,"Active"),i(),o(10,"option",49),a(11,"Inactive"),i(),o(12,"option",50),a(13,"Draft"),i(),o(14,"option",51),a(15,"Obsolete"),i()(),o(16,"small",19),a(17,"Change status to deactivate this BOM node"),i()(),o(18,"div",14)(19,"label"),a(20,"Product SKU"),i(),o(21,"div",52),a(22),i(),o(23,"small",19),a(24,"Product cannot be changed after creation"),i()(),g(25,zt,5,1,"div",53),i()()),n&2){let e=m(2);l(22),C(e.productSku),l(3),d("ngIf",e.bomId)}}function $t(n,c){if(n&1){let e=b();o(0,"form",10),f("ngSubmit",function(){p(e);let t=m();return u(t.onSubmit())}),g(1,kt,15,5,"div",11),o(2,"div",12)(3,"h3"),a(4,"Material Information"),i(),o(5,"div",13)(6,"div",14)(7,"label",15),a(8,"Select Material"),i(),o(9,"select",16),f("change",function(t){p(e);let s=m();return u(s.onMaterialSelect(t))}),o(10,"option",17),a(11,"-- Select from Master Data --"),i(),g(12,Pt,2,3,"option",18),i(),o(13,"small",19),a(14,"Or enter manually below"),i()()(),o(15,"div",13)(16,"div",14)(17,"label",20),a(18,"Material ID *"),i(),T(19,"input",21),g(20,Ot,2,0,"div",22),i(),o(21,"div",14)(22,"label",23),a(23,"Material Name *"),i(),T(24,"input",24),g(25,Bt,2,0,"div",22),i()()(),o(26,"div",12)(27,"h3"),a(28,"Quantity & Unit"),i(),o(29,"div",13)(30,"div",14)(31,"label",25),a(32,"Quantity Required *"),i(),T(33,"input",26),g(34,Nt,2,0,"div",22)(35,Vt,2,0,"div",22),i(),o(36,"div",14)(37,"label",27),a(38,"Unit *"),i(),o(39,"select",28),g(40,Ft,2,2,"option",18),i(),g(41,Lt,2,0,"div",22),i(),o(42,"div",14)(43,"label",29),a(44,"Yield Loss Ratio"),i(),T(45,"input",30),o(46,"small",19),a(47,"1.0 = no loss, 1.05 = 5% extra needed"),i(),g(48,qt,2,0,"div",22),i()()(),o(49,"div",12)(50,"h3"),a(51,"Hierarchy & Version"),i(),o(52,"div",13)(53,"div",14)(54,"label",31),a(55,"Sequence Level *"),i(),T(56,"input",32),o(57,"small",19),a(58,"1 = Root level, 2+ = Sub-levels"),i(),g(59,Rt,2,0,"div",22),i(),o(60,"div",14)(61,"label",33),a(62,"BOM Version"),i(),T(63,"input",34),i()(),g(64,At,4,1,"div",35),i(),g(65,Dt,26,2,"div",11),o(66,"div",36)(67,"button",37),f("click",function(){p(e);let t=m();return u(t.cancel())}),a(68," Cancel "),i(),o(69,"button",38),a(70),i()()()}if(n&2){let e,r,t,s,_,S,E,x=m();d("formGroup",x.form),l(),d("ngIf",x.isNewBom),l(11),d("ngForOf",x.materials),l(8),d("ngIf",((e=x.form.get("materialId"))==null?null:e.touched)&&((e=x.form.get("materialId"))==null||e.errors==null?null:e.errors.required)),l(5),d("ngIf",((r=x.form.get("materialName"))==null?null:r.touched)&&((r=x.form.get("materialName"))==null||r.errors==null?null:r.errors.required)),l(9),d("ngIf",((t=x.form.get("quantityRequired"))==null?null:t.touched)&&((t=x.form.get("quantityRequired"))==null||t.errors==null?null:t.errors.required)),l(),d("ngIf",((s=x.form.get("quantityRequired"))==null?null:s.touched)&&((s=x.form.get("quantityRequired"))==null||s.errors==null?null:s.errors.min)),l(5),d("ngForOf",x.units),l(),d("ngIf",((_=x.form.get("unit"))==null?null:_.touched)&&((_=x.form.get("unit"))==null||_.errors==null?null:_.errors.required)),l(7),d("ngIf",((S=x.form.get("yieldLossRatio"))==null?null:S.touched)&&((S=x.form.get("yieldLossRatio"))==null||S.errors==null?null:S.errors.min)),l(11),d("ngIf",((E=x.form.get("sequenceLevel"))==null?null:E.touched)&&((E=x.form.get("sequenceLevel"))==null||E.errors==null?null:E.errors.required)),l(5),d("ngIf",x.parentBomId),l(),d("ngIf",x.isEditMode),l(4),d("disabled",x.saving||x.form.invalid),l(),v(" ",x.saving?"Saving...":x.isEditMode?"Update Node":"Create Node"," ")}}var X=(()=>{class n{constructor(e,r,t,s){this.fb=e,this.route=r,this.router=t,this.apiService=s,this.productSku="",this.bomId=null,this.parentBomId=null,this.isEditMode=!1,this.isNewBom=!1,this.loading=!1,this.loadingNode=!1,this.saving=!1,this.error=null,this.materials=[],this.products=[],this.units=["KG","T","PCS","M","L","MT"],this.form=this.fb.group({productSku:[""],materialId:["",[I.required]],materialName:["",[I.required]],quantityRequired:[1,[I.required,I.min(1e-4)]],unit:["KG",[I.required]],yieldLossRatio:[1,[I.min(.01)]],sequenceLevel:[1,[I.required,I.min(1)]],bomVersion:["V1"],status:["ACTIVE"]})}ngOnInit(){this.route.params.subscribe(e=>{this.productSku=e.productSku||"",this.bomId=e.bomId?+e.bomId:null,this.isEditMode=!!this.bomId,this.isNewBom=!this.productSku}),this.route.queryParams.subscribe(e=>{this.parentBomId=e.parentId?+e.parentId:null,this.parentBomId&&this.loadParentInfo()}),this.loadMaterials(),this.isNewBom&&(this.form.get("productSku")?.setValidators([I.required]),this.form.get("productSku")?.updateValueAndValidity(),this.loadProducts()),this.isEditMode&&this.bomId&&this.loadNode()}loadMaterials(){this.apiService.getActiveMaterials().subscribe({next:e=>{this.materials=e},error:e=>{console.error("Error loading materials:",e)}})}loadProducts(){this.apiService.getActiveProducts().subscribe({next:e=>{this.products=e},error:e=>{console.error("Error loading products:",e)}})}loadParentInfo(){this.parentBomId&&this.apiService.getBomNode(this.parentBomId).subscribe({next:e=>{this.form.patchValue({sequenceLevel:e.sequenceLevel+1,bomVersion:e.bomVersion})},error:e=>{console.error("Error loading parent node:",e)}})}loadNode(){this.bomId&&(this.loadingNode=!0,this.apiService.getBomNode(this.bomId).subscribe({next:e=>{this.form.patchValue({materialId:e.materialId,materialName:e.materialName,quantityRequired:e.quantityRequired,unit:e.unit,yieldLossRatio:e.yieldLossRatio||1,sequenceLevel:e.sequenceLevel,bomVersion:e.bomVersion,status:e.status||"ACTIVE"}),this.parentBomId=e.parentBomId||null,this.loadingNode=!1},error:e=>{this.error="Failed to load BOM node",this.loadingNode=!1,console.error("Error loading node:",e)}}))}onMaterialSelect(e){let t=e.target.value,s=this.materials.find(_=>_.materialCode===t);s&&this.form.patchValue({materialId:s.materialCode,materialName:s.materialName,unit:s.baseUnit||"KG"})}onSubmit(){if(this.form.invalid){this.form.markAllAsTouched();return}this.saving=!0,this.error=null,this.isEditMode&&this.bomId?this.updateNode():this.createNode()}createNode(){let e=this.productSku;if(this.isNewBom){let t=this.form.value.productSku;if(!t){this.error="Please select a product for the BOM",this.saving=!1;return}e=t}let r={productSku:e,bomVersion:this.form.value.bomVersion,materialId:this.form.value.materialId,materialName:this.form.value.materialName,quantityRequired:this.form.value.quantityRequired,unit:this.form.value.unit,yieldLossRatio:this.form.value.yieldLossRatio,sequenceLevel:this.form.value.sequenceLevel,parentBomId:this.parentBomId||void 0};this.apiService.createBomNode(r).subscribe({next:t=>{this.saving=!1,this.router.navigate(["/manage/bom",t.productSku,"tree"])},error:t=>{this.saving=!1,this.error=t.error?.message||"Failed to create BOM node",console.error("Error creating node:",t)}})}updateNode(){if(!this.bomId)return;let e={materialId:this.form.value.materialId,materialName:this.form.value.materialName,quantityRequired:this.form.value.quantityRequired,unit:this.form.value.unit,yieldLossRatio:this.form.value.yieldLossRatio,sequenceLevel:this.form.value.sequenceLevel,status:this.form.value.status};this.apiService.updateBomNode(this.bomId,e).subscribe({next:()=>{this.saving=!1,this.router.navigate(["/manage/bom",this.productSku,"tree"])},error:r=>{this.saving=!1,this.error=r.error?.message||"Failed to update BOM node",console.error("Error updating node:",r)}})}cancel(){this.productSku&&!this.isNewBom?this.router.navigate(["/manage/bom",this.productSku,"tree"]):this.router.navigate(["/manage/bom"])}get title(){return this.isEditMode?"Edit BOM Node":this.isNewBom?"Create New BOM":this.parentBomId?"Add Child Node":"Add BOM Node"}static{this.\u0275fac=function(r){return new(r||n)(y(Ie),y(G),y(V),y(F))}}static{this.\u0275cmp=P({type:n,selectors:[["app-bom-node-form"]],decls:8,vars:5,consts:[[1,"bom-form-container"],[1,"page-header"],[1,"page-title"],["class","subtitle",4,"ngIf"],["class","loading",4,"ngIf"],["class","error-message",4,"ngIf"],["class","form-card",3,"formGroup","ngSubmit",4,"ngIf"],[1,"subtitle"],[1,"loading"],[1,"error-message"],[1,"form-card",3,"ngSubmit","formGroup"],["class","form-section",4,"ngIf"],[1,"form-section"],[1,"form-row"],[1,"form-group"],["for","materialSelect"],["id","materialSelect",1,"form-control",3,"change"],["value",""],[3,"value",4,"ngFor","ngForOf"],[1,"hint"],["for","materialId"],["type","text","id","materialId","formControlName","materialId","placeholder","e.g., RM-IRON-001",1,"form-control"],["class","error",4,"ngIf"],["for","materialName"],["type","text","id","materialName","formControlName","materialName","placeholder","e.g., Iron Ore",1,"form-control"],["for","quantityRequired"],["type","number","id","quantityRequired","formControlName","quantityRequired","step","0.0001","min","0.0001",1,"form-control"],["for","unit"],["id","unit","formControlName","unit",1,"form-control"],["for","yieldLossRatio"],["type","number","id","yieldLossRatio","formControlName","yieldLossRatio","step","0.01","min","0.01",1,"form-control"],["for","sequenceLevel"],["type","number","id","sequenceLevel","formControlName","sequenceLevel","min","1",1,"form-control"],["for","bomVersion"],["type","text","id","bomVersion","formControlName","bomVersion","placeholder","V1",1,"form-control"],["class","parent-info",4,"ngIf"],[1,"form-actions"],["type","button",1,"btn","btn-secondary",3,"click"],["type","submit",1,"btn","btn-primary",3,"disabled"],[1,"section-hint"],[1,"form-group","full-width"],["for","productSelect"],["id","productSelect","formControlName","productSku",1,"form-control"],[3,"value"],[1,"error"],[1,"parent-info"],["for","status"],["id","status","formControlName","status",1,"form-control"],["value","ACTIVE"],["value","INACTIVE"],["value","DRAFT"],["value","OBSOLETE"],[1,"readonly-value"],["class","form-group",4,"ngIf"]],template:function(r,t){r&1&&(o(0,"div",0)(1,"div",1)(2,"h1",2),a(3),i(),g(4,Mt,2,1,"div",3),i(),g(5,yt,2,0,"div",4)(6,Tt,2,1,"div",5)(7,$t,71,15,"form",6),i()),r&2&&(l(3),C(t.title),l(),d("ngIf",t.productSku&&t.productSku!=="new"),l(),d("ngIf",t.loadingNode),l(),d("ngIf",t.error),l(),d("ngIf",!t.loadingNode))},dependencies:[B,N,Ce,H,Z,U,Se,Y,K,ve,Te,Me,ye],styles:[`.bom-form-container[_ngcontent-%COMP%]{padding:24px;max-width:800px;margin:0 auto}.page-header[_ngcontent-%COMP%]{margin-bottom:24px}.page-header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin:0 0 4px;font-size:24px;font-weight:600;color:#1e293b}.subtitle[_ngcontent-%COMP%]{font-size:14px;color:#64748b}.loading[_ngcontent-%COMP%]{text-align:center;padding:48px;color:#64748b}.error-message[_ngcontent-%COMP%]{background:#fef2f2;border:1px solid #fecaca;color:#dc2626;padding:16px;border-radius:8px;margin-bottom:16px}.form-card[_ngcontent-%COMP%]{background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:24px}.form-section[_ngcontent-%COMP%]{margin-bottom:24px;padding-bottom:24px;border-bottom:1px solid #f1f5f9}.form-section[_ngcontent-%COMP%]:last-of-type{border-bottom:none}.form-section[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 16px;font-size:16px;font-weight:600;color:#1e293b}.form-row[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}.form-group[_ngcontent-%COMP%]{display:flex;flex-direction:column}.form-group.full-width[_ngcontent-%COMP%]{grid-column:1 / -1}.section-hint[_ngcontent-%COMP%]{font-size:14px;color:#64748b;margin:-8px 0 16px}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{font-size:14px;font-weight:500;color:#374151;margin-bottom:6px}.form-control[_ngcontent-%COMP%]{padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;transition:border-color .2s,box-shadow .2s}.form-control[_ngcontent-%COMP%]:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px #3b82f61a}.form-control[_ngcontent-%COMP%]:disabled{background:#f9fafb;cursor:not-allowed}.hint[_ngcontent-%COMP%]{font-size:12px;color:#64748b;margin-top:4px}.error[_ngcontent-%COMP%]{font-size:12px;color:#dc2626;margin-top:4px}.parent-info[_ngcontent-%COMP%]{background:#f1f5f9;padding:12px;border-radius:6px;font-size:14px;color:#475569;margin-top:16px}.readonly-value[_ngcontent-%COMP%]{padding:10px 12px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;font-size:14px;color:#374151;font-family:ui-monospace,monospace}.form-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:12px;margin-top:24px;padding-top:24px;border-top:1px solid #e2e8f0}.btn[_ngcontent-%COMP%]{padding:10px 20px;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;border:none;transition:background-color .2s;display:inline-flex;align-items:center;gap:6px}.btn-primary[_ngcontent-%COMP%]{background:#3b82f6;color:#fff}.btn-primary[_ngcontent-%COMP%]:hover:not(:disabled){background:#2563eb}.btn-primary[_ngcontent-%COMP%]:disabled{background:#93c5fd;cursor:not-allowed}.btn-secondary[_ngcontent-%COMP%]{background:#f1f5f9;color:#475569}.btn-secondary[_ngcontent-%COMP%]:hover{background:#e2e8f0}select.form-control[_ngcontent-%COMP%]{appearance:none;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");background-position:right 8px center;background-repeat:no-repeat;background-size:16px 12px;padding-right:32px}`]})}}return n})();var jt=[{path:"",component:Fe},{path:"create",component:X},{path:":productSku/tree",component:Le},{path:":productSku/node/new",component:X},{path:":productSku/node/:bomId/edit",component:X}],qe=(()=>{class n{static{this.\u0275fac=function(r){return new(r||n)}}static{this.\u0275mod=j({type:n})}static{this.\u0275inj=$({imports:[A.forChild(jt),A]})}}return n})();var _n=(()=>{class n{static{this.\u0275fac=function(r){return new(r||n)}}static{this.\u0275mod=j({type:n})}static{this.\u0275inj=$({imports:[he,we,Ee,A,qe,Oe]})}}return n})();export{_n as BomModule};
