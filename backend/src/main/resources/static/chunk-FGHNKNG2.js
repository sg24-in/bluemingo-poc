import{a as re,b as Ee}from"./chunk-TFMFD3ZS.js";import{c as F}from"./chunk-7PFTDUA2.js";import"./chunk-ZJBKTRW2.js";import{$ as _e,A as i,Aa as Y,B as I,Ba as be,C as ee,Ca as he,D as te,Da as Ce,E as ne,Ea as Se,F as h,G as g,Ga as Me,H as m,I as me,J as pe,Ja as ye,K as ue,Ka as K,L as ie,La as H,M as r,Ma as J,N as C,O as b,Oa as Ie,P as B,Q as oe,Qa as Te,Ra as we,S as q,Sa as ke,T as L,U as R,W as fe,X as ge,ba as Q,ca as N,da as P,ea as xe,g as $,i as O,j,ja as ve,l as p,m as u,q as l,qa as G,r as y,sa as V,t as f,v as d,va as A,w as ce,x as W,ya as U,z as o,za as T}from"./chunk-437FR4PU.js";function qe(n,s){n&1&&(o(0,"div",7),r(1," Loading BOM products... "),i())}function Le(n,s){if(n&1){let e=h();o(0,"div",8),r(1),o(2,"button",9),g("click",function(){p(e);let t=m();return u(t.loadProducts())}),r(3,"Retry"),i()()}if(n&2){let e=m();l(),b(" ",e.error," ")}}function Re(n,s){if(n&1){let e=h();o(0,"div",10)(1,"p"),r(2,"No BOMs defined yet."),i(),o(3,"button",2),g("click",function(){p(e);let t=m();return u(t.createNewBom())}),r(4,"+ Create First BOM"),i()()}}function Ae(n,s){if(n&1){let e=h();o(0,"div",13)(1,"div",14)(2,"h3"),r(3),i(),o(4,"span",15),r(5),i()(),o(6,"div",16)(7,"div",17)(8,"span",18),r(9,"Version"),i(),o(10,"span",19),r(11),i()(),o(12,"div",17)(13,"span",18),r(14,"Total Nodes"),i(),o(15,"span",19),r(16),i()(),o(17,"div",17)(18,"span",18),r(19,"Max Level"),i(),o(20,"span",19),r(21),i()()(),o(22,"div",20)(23,"button",9),g("click",function(){let t=p(e).$implicit,c=m(2);return u(c.viewTree(t.productSku))}),r(24," View Tree "),i(),o(25,"button",2),g("click",function(){let t=p(e).$implicit,c=m(2);return u(c.addNode(t.productSku))}),r(26," + Add Node "),i()()()}if(n&2){let e=s.$implicit,a=m(2);l(3),C(e.productSku),l(),d("ngClass",a.getStatusClass(e.status)),l(),b(" ",e.status," "),l(6),C(e.bomVersion),l(5),C(e.totalNodes),l(5),C(e.maxLevel)}}function ze(n,s){if(n&1&&(o(0,"div",11),f(1,Ae,27,6,"div",12),i()),n&2){let e=m();l(),d("ngForOf",e.products)}}var Pe=(()=>{class n{constructor(e,a){this.apiService=e,this.router=a,this.products=[],this.loading=!0,this.error=null}ngOnInit(){this.loadProducts()}loadProducts(){this.loading=!0,this.error=null,this.apiService.getBomProducts().subscribe({next:e=>{this.products=e,this.loading=!1},error:e=>{this.error="Failed to load BOM products",this.loading=!1,console.error("Error loading BOM products:",e)}})}viewTree(e){this.router.navigate(["/manage/bom",e,"tree"])}addNode(e){this.router.navigate(["/manage/bom",e,"node","new"])}createNewBom(){this.router.navigate(["/manage/bom","create"])}getStatusClass(e){switch(e?.toUpperCase()){case"ACTIVE":return"status-active";case"EMPTY":return"status-empty";case"INACTIVE":return"status-inactive";case"DRAFT":return"status-draft";case"OBSOLETE":return"status-obsolete";default:return""}}static{this.\u0275fac=function(a){return new(a||n)(y(F),y(V))}}static{this.\u0275cmp=O({type:n,selectors:[["app-bom-list"]],decls:10,vars:4,consts:[[1,"bom-list-container"],[1,"page-header"],[1,"btn","btn-primary",3,"click"],["class","loading",4,"ngIf"],["class","error-message",4,"ngIf"],["class","empty-state",4,"ngIf"],["class","products-grid",4,"ngIf"],[1,"loading"],[1,"error-message"],[1,"btn","btn-secondary",3,"click"],[1,"empty-state"],[1,"products-grid"],["class","product-card",4,"ngFor","ngForOf"],[1,"product-card"],[1,"card-header"],[1,"status-badge",3,"ngClass"],[1,"card-body"],[1,"stat"],[1,"stat-label"],[1,"stat-value"],[1,"card-actions"]],template:function(a,t){a&1&&(o(0,"div",0)(1,"div",1)(2,"h1"),r(3,"Bill of Materials"),i(),o(4,"button",2),g("click",function(){return t.createNewBom()}),r(5," + New BOM "),i()(),f(6,qe,2,0,"div",3)(7,Le,4,1,"div",4)(8,Re,5,0,"div",5)(9,ze,2,1,"div",6),i()),a&2&&(l(6),d("ngIf",t.loading),l(),d("ngIf",t.error),l(),d("ngIf",!t.loading&&!t.error&&t.products.length===0),l(),d("ngIf",!t.loading&&!t.error&&t.products.length>0))},dependencies:[Q,N,P],styles:[".bom-list-container[_ngcontent-%COMP%]{padding:24px}.page-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}.page-header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin:0;font-size:24px;font-weight:600;color:#1e293b}.loading[_ngcontent-%COMP%]{text-align:center;padding:48px;color:#64748b}.error-message[_ngcontent-%COMP%]{background:#fef2f2;border:1px solid #fecaca;color:#dc2626;padding:16px;border-radius:8px;display:flex;justify-content:space-between;align-items:center}.empty-state[_ngcontent-%COMP%]{text-align:center;padding:48px;background:#f8fafc;border-radius:8px;border:2px dashed #e2e8f0}.empty-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:#64748b;margin-bottom:16px}.products-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:24px}.product-card[_ngcontent-%COMP%]{background:#fff;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden;transition:box-shadow .2s}.product-card[_ngcontent-%COMP%]:hover{box-shadow:0 4px 12px #0000001a}.card-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:16px;background:#f8fafc;border-bottom:1px solid #e2e8f0}.card-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;font-size:16px;font-weight:600;color:#1e293b}.status-badge[_ngcontent-%COMP%]{padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500;text-transform:uppercase}.status-active[_ngcontent-%COMP%]{background:#dcfce7;color:#16a34a}.status-empty[_ngcontent-%COMP%]{background:#fef3c7;color:#d97706}.status-inactive[_ngcontent-%COMP%]{background:#f1f5f9;color:#64748b}.status-draft[_ngcontent-%COMP%]{background:#fef3c7;color:#92400e}.status-obsolete[_ngcontent-%COMP%]{background:#fee2e2;color:#991b1b}.card-body[_ngcontent-%COMP%]{padding:16px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px}.stat[_ngcontent-%COMP%]{text-align:center}.stat-label[_ngcontent-%COMP%]{display:block;font-size:12px;color:#64748b;margin-bottom:4px}.stat-value[_ngcontent-%COMP%]{display:block;font-size:18px;font-weight:600;color:#1e293b}.card-actions[_ngcontent-%COMP%]{display:flex;gap:8px;padding:16px;border-top:1px solid #e2e8f0}.card-actions[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{flex:1}.btn[_ngcontent-%COMP%]{padding:8px 16px;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;border:none;transition:background-color .2s;display:inline-flex;align-items:center;justify-content:center;gap:6px}.btn-primary[_ngcontent-%COMP%]{background:#3b82f6;color:#fff}.btn-primary[_ngcontent-%COMP%]:hover{background:#2563eb}.btn-secondary[_ngcontent-%COMP%]{background:#f1f5f9;color:#475569}.btn-secondary[_ngcontent-%COMP%]:hover{background:#e2e8f0}"]})}}return n})();var $e=["bomFlowChart"],je=n=>({$implicit:n,level:1}),We=(n,s)=>({$implicit:n,level:s});function Qe(n,s){if(n&1&&(o(0,"span",19),r(1," | Status: "),o(2,"span",20),r(3),i()()),n&2){let e=m(2);l(2),d("ngClass","status-"+(e.bomTree.tree[0].status||"active").toLowerCase()),l(),b(" ",e.bomTree.tree[0].status||"ACTIVE"," ")}}function Ge(n,s){if(n&1&&(o(0,"div",17),r(1),f(2,Qe,4,2,"span",18),i()),n&2){let e=m();l(),oe(" Version: ",e.bomTree.bomVersion," | Nodes: ",e.bomTree.totalNodes," | Depth: ",e.bomTree.maxDepth," "),l(),d("ngIf",e.bomTree.tree.length>0)}}function Ue(n,s){if(n&1){let e=h();o(0,"button",10),g("click",function(){p(e);let t=m();return u(t.openEditSettingsModal())}),r(1,"Edit BOM Settings"),i()}}function Ye(n,s){n&1&&(o(0,"div",21),r(1," Loading BOM tree... "),i())}function Ke(n,s){if(n&1){let e=h();o(0,"div",22),r(1),o(2,"button",10),g("click",function(){p(e);let t=m();return u(t.loadBomTree())}),r(3,"Retry"),i()()}if(n&2){let e=m();l(),b(" ",e.error," ")}}function He(n,s){n&1&&(o(0,"div",23)(1,"div",24),r(2,"BOM Flow"),i(),I(3,"div",25,1),i())}function Je(n,s){if(n&1){let e=h();o(0,"div",29)(1,"p"),r(2,"No BOM nodes defined for this product."),i(),o(3,"button",11),g("click",function(){p(e);let t=m(2);return u(t.addRootNode())}),r(4,"+ Add First Node"),i()()}}function Xe(n,s){n&1&&ne(0)}function Ze(n,s){if(n&1&&(ee(0),f(1,Xe,1,0,"ng-container",32),te()),n&2){let e=s.$implicit;m(3);let a=ie(25);l(),d("ngTemplateOutlet",a)("ngTemplateOutletContext",fe(2,je,e))}}function et(n,s){if(n&1&&(o(0,"div",30),f(1,Ze,2,4,"ng-container",31),i()),n&2){let e=m(2);l(),d("ngForOf",e.bomTree.tree)}}function tt(n,s){if(n&1&&(o(0,"div",26),f(1,Je,5,0,"div",27)(2,et,2,1,"div",28),i()),n&2){let e=m();l(),d("ngIf",e.bomTree.tree.length===0),l(),d("ngIf",e.bomTree.tree.length>0)}}function nt(n,s){if(n&1){let e=h();o(0,"div",33),g("click",function(){p(e);let t=m();return u(t.cancelDelete())}),o(1,"div",34),g("click",function(t){return p(e),u(t.stopPropagation())}),o(2,"h3"),r(3,"Delete BOM Node"),i(),o(4,"p"),r(5,"Are you sure you want to delete this node?"),i(),o(6,"div",35)(7,"button",10),g("click",function(){p(e);let t=m();return u(t.cancelDelete())}),r(8,"Cancel"),i(),o(9,"button",36),g("click",function(){p(e);let t=m();return u(t.deleteNode(t.deleteConfirmId,!1))}),r(10,"Delete Node Only"),i(),o(11,"button",37),g("click",function(){p(e);let t=m();return u(t.deleteNode(t.deleteConfirmId,!0))}),r(12,"Delete with Children"),i()()()()}}function it(n,s){if(n&1&&(o(0,"option",53),r(1),i()),n&2){let e=s.$implicit,a=m(2);d("value",e.sku)("hidden",e.sku===a.productSku),l(),B(" ",e.sku," - ",e.productName," ")}}function ot(n,s){n&1&&(o(0,"small",54),r(1," Warning: Changing product will move all BOM nodes to the new product "),i())}function rt(n,s){if(n&1&&(o(0,"option",43),r(1),i()),n&2){let e=s.$implicit;d("value",e),l(),C(e)}}function at(n,s){if(n&1&&(o(0,"div",22),r(1),i()),n&2){let e=m(2);l(),C(e.settingsError)}}function lt(n,s){if(n&1){let e=h();o(0,"div",33),g("click",function(){p(e);let t=m();return u(t.closeEditSettingsModal())}),o(1,"div",38),g("click",function(t){return p(e),u(t.stopPropagation())}),o(2,"h3"),r(3,"Edit BOM Settings"),i(),o(4,"p",39),r(5,"Update top-level settings for all nodes in this BOM"),i(),o(6,"div",40)(7,"label",41),r(8,"Product"),i(),o(9,"select",42),R("ngModelChange",function(t){p(e);let c=m();return L(c.editProductSku,t)||(c.editProductSku=t),u(t)}),o(10,"option",43),r(11),i(),f(12,it,2,4,"option",44),i(),f(13,ot,2,0,"small",45),i(),o(14,"div",40)(15,"label",46),r(16,"BOM Version"),i(),o(17,"input",47),R("ngModelChange",function(t){p(e);let c=m();return L(c.editBomVersion,t)||(c.editBomVersion=t),u(t)}),i()(),o(18,"div",40)(19,"label",48),r(20,"Status"),i(),o(21,"select",49),R("ngModelChange",function(t){p(e);let c=m();return L(c.editBomStatus,t)||(c.editBomStatus=t),u(t)}),f(22,rt,2,2,"option",50),i()(),f(23,at,2,1,"div",13),o(24,"div",35)(25,"button",51),g("click",function(){p(e);let t=m();return u(t.closeEditSettingsModal())}),r(26,"Cancel"),i(),o(27,"button",52),g("click",function(){p(e);let t=m();return u(t.saveSettings())}),r(28),i()()()()}if(n&2){let e=m();l(9),q("ngModel",e.editProductSku),l(),d("value",e.productSku),l(),b("",e.productSku," (Current)"),l(),d("ngForOf",e.products),l(),d("ngIf",e.editProductSku!==e.productSku),l(4),q("ngModel",e.editBomVersion),l(4),q("ngModel",e.editBomStatus),l(),d("ngForOf",e.statusOptions),l(),d("ngIf",e.settingsError),l(2),d("disabled",e.savingSettings),l(2),d("disabled",e.savingSettings),l(),b(" ",e.savingSettings?"Saving...":"Save Settings"," ")}}function dt(n,s){if(n&1&&(o(0,"option",57),r(1),i()),n&2){let e=s.$implicit;d("ngValue",e.bomId),l(),oe(" ","\xA0".repeat((e.sequenceLevel-1)*2),"",e.materialId," - ",e.materialName," ")}}function st(n,s){if(n&1&&(o(0,"div",22),r(1),i()),n&2){let e=m(2);l(),C(e.moveError)}}function ct(n,s){if(n&1){let e=h();o(0,"div",33),g("click",function(){p(e);let t=m();return u(t.closeMoveModal())}),o(1,"div",38),g("click",function(t){return p(e),u(t.stopPropagation())}),o(2,"h3"),r(3,"Move Node"),i(),o(4,"p",39),r(5,"Select a new parent for this node, or make it a root node."),i(),o(6,"div",40)(7,"label",55),r(8,"New Parent"),i(),o(9,"select",56),R("ngModelChange",function(t){p(e);let c=m();return L(c.moveTargetParentId,t)||(c.moveTargetParentId=t),u(t)}),o(10,"option",57),r(11,"-- Root Level (no parent) --"),i(),f(12,dt,2,4,"option",58),i()(),f(13,st,2,1,"div",13),o(14,"div",35)(15,"button",51),g("click",function(){p(e);let t=m();return u(t.closeMoveModal())}),r(16,"Cancel"),i(),o(17,"button",52),g("click",function(){p(e);let t=m();return u(t.performMove())}),r(18),i()()()()}if(n&2){let e=m();l(9),q("ngModel",e.moveTargetParentId),l(),d("ngValue",null),l(2),d("ngForOf",e.allFlatNodes),l(),d("ngIf",e.moveError),l(2),d("disabled",e.movingNode),l(2),d("disabled",e.movingNode),l(),b(" ",e.movingNode?"Moving...":"Move Node"," ")}}function mt(n,s){if(n&1){let e=h();o(0,"button",75),g("click",function(t){p(e);let c=m().$implicit;return m().toggleNode(c.bomId),u(t.stopPropagation())}),r(1),i()}if(n&2){let e=m().$implicit,a=m();l(),b(" ",a.isExpanded(e.bomId)?"\u25BC":"\u25B6"," ")}}function pt(n,s){n&1&&I(0,"span",76)}function ut(n,s){if(n&1&&(o(0,"span",77),r(1),i()),n&2){let e=m().$implicit;l(),b(" (Yield: ",e.yieldLossRatio,") ")}}function ft(n,s){n&1&&ne(0)}function gt(n,s){if(n&1&&(ee(0),f(1,ft,1,0,"ng-container",32),te()),n&2){let e=s.$implicit,a=m(2).level;m();let t=ie(25);l(),d("ngTemplateOutlet",t)("ngTemplateOutletContext",ge(2,We,e,a+1))}}function _t(n,s){if(n&1&&(o(0,"div",78),f(1,gt,2,5,"ng-container",31),i()),n&2){let e=m().$implicit;l(),d("ngForOf",e.children)}}function xt(n,s){if(n&1){let e=h();o(0,"div",59)(1,"div",60),f(2,mt,2,1,"button",61)(3,pt,1,0,"span",62),o(4,"div",63),g("click",function(){let t=p(e).$implicit,c=m();return u(c.selectNode(t))}),o(5,"span",64),r(6),i(),o(7,"span",65),r(8),i(),o(9,"span",66),r(10),i(),f(11,ut,2,1,"span",67),o(12,"span",68),r(13),i(),o(14,"span",20),r(15),i()(),o(16,"div",69)(17,"button",70),g("click",function(t){let c=p(e).$implicit;return m().addChildNode(c.bomId),u(t.stopPropagation())}),r(18," + Child "),i(),o(19,"button",71),g("click",function(t){let c=p(e).$implicit;return m().openMoveModal(c.bomId),u(t.stopPropagation())}),r(20," Move "),i(),o(21,"button",72),g("click",function(t){let c=p(e).$implicit;return m().editNode(c.bomId),u(t.stopPropagation())}),r(22," Edit "),i(),o(23,"button",73),g("click",function(t){let c=p(e).$implicit;return m().confirmDelete(c.bomId),u(t.stopPropagation())}),r(24," Delete "),i()()(),f(25,_t,2,1,"div",74),i()}if(n&2){let e=s.$implicit,a=s.level,t=m();W("selected",t.isSelected(e)),l(),ce("padding-left",t.getIndentLevel(a)),l(),d("ngIf",(e.children==null?null:e.children.length)>0),l(),d("ngIf",!(e.children!=null&&e.children.length)),l(3),C(e.materialId),l(2),C(e.materialName),l(2),B("",e.quantityRequired," ",e.unit,""),l(),d("ngIf",e.yieldLossRatio&&e.yieldLossRatio!==1),l(2),b("L",e.sequenceLevel,""),l(),d("ngClass","status-"+(e.status||"active").toLowerCase()),l(),b(" ",e.status||"ACTIVE"," "),l(10),d("ngIf",(e.children==null?null:e.children.length)>0&&t.isExpanded(e.bomId))}}var Ve=(()=>{class n{constructor(e,a,t,c){this.route=e,this.router=a,this.apiService=t,this.chartService=c,this.productSku="",this.bomTree=null,this.expandedNodes=new Set,this.selectedNode=null,this.loading=!0,this.error=null,this.deleteConfirmId=null,this.showMoveModal=!1,this.moveNodeId=null,this.moveTargetParentId=null,this.movingNode=!1,this.moveError=null,this.allFlatNodes=[],this.showEditSettingsModal=!1,this.editProductSku="",this.editBomVersion="",this.editBomStatus="",this.savingSettings=!1,this.settingsError=null,this.statusOptions=["ACTIVE","INACTIVE","DRAFT","OBSOLETE"],this.products=[]}ngOnInit(){this.route.params.subscribe(e=>{this.productSku=e.productSku,this.loadBomTree()})}loadBomTree(){this.loading=!0,this.error=null,this.apiService.getBomTree(this.productSku).subscribe({next:e=>{this.bomTree=e,this.loading=!1,e.tree.forEach(a=>this.expandedNodes.add(a.bomId)),setTimeout(()=>this.buildBomFlowChart(),50)},error:e=>{this.error="Failed to load BOM tree",this.loading=!1,console.error("Error loading BOM tree:",e)}})}toggleNode(e){this.expandedNodes.has(e)?this.expandedNodes.delete(e):this.expandedNodes.add(e)}isExpanded(e){return this.expandedNodes.has(e)}selectNode(e){this.selectedNode=this.selectedNode?.bomId===e.bomId?null:e}isSelected(e){return this.selectedNode?.bomId===e.bomId}expandAll(){this.bomTree&&this.collectAllNodeIds(this.bomTree.tree).forEach(e=>this.expandedNodes.add(e))}collapseAll(){this.expandedNodes.clear()}collectAllNodeIds(e){let a=[],t=c=>{c.forEach(x=>{a.push(x.bomId),x.children?.length&&t(x.children)})};return t(e),a}addRootNode(){this.router.navigate(["/manage/bom",this.productSku,"node","new"])}addChildNode(e){this.router.navigate(["/manage/bom",this.productSku,"node","new"],{queryParams:{parentId:e}})}editNode(e){this.router.navigate(["/manage/bom",this.productSku,"node",e,"edit"])}confirmDelete(e){this.deleteConfirmId=e}cancelDelete(){this.deleteConfirmId=null}deleteNode(e,a=!1){(a?this.apiService.deleteBomNodeCascade(e):this.apiService.deleteBomNode(e)).subscribe({next:()=>{this.deleteConfirmId=null,this.loadBomTree()},error:c=>{this.deleteConfirmId=null,this.error=c.error?.message||"Failed to delete node. It may have children.",console.error("Error deleting node:",c)}})}goBack(){this.router.navigate(["/manage/bom"])}getIndentLevel(e){return`${Math.min((e-1)*24,240)}px`}openEditSettingsModal(){this.bomTree&&(this.editProductSku=this.bomTree.productSku,this.editBomVersion=this.bomTree.bomVersion,this.editBomStatus=this.bomTree.tree.length>0?this.bomTree.tree[0].status:"ACTIVE",this.settingsError=null,this.loadProducts(),this.showEditSettingsModal=!0)}closeEditSettingsModal(){this.showEditSettingsModal=!1,this.settingsError=null}loadProducts(){this.apiService.getActiveProducts().subscribe({next:e=>{this.products=e},error:e=>{console.error("Error loading products:",e)}})}saveSettings(){if(!this.editBomVersion.trim()){this.settingsError="BOM Version is required";return}if(!this.editProductSku.trim()){this.settingsError="Product is required";return}this.savingSettings=!0,this.settingsError=null;let e={bomVersion:this.editBomVersion,status:this.editBomStatus};this.editProductSku!==this.productSku&&(e.newProductSku=this.editProductSku),this.apiService.updateBomSettings(this.productSku,e).subscribe({next:a=>{this.savingSettings=!1,this.showEditSettingsModal=!1,a.productSku!==this.productSku?this.router.navigate(["/manage/bom",a.productSku,"tree"]):this.loadBomTree()},error:a=>{this.savingSettings=!1,this.settingsError=a.error?.message||"Failed to update BOM settings"}})}openMoveModal(e){if(this.moveNodeId=e,this.moveTargetParentId=null,this.moveError=null,this.movingNode=!1,this.bomTree){let a=this.getDescendantIds(e,this.bomTree.tree);a.add(e),this.allFlatNodes=[],this.flattenNodesForMove(this.bomTree.tree,a)}this.showMoveModal=!0}closeMoveModal(){this.showMoveModal=!1,this.moveNodeId=null,this.moveError=null}performMove(){if(!this.moveNodeId)return;this.movingNode=!0,this.moveError=null;let e={newParentBomId:this.moveTargetParentId||void 0};this.apiService.moveBomNode(this.moveNodeId,e).subscribe({next:()=>{this.movingNode=!1,this.showMoveModal=!1,this.moveNodeId=null,this.loadBomTree()},error:a=>{this.movingNode=!1,this.moveError=a.error?.message||"Failed to move node",console.error("Error moving node:",a)}})}getDescendantIds(e,a){let t=new Set,c=x=>{for(let S of x){if(S.bomId===e)return this.collectChildIds(S,t),!0;if(S.children?.length&&c(S.children))return!0}return!1};return c(a),t}collectChildIds(e,a){if(e.children)for(let t of e.children)a.add(t.bomId),this.collectChildIds(t,a)}flattenNodesForMove(e,a){for(let t of e)a.has(t.bomId)||this.allFlatNodes.push({bomId:t.bomId,materialId:t.materialId,materialName:t.materialName,sequenceLevel:t.sequenceLevel}),t.children?.length&&this.flattenNodesForMove(t.children,a)}ngOnDestroy(){this.chartService.disposeAll()}buildBomFlowChart(){if(!this.bomFlowChartRef||!this.bomTree||this.bomTree.tree.length===0)return;let e=[],a=[],t=new Set,c={1:"#1976d2",2:"#7b1fa2",3:"#388e3c",4:"#f57c00",5:"#00838f"},x="#ef5350",S=`${this.productSku} (Product)`;e.push({name:S,itemStyle:{color:"#0d47a1",borderColor:"#0d47a1"}}),t.add(S);let k=[],_=(v,w)=>{v.forEach(M=>{let E=`${M.materialId} (${M.materialName})`;k.push({node:M,parentName:w}),M.children?.length&&_(M.children,E)})};_(this.bomTree.tree,S),k.forEach(({node:v,parentName:w})=>{let M=`${v.materialId} (${v.materialName})`,E=v.sequenceLevel||1,z=c[E]||"#607d8b",ae=v.quantityRequired,le=v.yieldLossRatio||1,de=ae*le,se=ae-de;if(t.has(M)||(e.push({name:M,itemStyle:{color:z,borderColor:z}}),t.add(M)),a.push({source:M,target:w,value:Math.max(de,.1),lineStyle:{color:z,opacity:.4}}),le<1&&se>.001){let D=`Loss: ${v.materialId}`;t.has(D)||(e.push({name:D,itemStyle:{color:x,borderColor:x}}),t.add(D)),a.push({source:M,target:D,value:Math.max(se,.1),lineStyle:{color:x,opacity:.3}})}});let At=this.chartService.initChart(this.bomFlowChartRef.nativeElement,"bom-flow");this.chartService.setOption("bom-flow",{tooltip:{trigger:"item",textStyle:{fontSize:re.tooltip},formatter:v=>{if(v.dataType==="node")return`<b>${v.name}</b>`;if(v.dataType==="edge"){let w=v.data.source,M=v.data.target,E=v.data.value;return M.startsWith("Loss:")?`<b>${w}</b> \u2192 Yield Loss<br/>Loss: ${E.toFixed(2)}`:`<b>${w}</b> \u2192 <b>${M}</b><br/>Qty: ${E.toFixed(2)}`}return""}},series:[{type:"sankey",layout:"none",data:e,links:a,orient:"horizontal",nodeAlign:"justify",layoutIterations:32,nodeWidth:20,nodeGap:14,label:{show:!0,fontSize:re.label,color:"#333",formatter:v=>{if(v.name.startsWith("Loss:"))return v.name.replace("Loss: ","\u26A0 ");let w=v.name.match(/^([^(]+)/);return w?w[1].trim():v.name}},emphasis:{focus:"adjacency"},lineStyle:{curveness:.5,color:"source"}}]})}static{this.\u0275fac=function(a){return new(a||n)(y(G),y(V),y(F),y(Ee))}}static{this.\u0275cmp=O({type:n,selectors:[["app-bom-tree"]],viewQuery:function(a,t){if(a&1&&me($e,5),a&2){let c;pe(c=ue())&&(t.bomFlowChartRef=c.first)}},decls:26,vars:10,consts:[["treeNode",""],["bomFlowChart",""],[1,"bom-tree-container"],[1,"page-header"],[1,"header-left"],[1,"btn","btn-back",3,"click"],[1,"title-section"],["class","tree-meta",4,"ngIf"],[1,"header-actions"],["class","btn btn-secondary",3,"click",4,"ngIf"],[1,"btn","btn-secondary",3,"click"],[1,"btn","btn-primary",3,"click"],["class","loading",4,"ngIf"],["class","error-message",4,"ngIf"],["class","card bom-flow-section",4,"ngIf"],["class","tree-content",4,"ngIf"],["class","modal-overlay",3,"click",4,"ngIf"],[1,"tree-meta"],["class","tree-status",4,"ngIf"],[1,"tree-status"],[1,"status-badge",3,"ngClass"],[1,"loading"],[1,"error-message"],[1,"card","bom-flow-section"],[1,"bom-flow-header"],[1,"bom-flow-container"],[1,"tree-content"],["class","empty-state",4,"ngIf"],["class","tree-view",4,"ngIf"],[1,"empty-state"],[1,"tree-view"],[4,"ngFor","ngForOf"],[4,"ngTemplateOutlet","ngTemplateOutletContext"],[1,"modal-overlay",3,"click"],[1,"modal",3,"click"],[1,"modal-actions"],[1,"btn","btn-danger",3,"click"],[1,"btn","btn-danger-outline",3,"click"],[1,"modal","settings-modal",3,"click"],[1,"modal-subtitle"],[1,"form-group"],["for","bomProduct"],["id","bomProduct",1,"form-control",3,"ngModelChange","ngModel"],[3,"value"],[3,"value","hidden",4,"ngFor","ngForOf"],["class","form-hint",4,"ngIf"],["for","bomVersion"],["type","text","id","bomVersion","placeholder","e.g., V1, V2",1,"form-control",3,"ngModelChange","ngModel"],["for","bomStatus"],["id","bomStatus",1,"form-control",3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],[1,"btn","btn-secondary",3,"click","disabled"],[1,"btn","btn-primary",3,"click","disabled"],[3,"value","hidden"],[1,"form-hint"],["for","moveTarget"],["id","moveTarget",1,"form-control",3,"ngModelChange","ngModel"],[3,"ngValue"],[3,"ngValue",4,"ngFor","ngForOf"],[1,"tree-node"],[1,"node-content"],["class","expand-btn",3,"click",4,"ngIf"],["class","expand-placeholder",4,"ngIf"],[1,"node-info",3,"click"],[1,"material-id"],[1,"material-name"],[1,"quantity"],["class","yield",4,"ngIf"],[1,"level-badge"],[1,"node-actions"],["title","Add Child",1,"btn-text",3,"click"],["title","Move",1,"btn-text",3,"click"],["title","Edit",1,"btn-text",3,"click"],["title","Delete",1,"btn-text","btn-delete",3,"click"],["class","children",4,"ngIf"],[1,"expand-btn",3,"click"],[1,"expand-placeholder"],[1,"yield"],[1,"children"]],template:function(a,t){if(a&1){let c=h();o(0,"div",2)(1,"div",3)(2,"div",4)(3,"button",5),g("click",function(){return p(c),u(t.goBack())}),r(4," \u2190 Back "),i(),o(5,"div",6)(6,"h1"),r(7),i(),f(8,Ge,3,4,"div",7),i()(),o(9,"div",8),f(10,Ue,2,0,"button",9),o(11,"button",10),g("click",function(){return p(c),u(t.expandAll())}),r(12,"Expand All"),i(),o(13,"button",10),g("click",function(){return p(c),u(t.collapseAll())}),r(14,"Collapse All"),i(),o(15,"button",11),g("click",function(){return p(c),u(t.addRootNode())}),r(16,"+ Add Node"),i()()(),f(17,Ye,2,0,"div",12)(18,Ke,4,1,"div",13)(19,He,5,0,"div",14)(20,tt,3,2,"div",15)(21,nt,13,0,"div",16),i(),f(22,lt,29,12,"div",16)(23,ct,19,7,"div",16)(24,xt,26,15,"ng-template",null,0,_e)}a&2&&(l(7),b("BOM Tree: ",t.productSku,""),l(),d("ngIf",t.bomTree),l(2),d("ngIf",t.bomTree&&t.bomTree.tree.length>0),l(7),d("ngIf",t.loading),l(),d("ngIf",t.error),l(),d("ngIf",!t.loading&&!t.error&&t.bomTree&&t.bomTree.tree.length>0),l(),d("ngIf",!t.loading&&!t.error&&t.bomTree),l(),d("ngIf",t.deleteConfirmId!==null),l(),d("ngIf",t.showEditSettingsModal),l(),d("ngIf",t.showMoveModal))},dependencies:[Q,N,P,xe,H,J,U,K,Y,he],styles:[".bom-tree-container[_ngcontent-%COMP%]{padding:24px}.page-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;flex-wrap:wrap;gap:16px}.header-left[_ngcontent-%COMP%]{display:flex;align-items:flex-start;gap:16px}.btn-back[_ngcontent-%COMP%]{background:#f1f5f9;color:#475569;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}.btn-back[_ngcontent-%COMP%]:hover{background:#e2e8f0}.title-section[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin:0 0 4px;font-size:24px;font-weight:600;color:#1e293b}.tree-meta[_ngcontent-%COMP%]{font-size:14px;color:#64748b;display:flex;align-items:center;flex-wrap:wrap;gap:4px}.tree-status[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:4px}.tree-meta[_ngcontent-%COMP%]   .status-badge[_ngcontent-%COMP%]{margin-left:4px}.header-actions[_ngcontent-%COMP%]{display:flex;gap:8px}.loading[_ngcontent-%COMP%]{text-align:center;padding:48px;color:#64748b}.error-message[_ngcontent-%COMP%]{background:#fef2f2;border:1px solid #fecaca;color:#dc2626;padding:16px;border-radius:8px;display:flex;justify-content:space-between;align-items:center}.empty-state[_ngcontent-%COMP%]{text-align:center;padding:48px;background:#f8fafc;border-radius:8px;border:2px dashed #e2e8f0}.empty-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:#64748b;margin-bottom:16px}.bom-flow-section[_ngcontent-%COMP%]{background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:16px}.bom-flow-header[_ngcontent-%COMP%]{font-size:16px;font-weight:500;color:#1e293b;margin-bottom:8px}.bom-flow-container[_ngcontent-%COMP%]{width:100%;height:400px;border:1px solid #f1f5f9;border-radius:6px;background:#fafafa}.tree-content[_ngcontent-%COMP%]{background:#fff;border:1px solid #e2e8f0;border-radius:8px}.tree-view[_ngcontent-%COMP%]{padding:16px;overflow-x:auto}.tree-node[_ngcontent-%COMP%]{border-bottom:1px solid #f1f5f9}.tree-node[_ngcontent-%COMP%]:last-child{border-bottom:none}.tree-node.selected[_ngcontent-%COMP%] > .node-content[_ngcontent-%COMP%]{background:#eff6ff}.node-content[_ngcontent-%COMP%]{display:flex;align-items:center;padding:12px 16px;gap:8px;transition:background-color .15s}.node-content[_ngcontent-%COMP%]:hover{background:#f8fafc}.expand-btn[_ngcontent-%COMP%]{width:24px;height:24px;border:none;background:transparent;cursor:pointer;font-size:16px;color:#64748b;display:flex;align-items:center;justify-content:center;flex-shrink:0}.expand-btn[_ngcontent-%COMP%]:hover{color:#1e293b}.expand-placeholder[_ngcontent-%COMP%]{width:24px;flex-shrink:0}.node-info[_ngcontent-%COMP%]{flex:1;display:flex;align-items:center;gap:12px;cursor:pointer}.material-id[_ngcontent-%COMP%]{font-family:monospace;font-weight:600;color:#3b82f6;min-width:120px}.material-name[_ngcontent-%COMP%]{flex:1;color:#1e293b}.quantity[_ngcontent-%COMP%]{font-weight:500;color:#475569;min-width:80px;text-align:right}.yield[_ngcontent-%COMP%]{font-size:12px;color:#64748b}.level-badge[_ngcontent-%COMP%]{background:#e2e8f0;color:#475569;padding:2px 8px;border-radius:4px;font-size:12px;font-weight:500}.status-badge[_ngcontent-%COMP%]{padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;text-transform:uppercase}.status-badge.status-active[_ngcontent-%COMP%]{background:#dcfce7;color:#166534}.status-badge.status-inactive[_ngcontent-%COMP%]{background:#f1f5f9;color:#64748b}.status-badge.status-draft[_ngcontent-%COMP%]{background:#fef3c7;color:#92400e}.status-badge.status-obsolete[_ngcontent-%COMP%]{background:#fee2e2;color:#991b1b}.node-actions[_ngcontent-%COMP%]{display:flex;gap:4px}.btn-text[_ngcontent-%COMP%]{padding:4px 10px;border:1px solid #e2e8f0;background:#fff;border-radius:4px;cursor:pointer;font-size:12px;font-weight:500;color:#475569;white-space:nowrap}.btn-text[_ngcontent-%COMP%]:hover{background:#f1f5f9;color:#1e293b}.btn-text.btn-delete[_ngcontent-%COMP%]{color:#dc2626;border-color:#fecaca}.btn-text.btn-delete[_ngcontent-%COMP%]:hover{background:#fef2f2}.children[_ngcontent-%COMP%]{border-left:2px solid #e2e8f0;margin-left:28px}.btn[_ngcontent-%COMP%]{padding:8px 16px;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;border:none;transition:background-color .2s;display:inline-flex;align-items:center;gap:6px}.btn-primary[_ngcontent-%COMP%]{background:#3b82f6;color:#fff}.btn-primary[_ngcontent-%COMP%]:hover{background:#2563eb}.btn-secondary[_ngcontent-%COMP%]{background:#f1f5f9;color:#475569}.btn-secondary[_ngcontent-%COMP%]:hover{background:#e2e8f0}.btn-danger[_ngcontent-%COMP%]{background:#dc2626;color:#fff}.btn-danger[_ngcontent-%COMP%]:hover{background:#b91c1c}.btn-danger-outline[_ngcontent-%COMP%]{background:#fff;color:#dc2626;border:1px solid #dc2626}.btn-danger-outline[_ngcontent-%COMP%]:hover{background:#fef2f2}.modal-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;background:#00000080;display:flex;align-items:center;justify-content:center;z-index:1000}.modal[_ngcontent-%COMP%]{background:#fff;padding:24px;border-radius:8px;max-width:480px;width:90%}.modal[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 16px;color:#1e293b}.modal[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:#64748b;margin-bottom:24px}.modal-actions[_ngcontent-%COMP%]{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}.settings-modal[_ngcontent-%COMP%]{min-width:400px}.modal-subtitle[_ngcontent-%COMP%]{font-size:14px;margin-bottom:20px}.form-group[_ngcontent-%COMP%]{margin-bottom:16px}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:block;margin-bottom:6px;font-weight:500;color:#374151;font-size:14px}.form-control[_ngcontent-%COMP%]{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;color:#1f2937;box-sizing:border-box}.form-control[_ngcontent-%COMP%]:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px #3b82f61a}.settings-modal[_ngcontent-%COMP%]   .error-message[_ngcontent-%COMP%]{margin-bottom:16px;padding:10px;background:#fef2f2;border:1px solid #fecaca;border-radius:6px;color:#dc2626;font-size:14px}.btn[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.form-hint[_ngcontent-%COMP%]{display:block;margin-top:4px;font-size:12px;color:#d97706}"]})}}return n})();function vt(n,s){if(n&1&&(o(0,"div",6),r(1),i()),n&2){let e=m();l(),b(" Product: ",e.productSku," ")}}function bt(n,s){n&1&&(o(0,"div",7),r(1," Loading node details... "),i())}function ht(n,s){if(n&1&&(o(0,"div",8),r(1),i()),n&2){let e=m();l(),b(" ",e.error," ")}}function Ct(n,s){if(n&1&&(o(0,"option",42),r(1),i()),n&2){let e=s.$implicit;d("value",e.sku),l(),B(" ",e.sku," - ",e.productName," ")}}function St(n,s){n&1&&(o(0,"div",43),r(1," Product selection is required "),i())}function Mt(n,s){n&1&&(o(0,"div",43),r(1," No products available. Please create a product first. "),i())}function yt(n,s){if(n&1&&(o(0,"div",11)(1,"h3"),r(2,"Select Product"),i(),o(3,"p",38),r(4,"Choose the product this BOM will define."),i(),o(5,"div",12)(6,"div",39)(7,"label",40),r(8,"Product *"),i(),o(9,"select",41)(10,"option",16),r(11,"-- Select a Product --"),i(),f(12,Ct,2,3,"option",17),i(),f(13,St,2,0,"div",21)(14,Mt,2,0,"div",21),i()()()),n&2){let e,a,t=m(2);l(9),W("error",((e=t.form.get("productSku"))==null?null:e.touched)&&((e=t.form.get("productSku"))==null||e.errors==null?null:e.errors.required)),l(3),d("ngForOf",t.products),l(),d("ngIf",((a=t.form.get("productSku"))==null?null:a.touched)&&((a=t.form.get("productSku"))==null||a.errors==null?null:a.errors.required)),l(),d("ngIf",t.products.length===0)}}function It(n,s){if(n&1&&(o(0,"option",42),r(1),i()),n&2){let e=s.$implicit;d("value",e.materialCode),l(),B(" ",e.materialCode," - ",e.materialName," ")}}function Tt(n,s){n&1&&(o(0,"div",43),r(1," Material ID is required "),i())}function wt(n,s){n&1&&(o(0,"div",43),r(1," Material Name is required "),i())}function kt(n,s){n&1&&(o(0,"div",43),r(1," Quantity is required "),i())}function Et(n,s){n&1&&(o(0,"div",43),r(1," Quantity must be greater than 0 "),i())}function Ot(n,s){if(n&1&&(o(0,"option",42),r(1),i()),n&2){let e=s.$implicit;d("value",e),l(),C(e)}}function Bt(n,s){n&1&&(o(0,"div",43),r(1," Unit is required "),i())}function Nt(n,s){n&1&&(o(0,"div",43),r(1," Yield loss ratio must be at least 0.01 "),i())}function Pt(n,s){n&1&&(o(0,"div",43),r(1," Sequence level is required "),i())}function Vt(n,s){if(n&1&&(o(0,"div",44)(1,"strong"),r(2,"Parent Node ID:"),i(),r(3),i()),n&2){let e=m(2);l(3),b(" ",e.parentBomId," ")}}function Ft(n,s){if(n&1&&(o(0,"div",13)(1,"label"),r(2,"BOM ID"),i(),o(3,"div",51),r(4),i()()),n&2){let e=m(3);l(4),C(e.bomId)}}function qt(n,s){if(n&1&&(o(0,"div",11)(1,"h3"),r(2,"Status"),i(),o(3,"div",12)(4,"div",13)(5,"label",45),r(6,"Status"),i(),o(7,"select",46)(8,"option",47),r(9,"Active"),i(),o(10,"option",48),r(11,"Inactive"),i(),o(12,"option",49),r(13,"Draft"),i(),o(14,"option",50),r(15,"Obsolete"),i()(),o(16,"small",18),r(17,"Change status to deactivate this BOM node"),i()(),o(18,"div",13)(19,"label"),r(20,"Product SKU"),i(),o(21,"div",51),r(22),i(),o(23,"small",18),r(24,"Product cannot be changed after creation"),i()(),f(25,Ft,5,1,"div",52),i()()),n&2){let e=m(2);l(22),C(e.productSku),l(3),d("ngIf",e.bomId)}}function Lt(n,s){if(n&1){let e=h();o(0,"form",9),g("ngSubmit",function(){p(e);let t=m();return u(t.onSubmit())}),f(1,yt,15,5,"div",10),o(2,"div",11)(3,"h3"),r(4,"Material Information"),i(),o(5,"div",12)(6,"div",13)(7,"label",14),r(8,"Select Material"),i(),o(9,"select",15),g("change",function(t){p(e);let c=m();return u(c.onMaterialSelect(t))}),o(10,"option",16),r(11,"-- Select from Master Data --"),i(),f(12,It,2,3,"option",17),i(),o(13,"small",18),r(14,"Or enter manually below"),i()()(),o(15,"div",12)(16,"div",13)(17,"label",19),r(18,"Material ID *"),i(),I(19,"input",20),f(20,Tt,2,0,"div",21),i(),o(21,"div",13)(22,"label",22),r(23,"Material Name *"),i(),I(24,"input",23),f(25,wt,2,0,"div",21),i()()(),o(26,"div",11)(27,"h3"),r(28,"Quantity & Unit"),i(),o(29,"div",12)(30,"div",13)(31,"label",24),r(32,"Quantity Required *"),i(),I(33,"input",25),f(34,kt,2,0,"div",21)(35,Et,2,0,"div",21),i(),o(36,"div",13)(37,"label",26),r(38,"Unit *"),i(),o(39,"select",27),f(40,Ot,2,2,"option",17),i(),f(41,Bt,2,0,"div",21),i(),o(42,"div",13)(43,"label",28),r(44,"Yield Loss Ratio"),i(),I(45,"input",29),o(46,"small",18),r(47,"1.0 = no loss, 1.05 = 5% extra needed"),i(),f(48,Nt,2,0,"div",21),i()()(),o(49,"div",11)(50,"h3"),r(51,"Hierarchy & Version"),i(),o(52,"div",12)(53,"div",13)(54,"label",30),r(55,"Sequence Level *"),i(),I(56,"input",31),o(57,"small",18),r(58,"1 = Root level, 2+ = Sub-levels"),i(),f(59,Pt,2,0,"div",21),i(),o(60,"div",13)(61,"label",32),r(62,"BOM Version"),i(),I(63,"input",33),i()(),f(64,Vt,4,1,"div",34),i(),f(65,qt,26,2,"div",10),o(66,"div",35)(67,"button",36),g("click",function(){p(e);let t=m();return u(t.cancel())}),r(68," Cancel "),i(),o(69,"button",37),r(70),i()()()}if(n&2){let e,a,t,c,x,S,k,_=m();d("formGroup",_.form),l(),d("ngIf",_.isNewBom),l(11),d("ngForOf",_.materials),l(8),d("ngIf",((e=_.form.get("materialId"))==null?null:e.touched)&&((e=_.form.get("materialId"))==null||e.errors==null?null:e.errors.required)),l(5),d("ngIf",((a=_.form.get("materialName"))==null?null:a.touched)&&((a=_.form.get("materialName"))==null||a.errors==null?null:a.errors.required)),l(9),d("ngIf",((t=_.form.get("quantityRequired"))==null?null:t.touched)&&((t=_.form.get("quantityRequired"))==null||t.errors==null?null:t.errors.required)),l(),d("ngIf",((c=_.form.get("quantityRequired"))==null?null:c.touched)&&((c=_.form.get("quantityRequired"))==null||c.errors==null?null:c.errors.min)),l(5),d("ngForOf",_.units),l(),d("ngIf",((x=_.form.get("unit"))==null?null:x.touched)&&((x=_.form.get("unit"))==null||x.errors==null?null:x.errors.required)),l(7),d("ngIf",((S=_.form.get("yieldLossRatio"))==null?null:S.touched)&&((S=_.form.get("yieldLossRatio"))==null||S.errors==null?null:S.errors.min)),l(11),d("ngIf",((k=_.form.get("sequenceLevel"))==null?null:k.touched)&&((k=_.form.get("sequenceLevel"))==null||k.errors==null?null:k.errors.required)),l(5),d("ngIf",_.parentBomId),l(),d("ngIf",_.isEditMode),l(4),d("disabled",_.saving||_.form.invalid),l(),b(" ",_.saving?"Saving...":_.isEditMode?"Update Node":"Create Node"," ")}}var Z=(()=>{class n{constructor(e,a,t,c){this.fb=e,this.route=a,this.router=t,this.apiService=c,this.productSku="",this.bomId=null,this.parentBomId=null,this.isEditMode=!1,this.isNewBom=!1,this.loading=!1,this.loadingNode=!1,this.saving=!1,this.error=null,this.materials=[],this.products=[],this.units=["KG","T","PCS","M","L","MT"],this.form=this.fb.group({productSku:[""],materialId:["",[T.required]],materialName:["",[T.required]],quantityRequired:[1,[T.required,T.min(1e-4)]],unit:["KG",[T.required]],yieldLossRatio:[1,[T.min(.01)]],sequenceLevel:[1,[T.required,T.min(1)]],bomVersion:["V1"],status:["ACTIVE"]})}ngOnInit(){this.route.params.subscribe(e=>{this.productSku=e.productSku||"",this.bomId=e.bomId?+e.bomId:null,this.isEditMode=!!this.bomId,this.isNewBom=!this.productSku}),this.route.queryParams.subscribe(e=>{this.parentBomId=e.parentId?+e.parentId:null,this.parentBomId&&this.loadParentInfo()}),this.loadMaterials(),this.isNewBom&&(this.form.get("productSku")?.setValidators([T.required]),this.form.get("productSku")?.updateValueAndValidity(),this.loadProducts()),this.isEditMode&&this.bomId&&this.loadNode()}loadMaterials(){this.apiService.getActiveMaterials().subscribe({next:e=>{this.materials=e},error:e=>{console.error("Error loading materials:",e)}})}loadProducts(){this.apiService.getActiveProducts().subscribe({next:e=>{this.products=e},error:e=>{console.error("Error loading products:",e)}})}loadParentInfo(){this.parentBomId&&this.apiService.getBomNode(this.parentBomId).subscribe({next:e=>{this.form.patchValue({sequenceLevel:e.sequenceLevel+1,bomVersion:e.bomVersion})},error:e=>{console.error("Error loading parent node:",e)}})}loadNode(){this.bomId&&(this.loadingNode=!0,this.apiService.getBomNode(this.bomId).subscribe({next:e=>{this.form.patchValue({materialId:e.materialId,materialName:e.materialName,quantityRequired:e.quantityRequired,unit:e.unit,yieldLossRatio:e.yieldLossRatio||1,sequenceLevel:e.sequenceLevel,bomVersion:e.bomVersion,status:e.status||"ACTIVE"}),this.parentBomId=e.parentBomId||null,this.loadingNode=!1},error:e=>{this.error="Failed to load BOM node",this.loadingNode=!1,console.error("Error loading node:",e)}}))}onMaterialSelect(e){let t=e.target.value,c=this.materials.find(x=>x.materialCode===t);c&&this.form.patchValue({materialId:c.materialCode,materialName:c.materialName,unit:c.baseUnit||"KG"})}onSubmit(){if(this.form.invalid){this.form.markAllAsTouched();return}this.saving=!0,this.error=null,this.isEditMode&&this.bomId?this.updateNode():this.createNode()}createNode(){let e=this.productSku;if(this.isNewBom){let t=this.form.value.productSku;if(!t){this.error="Please select a product for the BOM",this.saving=!1;return}e=t}let a={productSku:e,bomVersion:this.form.value.bomVersion,materialId:this.form.value.materialId,materialName:this.form.value.materialName,quantityRequired:this.form.value.quantityRequired,unit:this.form.value.unit,yieldLossRatio:this.form.value.yieldLossRatio,sequenceLevel:this.form.value.sequenceLevel,parentBomId:this.parentBomId||void 0};this.apiService.createBomNode(a).subscribe({next:t=>{this.saving=!1,this.router.navigate(["/manage/bom",t.productSku,"tree"])},error:t=>{this.saving=!1,this.error=t.error?.message||"Failed to create BOM node",console.error("Error creating node:",t)}})}updateNode(){if(!this.bomId)return;let e={materialId:this.form.value.materialId,materialName:this.form.value.materialName,quantityRequired:this.form.value.quantityRequired,unit:this.form.value.unit,yieldLossRatio:this.form.value.yieldLossRatio,sequenceLevel:this.form.value.sequenceLevel,status:this.form.value.status};this.apiService.updateBomNode(this.bomId,e).subscribe({next:()=>{this.saving=!1,this.router.navigate(["/manage/bom",this.productSku,"tree"])},error:a=>{this.saving=!1,this.error=a.error?.message||"Failed to update BOM node",console.error("Error updating node:",a)}})}cancel(){this.productSku&&!this.isNewBom?this.router.navigate(["/manage/bom",this.productSku,"tree"]):this.router.navigate(["/manage/bom"])}get title(){return this.isEditMode?"Edit BOM Node":this.isNewBom?"Create New BOM":this.parentBomId?"Add Child Node":"Add BOM Node"}static{this.\u0275fac=function(a){return new(a||n)(y(Te),y(G),y(V),y(F))}}static{this.\u0275cmp=O({type:n,selectors:[["app-bom-node-form"]],decls:8,vars:5,consts:[[1,"bom-form-container"],[1,"page-header"],["class","subtitle",4,"ngIf"],["class","loading",4,"ngIf"],["class","error-message",4,"ngIf"],["class","form-card",3,"formGroup","ngSubmit",4,"ngIf"],[1,"subtitle"],[1,"loading"],[1,"error-message"],[1,"form-card",3,"ngSubmit","formGroup"],["class","form-section",4,"ngIf"],[1,"form-section"],[1,"form-row"],[1,"form-group"],["for","materialSelect"],["id","materialSelect",1,"form-control",3,"change"],["value",""],[3,"value",4,"ngFor","ngForOf"],[1,"hint"],["for","materialId"],["type","text","id","materialId","formControlName","materialId","placeholder","e.g., RM-IRON-001",1,"form-control"],["class","error",4,"ngIf"],["for","materialName"],["type","text","id","materialName","formControlName","materialName","placeholder","e.g., Iron Ore",1,"form-control"],["for","quantityRequired"],["type","number","id","quantityRequired","formControlName","quantityRequired","step","0.0001","min","0.0001",1,"form-control"],["for","unit"],["id","unit","formControlName","unit",1,"form-control"],["for","yieldLossRatio"],["type","number","id","yieldLossRatio","formControlName","yieldLossRatio","step","0.01","min","0.01",1,"form-control"],["for","sequenceLevel"],["type","number","id","sequenceLevel","formControlName","sequenceLevel","min","1",1,"form-control"],["for","bomVersion"],["type","text","id","bomVersion","formControlName","bomVersion","placeholder","V1",1,"form-control"],["class","parent-info",4,"ngIf"],[1,"form-actions"],["type","button",1,"btn","btn-secondary",3,"click"],["type","submit",1,"btn","btn-primary",3,"disabled"],[1,"section-hint"],[1,"form-group","full-width"],["for","productSelect"],["id","productSelect","formControlName","productSku",1,"form-control"],[3,"value"],[1,"error"],[1,"parent-info"],["for","status"],["id","status","formControlName","status",1,"form-control"],["value","ACTIVE"],["value","INACTIVE"],["value","DRAFT"],["value","OBSOLETE"],[1,"readonly-value"],["class","form-group",4,"ngIf"]],template:function(a,t){a&1&&(o(0,"div",0)(1,"div",1)(2,"h1"),r(3),i(),f(4,vt,2,1,"div",2),i(),f(5,bt,2,0,"div",3)(6,ht,2,1,"div",4)(7,Lt,71,15,"form",5),i()),a&2&&(l(3),C(t.title),l(),d("ngIf",t.productSku&&t.productSku!=="new"),l(),d("ngIf",t.loadingNode),l(),d("ngIf",t.error),l(),d("ngIf",!t.loadingNode))},dependencies:[N,P,Ce,H,J,U,Se,K,Y,be,Ie,Me,ye],styles:[`.bom-form-container[_ngcontent-%COMP%]{padding:24px;max-width:800px;margin:0 auto}.page-header[_ngcontent-%COMP%]{margin-bottom:24px}.page-header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin:0 0 4px;font-size:24px;font-weight:600;color:#1e293b}.subtitle[_ngcontent-%COMP%]{font-size:14px;color:#64748b}.loading[_ngcontent-%COMP%]{text-align:center;padding:48px;color:#64748b}.error-message[_ngcontent-%COMP%]{background:#fef2f2;border:1px solid #fecaca;color:#dc2626;padding:16px;border-radius:8px;margin-bottom:16px}.form-card[_ngcontent-%COMP%]{background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:24px}.form-section[_ngcontent-%COMP%]{margin-bottom:24px;padding-bottom:24px;border-bottom:1px solid #f1f5f9}.form-section[_ngcontent-%COMP%]:last-of-type{border-bottom:none}.form-section[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 16px;font-size:16px;font-weight:600;color:#1e293b}.form-row[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}.form-group[_ngcontent-%COMP%]{display:flex;flex-direction:column}.form-group.full-width[_ngcontent-%COMP%]{grid-column:1 / -1}.section-hint[_ngcontent-%COMP%]{font-size:14px;color:#64748b;margin:-8px 0 16px}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{font-size:14px;font-weight:500;color:#374151;margin-bottom:6px}.form-control[_ngcontent-%COMP%]{padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;transition:border-color .2s,box-shadow .2s}.form-control[_ngcontent-%COMP%]:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px #3b82f61a}.form-control[_ngcontent-%COMP%]:disabled{background:#f9fafb;cursor:not-allowed}.hint[_ngcontent-%COMP%]{font-size:12px;color:#64748b;margin-top:4px}.error[_ngcontent-%COMP%]{font-size:12px;color:#dc2626;margin-top:4px}.parent-info[_ngcontent-%COMP%]{background:#f1f5f9;padding:12px;border-radius:6px;font-size:14px;color:#475569;margin-top:16px}.readonly-value[_ngcontent-%COMP%]{padding:10px 12px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;font-size:14px;color:#374151;font-family:ui-monospace,monospace}.form-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:12px;margin-top:24px;padding-top:24px;border-top:1px solid #e2e8f0}.btn[_ngcontent-%COMP%]{padding:10px 20px;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;border:none;transition:background-color .2s;display:inline-flex;align-items:center;gap:6px}.btn-primary[_ngcontent-%COMP%]{background:#3b82f6;color:#fff}.btn-primary[_ngcontent-%COMP%]:hover:not(:disabled){background:#2563eb}.btn-primary[_ngcontent-%COMP%]:disabled{background:#93c5fd;cursor:not-allowed}.btn-secondary[_ngcontent-%COMP%]{background:#f1f5f9;color:#475569}.btn-secondary[_ngcontent-%COMP%]:hover{background:#e2e8f0}select.form-control[_ngcontent-%COMP%]{appearance:none;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");background-position:right 8px center;background-repeat:no-repeat;background-size:16px 12px;padding-right:32px}`]})}}return n})();var Rt=[{path:"",component:Pe},{path:"create",component:Z},{path:":productSku/tree",component:Ve},{path:":productSku/node/new",component:Z},{path:":productSku/node/:bomId/edit",component:Z}],Fe=(()=>{class n{static{this.\u0275fac=function(a){return new(a||n)}}static{this.\u0275mod=j({type:n})}static{this.\u0275inj=$({imports:[A.forChild(Rt),A]})}}return n})();var dn=(()=>{class n{static{this.\u0275fac=function(a){return new(a||n)}}static{this.\u0275mod=j({type:n})}static{this.\u0275inj=$({imports:[ve,we,ke,A,Fe]})}}return n})();export{dn as BomModule};
