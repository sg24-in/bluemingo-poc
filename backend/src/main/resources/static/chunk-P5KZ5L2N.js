import{a as te,b as ie,c as ne,d as oe,f as re}from"./chunk-PSDCBCWL.js";import{A as g,B as _,C as O,I as k,J as R,M as V,N as F,O as N,P as B,R as D,Y as Q,_ as A,ba as T,d as E,ea as $,f as q,fa as b,g as I,ga as z,h as x,ha as j,i as h,ja as G,k as a,ka as L,l as P,la as W,m as p,ma as H,n as w,na as Y,o as s,oa as U,p as M,pa as J,qa as K,r as i,ra as X,s as t,t as f,ta as Z,u as S,v,va as ee,w as m,y as o,z as u}from"./chunk-SDYT7PYO.js";function de(n,d){n&1&&(i(0,"div",8),f(1,"app-loading-spinner",9),t())}function me(n,d){if(n&1&&(i(0,"div",14)(1,"span",15),o(2,"New Batch Created:"),t(),i(3,"span",16),o(4),t()()),n&2){let e=m(2);a(4),u(e.confirmationResult.newBatchNumber)}}function ce(n,d){if(n&1){let e=S();i(0,"button",2),v("click",function(){x(e);let r=m(2);return h(r.goToBatch(r.confirmationResult.newBatchId))}),o(1," View New Batch "),t()}}function pe(n,d){if(n&1){let e=S();i(0,"div",10)(1,"div",11)(2,"div",12),o(3,"\u2713"),t(),i(4,"h2"),o(5,"Production Confirmed Successfully!"),t(),i(6,"div",13)(7,"div",14)(8,"span",15),o(9,"Confirmation ID:"),t(),i(10,"span",16),o(11),t()(),i(12,"div",14)(13,"span",15),o(14,"Quantity Produced:"),t(),i(15,"span",16),o(16),t()(),p(17,me,5,1,"div",17),i(18,"div",14)(19,"span",15),o(20,"Materials Consumed:"),t(),i(21,"span",16),o(22),t()(),i(23,"div",14)(24,"span",15),o(25,"Operation Status:"),t(),f(26,"app-status-badge",18),t()(),i(27,"div",19)(28,"button",20),v("click",function(){x(e);let r=m();return h(r.goBack())}),o(29,"Back to Order"),t(),p(30,ce,2,0,"button",21),t()()()}if(n&2){let e=m();a(11),u(e.confirmationResult.confirmationId),a(5),u(e.confirmationResult.quantityProduced),a(),s("ngIf",e.confirmationResult.newBatchNumber),a(5),g("",(e.confirmationResult.materialsConsumed==null?null:e.confirmationResult.materialsConsumed.length)||0," item(s)"),a(4),s("status",e.confirmationResult.operationStatus),a(4),s("ngIf",e.confirmationResult.newBatchId)}}function ue(n,d){n&1&&(i(0,"div",65),o(1," Start time cannot be in the future "),t())}function fe(n,d){n&1&&(i(0,"div",65),o(1," End time must be after start time "),t())}function ge(n,d){if(n&1&&(i(0,"tr")(1,"td"),o(2),t(),i(3,"td"),o(4),t(),i(5,"td"),o(6),t(),i(7,"td"),o(8),t(),i(9,"td")(10,"span",75),o(11),t()()()),n&2){let e=d.$implicit;M("insufficient",!e.sufficientStock),a(2),_("",e.materialName," (",e.materialId,")"),a(2),_("",e.requiredQuantity," ",e.unit,""),a(2),_("",e.availableQuantity," ",e.unit,""),a(2),u(e.yieldLossRatio),a(2),M("ok",e.sufficientStock)("low",!e.sufficientStock),a(),g(" ",e.sufficientStock?"Sufficient":"Insufficient"," ")}}function _e(n,d){n&1&&(i(0,"div",76)(1,"strong"),o(2,"Warning:"),t(),o(3," Insufficient stock for some materials. Please review before proceeding. "),t())}function ve(n,d){if(n&1){let e=S();i(0,"div",66)(1,"div",67)(2,"h4"),o(3,"BOM Suggested Consumption"),t(),i(4,"button",68),v("click",function(){x(e);let r=m(2);return h(r.applySuggestedConsumption())}),o(5," Apply Suggestions "),t()(),i(6,"div",69)(7,"span",70),o(8,"Target Quantity:"),t(),i(9,"span",71),o(10),t(),i(11,"span",70),o(12,"Total Required:"),t(),i(13,"span",71),o(14),t()(),i(15,"table",72)(16,"thead")(17,"tr")(18,"th"),o(19,"Material"),t(),i(20,"th"),o(21,"Required Qty"),t(),i(22,"th"),o(23,"Available"),t(),i(24,"th"),o(25,"Yield Ratio"),t(),i(26,"th"),o(27,"Stock Status"),t()()(),i(28,"tbody"),p(29,ge,12,14,"tr",73),t()(),p(30,_e,4,0,"div",74),t()}if(n&2){let e=m(2);a(4),s("disabled",!e.hasSufficientStock()),a(6),g("",e.suggestedConsumption.targetQuantity," T"),a(4),g("",e.suggestedConsumption.totalRequiredQuantity," T"),a(15),s("ngForOf",e.suggestedConsumption.suggestedMaterials),a(),s("ngIf",!e.hasSufficientStock())}}function xe(n,d){if(n&1){let e=S();i(0,"tr")(1,"td"),o(2),t(),i(3,"td"),o(4),t(),i(5,"td"),o(6),t(),i(7,"td"),f(8,"app-status-badge",18),t(),i(9,"td")(10,"button",79),v("click",function(){let r=x(e).$implicit,c=m(3);return h(c.addMaterial(r))}),o(11," Add "),t()()()}if(n&2){let e=d.$implicit;a(2),u(e.batchNumber),a(2),u(e.materialId),a(2),_("",e.quantity," ",e.unitOfMeasure,""),a(2),s("status",e.state)}}function he(n,d){if(n&1&&(i(0,"table",77)(1,"thead")(2,"tr")(3,"th"),o(4,"Batch #"),t(),i(5,"th"),o(6,"Material ID"),t(),i(7,"th"),o(8,"Available Qty"),t(),i(9,"th"),o(10,"State"),t(),i(11,"th"),o(12,"Action"),t()()(),i(13,"tbody"),p(14,xe,12,5,"tr",78),t()()),n&2){let e=m(2);a(14),s("ngForOf",e.availableInventory)}}function Ce(n,d){n&1&&(i(0,"p",80),o(1,"No available inventory"),t())}function be(n,d){if(n&1){let e=S();i(0,"tr")(1,"td"),o(2),t(),i(3,"td"),o(4),t(),i(5,"td"),o(6),t(),i(7,"td")(8,"input",82),v("change",function(r){let c=x(e).index,C=m(3);return h(C.updateMaterialQuantity(c,r.target.valueAsNumber))}),t()(),i(9,"td")(10,"button",83),v("click",function(){let r=x(e).index,c=m(3);return h(c.removeMaterial(r))}),o(11," Remove "),t()()()}if(n&2){let e=d.$implicit;a(2),u(e.batchNumber),a(2),u(e.materialId),a(2),u(e.availableQuantity),a(2),s("value",e.quantityToConsume)("min",0)("max",e.availableQuantity)}}function Se(n,d){if(n&1&&(i(0,"div",81)(1,"h4"),o(2,"Selected Materials"),t(),i(3,"table",77)(4,"thead")(5,"tr")(6,"th"),o(7,"Batch #"),t(),i(8,"th"),o(9,"Material ID"),t(),i(10,"th"),o(11,"Available"),t(),i(12,"th"),o(13,"Qty to Consume"),t(),i(14,"th"),o(15,"Action"),t()()(),i(16,"tbody"),p(17,be,12,6,"tr",78),t()()()),n&2){let e=m(2);a(17),s("ngForOf",e.selectedMaterials)}}function ye(n,d){if(n&1&&(i(0,"tr",87)(1,"td"),o(2),t(),i(3,"td"),o(4),t(),i(5,"td"),o(6),t(),i(7,"td")(8,"span",88),o(9),k(10,"uppercase"),t()()()),n&2){let e=d.$implicit,l=m(3);s("ngClass","bom-"+l.getRequirementStatus(e)),a(2),_("",e.materialName," (",e.materialId,")"),a(2),_("",e.quantityRequired," ",e.unit,""),a(2),_("",l.getTotalSelectedByMaterial(e.materialId)," ",e.unit,""),a(2),s("ngClass",l.getRequirementStatus(e)),a(),g(" ",R(10,9,l.getRequirementStatus(e))," ")}}function Pe(n,d){if(n&1&&(i(0,"div",84)(1,"h4"),o(2,"BOM Requirements"),t(),i(3,"table",85)(4,"thead")(5,"tr")(6,"th"),o(7,"Material"),t(),i(8,"th"),o(9,"Required Qty"),t(),i(10,"th"),o(11,"Selected Qty"),t(),i(12,"th"),o(13,"Status"),t()()(),i(14,"tbody"),p(15,ye,11,11,"tr",86),t()()()),n&2){let e=m(2);a(15),s("ngForOf",e.bomRequirements)}}function Ee(n,d){if(n&1&&(i(0,"li"),o(1),t()),n&2){let e=d.$implicit;a(),u(e)}}function Ie(n,d){if(n&1&&(i(0,"div",76)(1,"strong"),o(2,"Warnings:"),t(),i(3,"ul"),p(4,Ee,2,1,"li",78),t()()),n&2){let e=m(3);a(4),s("ngForOf",e.bomValidationResult.warnings)}}function Me(n,d){if(n&1&&(i(0,"li"),o(1),t()),n&2){let e=d.$implicit;a(),u(e)}}function Oe(n,d){if(n&1&&(i(0,"div",90)(1,"strong"),o(2,"Errors:"),t(),i(3,"ul"),p(4,Me,2,1,"li",78),t()()),n&2){let e=m(3);a(4),s("ngForOf",e.bomValidationResult.errors)}}function Te(n,d){if(n&1&&(i(0,"div",89),p(1,Ie,5,1,"div",74)(2,Oe,5,1,"div",60),t()),n&2){let e=m(2);a(),s("ngIf",(e.bomValidationResult.warnings==null?null:e.bomValidationResult.warnings.length)>0),a(),s("ngIf",(e.bomValidationResult.errors==null?null:e.bomValidationResult.errors.length)>0)}}function qe(n,d){if(n&1){let e=S();i(0,"div",91)(1,"label",92)(2,"input",93),v("change",function(){let r=x(e).index,c=m(2);return h(c.toggleEquipment(r))}),t(),i(3,"span",94),o(4),t()()()}if(n&2){let e=d.$implicit;a(2),s("checked",e.selected),a(2),_("",e.equipmentName," (",e.equipmentCode,")")}}function we(n,d){n&1&&(i(0,"p",95),o(1,"No equipment available"),t())}function ke(n,d){if(n&1){let e=S();i(0,"div",91)(1,"label",92)(2,"input",93),v("change",function(){let r=x(e).index,c=m(2);return h(c.toggleOperator(r))}),t(),i(3,"span",94),o(4),t()()()}if(n&2){let e=d.$implicit;a(2),s("checked",e.selected),a(2),_("",e.operatorName," (",e.operatorCode,")")}}function Re(n,d){n&1&&(i(0,"p",95),o(1,"No operators available"),t())}function Ve(n,d){n&1&&(i(0,"span",96),o(1,"*"),t())}function Fe(n,d){if(n&1&&(i(0,"option",97),o(1),t()),n&2){let e=d.$implicit;s("value",e.reason_code),a(),g(" ",e.reason_description," ")}}function Ne(n,d){n&1&&(i(0,"div",65),o(1," Delay reason is required when delay duration is entered "),t())}function Be(n,d){n&1&&(i(0,"span",96),o(1,"*"),t())}function De(n,d){if(n&1&&(i(0,"span",103),o(1),t()),n&2){let e=m().$implicit;a(),g("(",e.unit,")")}}function Qe(n,d){if(n&1&&(i(0,"span",103),o(1),t()),n&2){let e=m().$implicit;a(),_(" [",e.min_value||"..."," - ",e.max_value||"...","] ")}}function Ae(n,d){if(n&1&&(i(0,"div",65),o(1),t()),n&2){let e=m().$implicit;a(),g(" ",e.parameter_name," is required ")}}function $e(n,d){if(n&1&&(i(0,"div",65),o(1),t()),n&2){let e=m().$implicit;a(),O(" ",e.parameter_name," must be at least ",e.min_value," ",e.unit||""," ")}}function ze(n,d){if(n&1&&(i(0,"div",65),o(1),t()),n&2){let e=m().$implicit;a(),O(" ",e.parameter_name," must not exceed ",e.max_value," ",e.unit||""," ")}}function je(n,d){if(n&1&&(i(0,"div",31)(1,"div",100)(2,"label"),o(3),p(4,Be,2,0,"span",55)(5,De,2,1,"span",101)(6,Qe,2,2,"span",101),t(),f(7,"input",102),p(8,Ae,2,1,"div",34)(9,$e,2,3,"div",34)(10,ze,2,3,"div",34),t()()),n&2){let e,l,r,c=d.$implicit,C=d.index,y=m(3);a(),s("formGroupName",C),a(2),g("",c.parameter_name," "),a(),s("ngIf",c.is_required),a(),s("ngIf",c.unit),a(),s("ngIf",c.min_value!==null||c.max_value!==null),a(),s("placeholder",c.default_value||""),w("min",c.min_value)("max",c.max_value),a(),s("ngIf",((e=y.processParamsFormArray.at(C).get("parameterValue"))==null||e.errors==null?null:e.errors.required)&&((e=y.processParamsFormArray.at(C).get("parameterValue"))==null?null:e.touched)),a(),s("ngIf",(l=y.processParamsFormArray.at(C).get("parameterValue"))==null||l.errors==null?null:l.errors.min),a(),s("ngIf",(r=y.processParamsFormArray.at(C).get("parameterValue"))==null||r.errors==null?null:r.errors.max)}}function Ge(n,d){if(n&1&&(i(0,"div",22)(1,"div",23),o(2,"Process Parameters"),t(),i(3,"div",98),p(4,je,11,11,"div",99),t()()),n&2){let e=m(2);a(4),s("ngForOf",e.processParameters)}}function Le(n,d){if(n&1&&(i(0,"div",90),o(1),t()),n&2){let e=m(2);a(),g(" ",e.error," ")}}function We(n,d){n&1&&(i(0,"span"),o(1,"Confirm Production"),t())}function He(n,d){n&1&&f(0,"span",104)}function Ye(n,d){if(n&1){let e=S();i(0,"div")(1,"div",22)(2,"div",23),o(3,"Operation Details"),t(),i(4,"div",24)(5,"div",25)(6,"span",26),o(7,"Operation"),t(),i(8,"span",27),o(9),t()(),i(10,"div",25)(11,"span",26),o(12,"Type"),t(),i(13,"span",27),o(14),t()(),i(15,"div",25)(16,"span",26),o(17,"Status"),t(),f(18,"app-status-badge",18),t(),i(19,"div",25)(20,"span",26),o(21,"Product"),t(),i(22,"span",27),o(23),t()(),i(24,"div",25)(25,"span",26),o(26,"Order Quantity"),t(),i(27,"span",27),o(28),t()(),i(29,"div",25)(30,"span",26),o(31,"Stage"),t(),i(32,"span",27),o(33),t()()()(),i(34,"form",28),v("ngSubmit",function(){x(e);let r=m();return h(r.onSubmit())}),i(35,"div",22)(36,"div",23),o(37,"Production Time"),t(),i(38,"div",29)(39,"div",30)(40,"div",31)(41,"label",32),o(42,"Start Time *"),t(),f(43,"input",33),p(44,ue,2,0,"div",34),t()(),i(45,"div",30)(46,"div",31)(47,"label",35),o(48,"End Time *"),t(),f(49,"input",36),t()()(),p(50,fe,2,0,"div",34),t(),i(51,"div",22)(52,"div",23),o(53,"Production Quantities"),t(),i(54,"div",29)(55,"div",30)(56,"div",31)(57,"label",37),o(58,"Quantity Produced *"),t(),f(59,"input",38),t()(),i(60,"div",30)(61,"div",31)(62,"label",39),o(63,"Quantity Scrapped"),t(),f(64,"input",40),t()()()(),i(65,"div",22)(66,"div",23),o(67,"Material Consumption"),t(),p(68,ve,31,5,"div",41),i(69,"div",42)(70,"h4"),o(71,"Available Inventory"),t(),p(72,he,15,1,"table",43)(73,Ce,2,0,"p",44),t(),p(74,Se,18,1,"div",45)(75,Pe,16,1,"div",46)(76,Te,3,2,"div",47),t(),i(77,"div",22)(78,"div",23),o(79,"Equipment & Operator"),t(),i(80,"div",29)(81,"div",30)(82,"div",31)(83,"label"),o(84,"Equipment * "),i(85,"span",48),o(86),t()(),i(87,"div",49),p(88,qe,5,3,"div",50)(89,we,2,0,"p",51),t()()(),i(90,"div",30)(91,"div",31)(92,"label"),o(93,"Operator * "),i(94,"span",48),o(95),t()(),i(96,"div",49),p(97,ke,5,3,"div",50)(98,Re,2,0,"p",51),t()()()()(),i(99,"div",22)(100,"div",23),o(101,"Delay Tracking"),t(),i(102,"div",29)(103,"div",30)(104,"div",31)(105,"label",52),o(106,"Delay Duration (minutes)"),t(),f(107,"input",53),t()(),i(108,"div",30)(109,"div",31)(110,"label",54),o(111," Delay Reason "),p(112,Ve,2,0,"span",55),t(),i(113,"select",56)(114,"option",57),o(115,"-- Select Reason --"),t(),p(116,Fe,2,2,"option",58),t(),p(117,Ne,2,0,"div",34),t()()()(),p(118,Ge,5,1,"div",7),i(119,"div",22)(120,"div",23),o(121,"Notes"),t(),i(122,"div",31),f(123,"textarea",59),t()(),p(124,Le,2,1,"div",60),i(125,"div",61)(126,"button",62),v("click",function(){x(e);let r=m();return h(r.goBack())}),o(127,"Cancel"),t(),i(128,"button",63),p(129,We,2,0,"span",6)(130,He,1,0,"span",64),t()()()()}if(n&2){let e,l,r=m();a(9),_("",r.operation.operationName," (",r.operation.operationCode,")"),a(5),u(r.operation.operationType),a(4),s("status",r.operation.status),a(5),_("",r.operation.order==null?null:r.operation.order.productName," (",r.operation.order==null?null:r.operation.order.productSku,")"),a(5),u(r.operation.order==null?null:r.operation.order.quantity),a(5),u(r.operation.process==null?null:r.operation.process.stageName),a(),s("formGroup",r.confirmForm),a(10),s("ngIf",(e=r.confirmForm.get("startTime"))==null||e.errors==null?null:e.errors.futureStartTime),a(6),s("ngIf",r.confirmForm.errors==null?null:r.confirmForm.errors.invalidTimeRange),a(18),s("ngIf",r.showSuggestions&&r.suggestedConsumption),a(4),s("ngIf",r.availableInventory.length>0),a(),s("ngIf",r.availableInventory.length===0),a(),s("ngIf",r.selectedMaterials.length>0),a(),s("ngIf",r.bomRequirements.length>0),a(),s("ngIf",r.bomValidationResult),a(10),g("(",r.getSelectedEquipmentCount()," selected)"),a(2),s("ngForOf",r.availableEquipment),a(),s("ngIf",r.availableEquipment.length===0),a(6),g("(",r.getSelectedOperatorCount()," selected)"),a(2),s("ngForOf",r.activeOperators),a(),s("ngIf",r.activeOperators.length===0),a(14),s("ngIf",r.isDelayReasonRequired()),a(4),s("ngForOf",r.delayReasons),a(),s("ngIf",r.isDelayReasonRequired()&&!((l=r.confirmForm.get("delayReason"))!=null&&l.value)),a(),s("ngIf",r.processParameters.length>0),a(6),s("ngIf",r.error),a(4),s("disabled",r.confirmForm.invalid||r.submitting),a(),s("ngIf",!r.submitting),a(),s("ngIf",r.submitting)}}function Ue(n,d){if(n&1&&(i(0,"div",22)(1,"p",80),o(2),t()()),n&2){let e=m();a(2),u(e.error||"Operation not found")}}var le=(()=>{class n{constructor(e,l,r,c){this.route=e,this.router=l,this.fb=r,this.apiService=c,this.operation=null,this.loading=!0,this.submitting=!1,this.success=!1,this.error="",this.availableInventory=[],this.availableEquipment=[],this.activeOperators=[],this.processParameters=[],this.delayReasons=[],this.selectedMaterials=[],this.confirmationResult=null,this.bomRequirements=[],this.bomValidationResult=null,this.showBomWarning=!1,this.suggestedConsumption=null,this.loadingSuggestions=!1,this.showSuggestions=!1}ngOnInit(){this.operationId=Number(this.route.snapshot.paramMap.get("operationId")),this.initForm(),this.loadData()}initForm(){let e=new Date,l=this.formatDateTimeLocal(e);this.confirmForm=this.fb.group({operationId:[this.operationId],startTime:[l,[b.required,this.startTimeValidator()]],endTime:[l,[b.required]],quantityProduced:[0,[b.required,b.min(1)]],quantityScrapped:[0,[b.min(0)]],delayMinutes:[0,[b.min(0)]],delayReason:[""],notes:[""],processParameters:this.fb.array([])},{validators:this.timeRangeValidator()})}startTimeValidator(){return e=>e.value&&new Date(e.value)>new Date?{futureStartTime:!0}:null}timeRangeValidator(){return e=>{let l=e.get("startTime")?.value,r=e.get("endTime")?.value;if(l&&r){let c=new Date(l);if(new Date(r)<=c)return{invalidTimeRange:!0}}return null}}formatDateTimeLocal(e){let l=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),c=String(e.getDate()).padStart(2,"0"),C=String(e.getHours()).padStart(2,"0"),y=String(e.getMinutes()).padStart(2,"0");return`${l}-${r}-${c}T${C}:${y}`}get processParamsFormArray(){return this.confirmForm.get("processParameters")}loadData(){this.loading=!0,this.apiService.getOperationDetails(this.operationId).subscribe({next:e=>{this.operation=e,this.loadMasterData()},error:e=>{console.error("Error loading operation:",e),this.error="Failed to load operation details",this.loading=!1}})}loadMasterData(){this.apiService.getAvailableEquipment().subscribe({next:e=>{this.availableEquipment=e.map(l=>({equipmentId:l.equipmentId,equipmentCode:l.equipmentCode,equipmentName:l.equipmentName,selected:!1}))},error:e=>console.error("Error loading equipment:",e)}),this.apiService.getActiveOperators().subscribe({next:e=>{this.activeOperators=e.map(l=>({operatorId:l.operatorId,operatorCode:l.operatorCode,operatorName:l.operatorName,selected:!1}))},error:e=>console.error("Error loading operators:",e)}),this.apiService.getDelayReasons().subscribe({next:e=>{this.delayReasons=e},error:e=>console.error("Error loading delay reasons:",e)}),this.apiService.getAvailableInventory().subscribe({next:e=>{this.availableInventory=e,this.loading=!1},error:e=>{console.error("Error loading inventory:",e),this.loading=!1}}),this.operation?.operationType&&this.apiService.getProcessParameters(this.operation.operationType,this.operation.order?.productSku).subscribe({next:e=>{this.processParameters=e,this.initProcessParams()},error:e=>console.error("Error loading process parameters:",e)}),this.operation?.order?.productSku&&this.apiService.getBomRequirements(this.operation.order.productSku).subscribe({next:e=>{this.bomRequirements=e.requirements||[]},error:e=>console.error("Error loading BOM requirements:",e)}),this.loadSuggestedConsumption()}loadSuggestedConsumption(){this.loadingSuggestions=!0,this.apiService.getSuggestedConsumption(this.operationId).subscribe({next:e=>{this.suggestedConsumption=e,this.loadingSuggestions=!1,this.showSuggestions=e.suggestedMaterials?.length>0,e.targetQuantity&&!this.confirmForm.get("quantityProduced")?.value&&this.confirmForm.patchValue({quantityProduced:e.targetQuantity})},error:e=>{console.error("Error loading suggested consumption:",e),this.loadingSuggestions=!1}})}applySuggestedConsumption(){if(this.suggestedConsumption){this.selectedMaterials=[];for(let e of this.suggestedConsumption.suggestedMaterials)for(let l of e.availableBatches)l.suggestedConsumption>0&&this.selectedMaterials.push({inventoryId:l.inventoryId,batchId:l.batchId||0,batchNumber:l.batchNumber||"",materialId:e.materialId,availableQuantity:l.availableQuantity,quantityToConsume:l.suggestedConsumption});this.validateBom()}}getTotalSuggestedQuantity(){return this.suggestedConsumption?this.suggestedConsumption.suggestedMaterials.reduce((e,l)=>e+l.requiredQuantity,0):0}hasSufficientStock(){return this.suggestedConsumption?this.suggestedConsumption.suggestedMaterials.every(e=>e.sufficientStock):!0}initProcessParams(){this.processParamsFormArray.clear(),this.processParameters.forEach(e=>{let l=[];e.is_required&&l.push(b.required),e.min_value!==null&&e.min_value!==void 0&&l.push(b.min(e.min_value)),e.max_value!==null&&e.max_value!==void 0&&l.push(b.max(e.max_value)),this.processParamsFormArray.push(this.fb.group({parameterName:[e.parameter_name],parameterValue:[e.default_value||"",l]}))})}addMaterial(e){this.selectedMaterials.find(r=>r.inventoryId===e.inventoryId)||(this.selectedMaterials.push({inventoryId:e.inventoryId,batchId:e.batchId,batchNumber:e.batchNumber,materialId:e.materialId,availableQuantity:e.quantity,quantityToConsume:0}),this.validateBom())}removeMaterial(e){this.selectedMaterials.splice(e,1)}updateMaterialQuantity(e,l){l>=0&&l<=this.selectedMaterials[e].availableQuantity&&(this.selectedMaterials[e].quantityToConsume=l,this.validateBom())}toggleEquipment(e){this.availableEquipment[e].selected=!this.availableEquipment[e].selected}getSelectedEquipmentIds(){return this.availableEquipment.filter(e=>e.selected).map(e=>e.equipmentId)}getSelectedEquipmentCount(){return this.availableEquipment.filter(e=>e.selected).length}toggleOperator(e){this.activeOperators[e].selected=!this.activeOperators[e].selected}getSelectedOperatorIds(){return this.activeOperators.filter(e=>e.selected).map(e=>e.operatorId)}getSelectedOperatorCount(){return this.activeOperators.filter(e=>e.selected).length}isDelayReasonRequired(){let e=this.confirmForm.get("delayMinutes")?.value;return e&&e>0}validateBom(){if(!this.operation?.order?.productSku||this.selectedMaterials.length===0){this.bomValidationResult=null;return}let e={productSku:this.operation.order.productSku,targetQuantity:this.confirmForm.get("quantityProduced")?.value||0,materialsConsumed:this.selectedMaterials.filter(l=>l.quantityToConsume>0).map(l=>({materialId:l.materialId,quantity:l.quantityToConsume}))};this.apiService.validateBomConsumption(e).subscribe({next:l=>{this.bomValidationResult=l,this.showBomWarning=l.warnings?.length>0||l.errors?.length>0},error:l=>console.error("Error validating BOM:",l)})}getTotalSelectedByMaterial(e){return this.selectedMaterials.filter(l=>l.materialId===e).reduce((l,r)=>l+r.quantityToConsume,0)}getRequirementStatus(e){let l=this.getTotalSelectedByMaterial(e.materialId);return l>=e.quantityRequired?"met":l>0?"partial":"missing"}onSubmit(){if(this.confirmForm.invalid){this.error="Please fill in all required fields correctly.";return}if(this.getSelectedEquipmentCount()===0){this.error="Please select at least one equipment.";return}if(this.getSelectedOperatorCount()===0){this.error="Please select at least one operator.";return}let e=this.confirmForm.value;if(e.delayMinutes>0&&!e.delayReason){this.error="Please select a delay reason when delay duration is greater than 0.";return}this.submitting=!0,this.error="";let l={operationId:this.operationId,producedQty:e.quantityProduced,scrapQty:e.quantityScrapped||0,startTime:new Date(e.startTime).toISOString(),endTime:new Date(e.endTime).toISOString(),equipmentIds:this.getSelectedEquipmentIds(),operatorIds:this.getSelectedOperatorIds(),materialsConsumed:this.selectedMaterials.filter(r=>r.quantityToConsume>0).map(r=>({batchId:r.batchId,inventoryId:r.inventoryId,quantity:r.quantityToConsume})),processParameters:e.processParameters.filter(r=>r.parameterValue).reduce((r,c)=>(r[c.parameterName]=c.parameterValue,r),{}),delayMinutes:e.delayMinutes||0,delayReason:e.delayReason||null,notes:e.notes};this.apiService.confirmProduction(l).subscribe({next:r=>{this.confirmationResult=r,this.success=!0,this.submitting=!1},error:r=>{console.error("Error confirming production:",r),this.error=r.error?.message||"Failed to confirm production",this.submitting=!1}})}goBack(){this.operation?.order?.orderId?this.router.navigate(["/orders",this.operation.order.orderId]):this.router.navigate(["/orders"])}goToBatch(e){this.router.navigate(["/batches",e])}static{this.\u0275fac=function(l){return new(l||n)(P(Q),P(A),P(ee),P(te))}}static{this.\u0275cmp=q({type:n,selectors:[["app-production-confirm"]],decls:11,vars:4,consts:[[1,"container"],[1,"page-header"],[1,"btn","btn-secondary",3,"click"],[1,"page-title"],["class","text-center",4,"ngIf"],["class","success-container",4,"ngIf"],[4,"ngIf"],["class","card",4,"ngIf"],[1,"text-center"],["message","Loading operation details..."],[1,"success-container"],[1,"card","success-card"],[1,"success-icon"],[1,"result-summary"],[1,"result-row"],[1,"result-label"],[1,"result-value"],["class","result-row",4,"ngIf"],[3,"status"],[1,"success-actions"],[1,"btn","btn-primary",3,"click"],["class","btn btn-secondary",3,"click",4,"ngIf"],[1,"card"],[1,"card-header"],[1,"operation-info-grid"],[1,"info-item"],[1,"info-label"],[1,"info-value"],[3,"ngSubmit","formGroup"],[1,"row"],[1,"col-6"],[1,"form-group"],["for","startTime"],["type","datetime-local","id","startTime","formControlName","startTime",1,"form-control"],["class","field-error",4,"ngIf"],["for","endTime"],["type","datetime-local","id","endTime","formControlName","endTime",1,"form-control"],["for","quantityProduced"],["type","number","id","quantityProduced","formControlName","quantityProduced","min","0",1,"form-control"],["for","quantityScrapped"],["type","number","id","quantityScrapped","formControlName","quantityScrapped","min","0",1,"form-control"],["class","suggested-consumption",4,"ngIf"],[1,"available-materials"],["class","table",4,"ngIf"],["class","no-data",4,"ngIf"],["class","selected-materials",4,"ngIf"],["class","bom-requirements",4,"ngIf"],["class","bom-validation",4,"ngIf"],[1,"selection-count"],[1,"checkbox-group"],["class","checkbox-item",4,"ngFor","ngForOf"],["class","no-data-small",4,"ngIf"],["for","delayMinutes"],["type","number","id","delayMinutes","formControlName","delayMinutes","min","0","placeholder","0",1,"form-control"],["for","delayReason"],["class","required",4,"ngIf"],["id","delayReason","formControlName","delayReason",1,"form-control"],["value",""],[3,"value",4,"ngFor","ngForOf"],["id","notes","formControlName","notes","rows","3","placeholder","Add any notes about this production confirmation...",1,"form-control"],["class","alert alert-error",4,"ngIf"],[1,"form-actions"],["type","button",1,"btn","btn-secondary",3,"click"],["type","submit",1,"btn","btn-success",3,"disabled"],["class","spinner",4,"ngIf"],[1,"field-error"],[1,"suggested-consumption"],[1,"suggestion-header"],["type","button",1,"btn","btn-primary","btn-sm",3,"click","disabled"],[1,"suggestion-info"],[1,"suggestion-label"],[1,"suggestion-value"],[1,"table","suggestion-table"],[3,"insufficient",4,"ngFor","ngForOf"],["class","alert alert-warning",4,"ngIf"],[1,"stock-status"],[1,"alert","alert-warning"],[1,"table"],[4,"ngFor","ngForOf"],["type","button",1,"btn","btn-primary","btn-sm",3,"click"],[1,"no-data"],[1,"selected-materials"],["type","number",1,"form-control","consume-qty",3,"change","value","min","max"],["type","button",1,"btn","btn-danger","btn-sm",3,"click"],[1,"bom-requirements"],[1,"table","bom-table"],[3,"ngClass",4,"ngFor","ngForOf"],[3,"ngClass"],[1,"bom-status",3,"ngClass"],[1,"bom-validation"],[1,"alert","alert-error"],[1,"checkbox-item"],[1,"checkbox-label"],["type","checkbox",3,"change","checked"],[1,"checkbox-text"],[1,"no-data-small"],[1,"required"],[3,"value"],["formArrayName","processParameters"],["class","form-group",4,"ngFor","ngForOf"],[3,"formGroupName"],["class","param-hint",4,"ngIf"],["type","number","formControlName","parameterValue","step","any",1,"form-control",3,"placeholder"],[1,"param-hint"],[1,"spinner"]],template:function(l,r){l&1&&(f(0,"app-header"),i(1,"div",0)(2,"div",1)(3,"button",2),v("click",function(){return r.goBack()}),o(4,"\u2190 Back to Order"),t(),i(5,"h1",3),o(6,"Production Confirmation"),t()(),p(7,de,2,0,"div",4)(8,pe,31,6,"div",5)(9,Ye,131,31,"div",6)(10,Ue,3,1,"div",7),t()),l&2&&(a(7),s("ngIf",r.loading),a(),s("ngIf",r.success&&r.confirmationResult),a(),s("ngIf",!r.loading&&!r.success&&r.operation),a(),s("ngIf",!r.loading&&!r.operation&&!r.success))},dependencies:[V,F,N,G,K,X,$,L,J,z,j,Z,W,U,H,Y,ie,ne,oe,B],styles:[".page-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:24px;margin-bottom:24px}.operation-info-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}.info-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:4px}.info-label[_ngcontent-%COMP%]{font-size:12px;color:#888;text-transform:uppercase}.info-value[_ngcontent-%COMP%]{font-size:14px;font-weight:500}.available-materials[_ngcontent-%COMP%]{margin-bottom:24px}.available-materials[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%], .selected-materials[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{font-size:14px;font-weight:500;margin-bottom:12px;color:#555}.consume-qty[_ngcontent-%COMP%]{width:100px;padding:6px 8px}.btn-sm[_ngcontent-%COMP%]{padding:6px 12px;font-size:13px}.form-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:12px;margin-top:24px;margin-bottom:40px}.no-data[_ngcontent-%COMP%]{color:#888;text-align:center;padding:20px}.required[_ngcontent-%COMP%]{color:#d32f2f}.param-hint[_ngcontent-%COMP%]{font-size:12px;color:#888;font-weight:400}.success-container[_ngcontent-%COMP%]{display:flex;justify-content:center;padding:40px 0}.success-card[_ngcontent-%COMP%]{text-align:center;max-width:500px;width:100%}.success-icon[_ngcontent-%COMP%]{width:80px;height:80px;border-radius:50%;background:#4caf50;color:#fff;font-size:40px;display:flex;align-items:center;justify-content:center;margin:0 auto 24px}.success-card[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{color:#2e7d32;margin-bottom:24px}.result-summary[_ngcontent-%COMP%]{background:#f5f5f5;border-radius:8px;padding:20px;margin-bottom:24px}.result-row[_ngcontent-%COMP%]{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee}.result-row[_ngcontent-%COMP%]:last-child{border-bottom:none}.result-label[_ngcontent-%COMP%]{color:#666}.result-value[_ngcontent-%COMP%]{font-weight:500}.success-actions[_ngcontent-%COMP%]{display:flex;gap:12px;justify-content:center}.spinner[_ngcontent-%COMP%]{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:_ngcontent-%COMP%_spin 1s linear infinite}@keyframes _ngcontent-%COMP%_spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.bom-requirements[_ngcontent-%COMP%]{margin-top:24px;padding-top:24px;border-top:1px solid #e0e0e0}.bom-requirements[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{font-size:14px;font-weight:500;margin-bottom:12px;color:#555}.bom-table[_ngcontent-%COMP%]   tr.bom-met[_ngcontent-%COMP%]{background-color:#e8f5e9}.bom-table[_ngcontent-%COMP%]   tr.bom-partial[_ngcontent-%COMP%]{background-color:#fff3e0}.bom-table[_ngcontent-%COMP%]   tr.bom-missing[_ngcontent-%COMP%]{background-color:#ffebee}.bom-status[_ngcontent-%COMP%]{padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500}.bom-status.met[_ngcontent-%COMP%]{background-color:#4caf50;color:#fff}.bom-status.partial[_ngcontent-%COMP%]{background-color:#ff9800;color:#fff}.bom-status.missing[_ngcontent-%COMP%]{background-color:#f44336;color:#fff}.bom-validation[_ngcontent-%COMP%]{margin-top:16px}.bom-validation[_ngcontent-%COMP%]   .alert[_ngcontent-%COMP%]   ul[_ngcontent-%COMP%]{margin:8px 0 0 20px;padding:0}.alert-warning[_ngcontent-%COMP%]{background-color:#fff3e0;color:#e65100;border:1px solid #ffcc80;padding:12px 16px;border-radius:4px;margin-bottom:12px}.checkbox-group[_ngcontent-%COMP%]{max-height:200px;overflow-y:auto;border:1px solid #e0e0e0;border-radius:4px;padding:12px;background:#fafafa}.checkbox-item[_ngcontent-%COMP%]{margin-bottom:8px}.checkbox-item[_ngcontent-%COMP%]:last-child{margin-bottom:0}.checkbox-label[_ngcontent-%COMP%]{display:flex;align-items:center;cursor:pointer;padding:6px 8px;border-radius:4px;transition:background-color .2s}.checkbox-label[_ngcontent-%COMP%]:hover{background-color:#e3f2fd}.checkbox-label[_ngcontent-%COMP%]   input[type=checkbox][_ngcontent-%COMP%]{margin-right:10px;width:18px;height:18px;cursor:pointer}.checkbox-text[_ngcontent-%COMP%]{font-size:14px;color:#333}.selection-count[_ngcontent-%COMP%]{font-size:12px;color:#666;font-weight:400}.no-data-small[_ngcontent-%COMP%]{color:#888;font-size:13px;margin:0}.field-error[_ngcontent-%COMP%]{color:#d32f2f;font-size:12px;margin-top:4px}input[type=datetime-local][_ngcontent-%COMP%]{padding:8px 12px}.suggested-consumption[_ngcontent-%COMP%]{background:#e3f2fd;border:1px solid #90caf9;border-radius:8px;padding:16px;margin-bottom:24px}.suggestion-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}.suggestion-header[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin:0;color:#1565c0;font-size:14px}.suggestion-info[_ngcontent-%COMP%]{display:flex;gap:16px;margin-bottom:12px;font-size:14px}.suggestion-label[_ngcontent-%COMP%]{color:#666}.suggestion-value[_ngcontent-%COMP%]{font-weight:600;color:#1565c0}.suggestion-table[_ngcontent-%COMP%]{background:#fff;margin-bottom:12px}.suggestion-table[_ngcontent-%COMP%]   tr.insufficient[_ngcontent-%COMP%]{background-color:#ffebee}.stock-status[_ngcontent-%COMP%]{padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500}.stock-status.ok[_ngcontent-%COMP%]{background-color:#4caf50;color:#fff}.stock-status.low[_ngcontent-%COMP%]{background-color:#f44336;color:#fff}@media (max-width: 768px){.operation-info-grid[_ngcontent-%COMP%]{grid-template-columns:repeat(2,1fr)}.row[_ngcontent-%COMP%]{flex-direction:column}.col-6[_ngcontent-%COMP%]{flex:0 0 100%;max-width:100%}.checkbox-group[_ngcontent-%COMP%]{max-height:150px}}"]})}}return n})();var Je=[{path:"confirm/:operationId",component:le}],se=(()=>{class n{static{this.\u0275fac=function(l){return new(l||n)}}static{this.\u0275mod=I({type:n})}static{this.\u0275inj=E({imports:[T.forChild(Je),T]})}}return n})();var ft=(()=>{class n{static{this.\u0275fac=function(l){return new(l||n)}}static{this.\u0275mod=I({type:n})}static{this.\u0275inj=E({imports:[D,se,re]})}}return n})();export{ft as ProductionModule};
